<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemist's Grand Grimoire</title>
    <style>
        #startFlight {
            background: linear-gradient(135deg, #7c3aed, #9333ea);
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 28px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.6);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 99999;
            margin: 20px auto;
            display: block;
        }

        #startFlight:hover {
            transform: scale(1.08);
            box-shadow: 0 0 25px rgba(167, 139, 250, 0.9);
        }

        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: 9998;
            display: none;
            pointer-events: none;
        }

        .wizard-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .wizard-spotlight {
            position: absolute;
            border: 3px solid #ffb347;
            border-radius: 15px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2) 0 0 30px rgba(255, 179, 71, 0.6),
                inset 0 0 30px rgba(255, 179, 71, 0.3);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }



        .wizard-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: none;
            animation: slideInRight 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .missed-btn {
            background-color: #e74c3c;
            color: #fff;
            border: none;
            padding: 6px 12px;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.2s;
        }

        .missed-btn:hover {
            background-color: #c0392b;
        }

        .wizard-container.active {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(500px) scale(0.5);
                opacity: 0;
            }

            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .wizard-character {
            position: relative;
            margin-bottom: 20px;
        }

        .wizard-avatar {
            font-size: 120px;
            text-align: center;
            filter: drop-shadow(0 10px 25px rgba(255, 179, 71, 0.5));
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .wizard-avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        @keyframes wizardFloat {

            0%,
            100% {
                transform: translateY(0px) rotate(-3deg);
            }

            50% {
                transform: translateY(-20px) rotate(3deg);
            }
        }

        @keyframes wizardEntrance {
            0% {
                transform: translateY(100px) scale(0) rotate(180deg);
                opacity: 0;
            }

            100% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .wizard-sparkles {
            display: none;
            position: absolute;
            top: -20px;
            right: -10px;
            font-size: 30px;
            animation: sparkleRotate 4s linear infinite;
        }

        @keyframes sparkleRotate {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }

            50% {
                transform: rotate(180deg) scale(1.3);
                opacity: 0.6;
            }

            100% {
                transform: rotate(360deg) scale(1);
                opacity: 1;
            }
        }

        .wizard-dialogue {
            background: linear-gradient(135deg, rgba(74, 28, 64, 0.98), rgba(45, 27, 61, 0.98));
            border: 3px solid #ffb347;
            border-radius: 20px;
            padding: 15px;
            max-width: 350px;
            margin: 0 auto;
            position: relative;
            text-align: center;
            box-shadow:
                0 15px 35px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(255, 179, 71, 0.3),
                inset 0 0 60px rgba(255, 179, 71, 0.1);
            animation: dialogueBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s backwards;
        }

        @keyframes dialogueBounce {
            0% {
                transform: scale(0) translateY(50px);
                opacity: 0;
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .dialogue-content {
            position: relative;
            z-index: 1;
        }

        .dialogue-title {
            color: #ffb347;
            font-size: 0.7rem !important;
            margin-bottom: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dialogue-text {
            color: #f4e4c1;
            font-size: 0.7rem !important;
            line-height: 1.6;
            font-family: 'Georgia', serif;
        }

        .dialogue-arrow {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 20px solid #ffb347;
        }

        .dialogue-arrow::after {
            content: '';
            position: absolute;
            top: 3px;
            left: -17px;
            width: 0;
            height: 0;
            border-left: 17px solid transparent;
            border-right: 17px solid transparent;
            border-bottom: 17px solid rgba(74, 28, 64, 0.98);
        }

        .wizard-controls {
            margin-top: 20px;
        }

        .wizard-progress {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .progress-text {
            color: #ffb347;
            font-weight: bold;
            font-size: 0.95rem;
            display: block;
            margin-bottom: 8px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 179, 71, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffb347, #ffd700);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
            box-shadow: 0 0 10px rgba(255, 179, 71, 0.6);
        }

        #flyingWitch {
            position: absolute;
            ;
            top: 350px;
            left: 50px;
            width: 80px;
            z-index: 9999;
            pointer-events: none;
            transform: translateX(0);
            opacity: 0;
        }

        #flyingWitch img {
            width: 100px;
            height: auto;
        }

        /* ‚ú® Flight animation */
        #flyingWitch.fly {
            animation: flyAcross 4s linear forwards;
            opacity: 1;
        }

        @keyframes flyAcross {
            0% {
                transform: translate(0, 0) rotate(-10deg);
                opacity: 1;
            }

            30% {
                transform: translate(300px, -100px) rotate(-5deg);
            }

            60% {
                transform: translate(600px, -250px) rotate(0deg);
            }

            100% {
                transform: translate(120vw, -20vh) rotate(10deg);
                opacity: 0.9;
            }
        }


        /* Star overlay covers screen while witch flies */
        #starOverlay {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 9998;
            /* below flying witch (9999) so witch appears on top */
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        /* Individual star */
        #starOverlay .star {
            position: absolute;
            width: var(--s, 2px);
            height: var(--s, 2px);
            border-radius: 50%;
            background: radial-gradient(circle, #ffffff 0%, #ffd700 60%, rgba(255, 200, 0, 0) 100%);
            box-shadow: 0 0 calc(var(--s, 2px) * 6) rgba(255, 200, 80, 0.9);
            transform-origin: center;
            opacity: 0;
            animation: starTwinkle var(--d, 2.8s) ease-in-out infinite;
        }

        /* Twinkle animation (randomized per star by --d) */
        @keyframes starTwinkle {
            0% {
                opacity: 0;
                transform: scale(0.6);
            }

            40% {
                opacity: 1;
                transform: scale(1.0);
            }

            80% {
                opacity: 0.6;
                transform: scale(0.9);
            }

            100% {
                opacity: 0;
                transform: scale(0.6);
            }
        }


        @keyframes fall {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(80vh) scale(0.2);
                opacity: 0;
            }
        }

        .wizard-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .wizard-btn {
            padding: 12px 24px;
            border: 2px solid #ffb347;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(255, 179, 71, 0.2), rgba(255, 107, 107, 0.2));
            color: #ffb347;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wizard-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffb347, #ff6b6b);
            color: #2d1b3d;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 179, 71, 0.4);
        }

        .wizard-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .wizard-btn-skip {
            background: rgba(255, 71, 87, 0.3);
            border-color: #ff4757;
            color: #ff6b6b;
        }

        .wizard-btn-skip:hover {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
        }

        .restart-wizard-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ffb347, #ff6b6b);
            border: 3px solid #ffd700;
            border-radius: 15px;
            color: #2d1b3d;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        .restart-wizard-btn:hover {
            transform: scale(1.1) rotate(-2deg);
            box-shadow: 0 10px 30px rgba(255, 179, 71, 0.6);
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 5px 20px rgba(255, 179, 71, 0.4);
            }

            50% {
                box-shadow: 0 5px 35px rgba(255, 179, 71, 0.8);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .wizard-container {
                bottom: 20px;
                right: 20px;
                left: 20px;
            }

            .wizard-dialogue {
                max-width: 100%;
            }

            .wizard-avatar {
                font-size: 80px;
            }

            .wizard-buttons {
                flex-wrap: wrap;
            }

            .wizard-btn {
                flex: 1;
                min-width: 100px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #4a1c40 0%, #2d1b3d 50%, #1a0f2e 100%);
            color: #f4e4c1;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 70%, rgba(255, 105, 180, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
            border-radius: 20px;
            border: 2px dashed #ffb347;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 20px;
            font-size: 24px;
            animation: sparkle 2s infinite;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -10px;
            right: 20px;
            font-size: 24px;
            animation: sparkle 2s infinite 1s;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .header h1 {
            font-size: 3rem;
            color: #ffb347;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            font-style: italic;
            color: #e6d3a3;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 5px;
        }

        .nav-tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: #f4e4c1;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            margin: 0 5px;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #ffb347, #ff6b6b);
            color: #2d1b3d;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 179, 71, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 179, 71, 0.2);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 179, 71, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 179, 71, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffb347;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 179, 71, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #f4e4c1;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ffb347;
            box-shadow: 0 0 10px rgba(255, 179, 71, 0.3);
        }

        .btn {
            padding: 5px 5px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ffb347);
            color: #2d1b3d;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .medicine-list {
            display: grid;
            gap: 20px;
        }

        .medicine-item {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #ffb347;
            position: relative;
            transition: all 0.3s ease;
        }

        .medicine-item:hover {
            background: rgba(0, 0, 0, 0.8);
            border-left-color: #ff6b6b;
        }

        .medicine-item h3 {
            color: #ffb347;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .medicine-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: rgba(255, 179, 71, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #ffb347;
            font-weight: bold;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }


        .stat-card {
            background: linear-gradient(135deg, rgba(255, 179, 71, 0.1), rgba(255, 107, 107, 0.1));
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 179, 71, 0.3);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: #ffb347;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #e6d3a3;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .chart {
            width: 100%;
            height: 300px;
            background: rgba(255, 179, 71, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ffb347;
        }

        .upcoming-doses {
            max-height: 400px;
            overflow-y: auto;
        }

        .dose-item {
            background: rgba(255, 179, 71, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ffb347;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dose-time {
            font-weight: bold;
            color: #ffb347;
        }

        .dose-medicine {
            color: #e6d3a3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffb347);
            color: #2d1b3d;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.8s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.fade-out {
            opacity: 0;
        }


        .mystic-fortune {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(255, 105, 180, 0.2));
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .fortune-text {
            font-size: 1.3rem;
            font-style: italic;
            color: #e6d3a3;
            margin-bottom: 15px;
        }

        .fortune-crystal {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .wellness-rate {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .wellness-excellent {
            color: #4ecdc4;
        }

        .wellness-good {
            color: #45b7d1;
        }

        .wellness-fair {
            color: #f9ca24;
        }

        .wellness-poor {
            color: #f0932b;
        }

        .wellness-critical {
            color: #eb4d4b;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé™ Alchemist's Grand Grimoire üé™</h1>
            <div id="wizardOverlay" class="wizard-overlay">
                <div class="wizard-spotlight"></div>
            </div>
            <!-- üßô‚Äç‚ôÄÔ∏è Flying Witch -->
            <div id="flyingWitch">
                <img src="18fe33bb-e7da-451a-ac22-5c3ee5bfdd63.png" alt="Flying Witch">
            </div>

            <!-- ‚ú® Sparkle Container -->
            <div id="starOverlay"></div>


            <audio id="witchSound" src="witch-sound.mp3" preload="auto"></audio>

            <div id="wizardContainer" class="wizard-container">
                <!-- Wizard Character -->
                <div class="wizard-character">
                    <div id="witchAvatar" class="wizard-avatar">
                        <img src="witch.png" alt="Witch Guide" style="max-width:180px; height:auto;">
                    </div>
                    <div class="wizard-sparkles">‚ú®</div>
                </div>

                <!-- Dialogue Bubble -->
                <div class="wizard-dialogue">
                    <div class="dialogue-content">
                        <h3 class="dialogue-title">Welcome, Apprentice!</h3>
                        <p class="dialogue-text">Greetings! I am Merlin the Alchemist, your guide through this mystical
                            grimoire. Shall I show you the secrets of this ancient medicine vault?</p>
                    </div>
                    <div class="dialogue-arrow"></div>
                </div>

                <!-- Progress & Controls -->
                <div class="wizard-controls">
                    <div class="wizard-progress">
                        <span class="progress-text">Step <span id="currentStep">1</span> of <span
                                id="totalSteps">6</span></span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-skip" onclick="skipTutorial()">Skip Tour</button>
                        <button class="wizard-btn wizard-btn-prev" onclick="previousStep()" disabled>Previous</button>
                        <button class="wizard-btn wizard-btn-next" onclick="nextStep()">Next</button>
                    </div>
                </div>
            </div>
            <!-- Restart Tutorial Button (appears after completion) -->
            <button id="restartWizard" class="restart-wizard-btn" onclick="startWizard()" style="display: none;">
                üé™ Start Guide Tour
            </button>
            <p>Where Circus Magic Meets Medicine Mastery</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('schedule')">üìã Schedule Potions</button>
            <button class="nav-tab" onclick="switchTab('userDashboard')">üìÖ User Dashboard</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">üìä Wellness Dashboard</button>
            <button class="nav-tab" onclick="switchTab('streakTab')">üî• Streak</button>

            <div id="clock" style="
              position: fixed;
              top: 20px;
              right: 20px;
              background:black;
              padding: 10px 20px;
              border-radius: 15px;
              font-size: 1.2rem;
              color: #ffb347;
              font-weight: bold;
              box-shadow: 0 5px 15px rgba(3, 3, 3, 0.3);
              z-index: 1000;
              "></div>
        </div>
        <button id="startFlight">ü™Ñ Start Witch Flight</button>

        <div id="schedule" class="tab-content active">
            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">üß™ Brew New Elixir Schedule</h2>
                <form id="medicineForm">
                    <div class="form-group">
                        <label for="medicineName">üß¥ Potion Name:</label>
                        <input type="text" id="medicineName" required placeholder="e.g., flyingpotion">
                    </div>
                    <div class="form-group">
                        <label for="email">üìß User Email:</label>
                        <input type="email" id="email" required placeholder="e.g., user@example.com">
                    </div>

                    <div class="form-group">
                        <label for="dosage">üìè Dosage:</label>
                        <input type="text" id="dosage" required placeholder="e.g., 500 mg">
                    </div>

                    <div class="form-group">
                        <label for="time">‚è∞ First Dose Time:</label>
                        <input type="time" id="time" required>
                    </div>

                    <div class="form-group">
                        <label for="frequency">üìÖ Frequency:</label>
                        <select id="frequency" required>
                            <option value="">Select frequency</option>
                            <option value="onceDaily">Once a day</option>
                            <option value="twiceDaily">Twice a day (every 12 hrs)</option>
                            <option value="every8h">Every 8 hours</option>
                            <option value="everyOtherDay">Every other day</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="duration">üóìÔ∏è Duration:</label>
                        <input type="number" id="duration" required min="1" max="365" placeholder="e.g., 7 days">
                    </div>

                    <button type="submit" class="btn btn-primary">‚ûï Add Medication</button>
                </form>

            </div>

            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">üìú Current Elixir Schedules</h2>
                <div id="medicineList" class="medicine-list"></div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="mystic-fortune">
                <div class="fortune-crystal">üîÆ</div>
                <div class="wellness-rate" id="wellnessRate">Calculating Wellness Rate...</div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMedicines">0</div>
                    <div class="stat-label">Active Elixirs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDosesToday">0</div>
                    <div class="stat-label">Total Doses Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="takenToday">0</div>
                    <div class="stat-label">Taken Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="missedToday">0</div>
                    <div class="stat-label">Missed Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adherenceRate">0%</div>
                    <div class="stat-label">Adherence Rate</div>
                </div>
            </div>


            <div class="card" id="predictionCard" style="margin-bottom:20px;">
                <h3 style="color: #ffb347; margin-bottom: 12px;">ü§ñ Adherence Predictions & Risk</h3>
                <div id="predictionPanel">
                    <p style="color:#e6d3a3;">Analyzing adherence patterns...</p>
                </div>
            </div>
            <!-- Enhanced Dashboard Controls -->
            <div class="card" id="enhancedControls" style="margin-bottom:20px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <label style="color:#e6d3a3;">Range:
                        <select id="edRangeSelect">
                            <option value="7">Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="custom">Custom</option>
                        </select>
                    </label>

                    <label id="customRangeInputs" style="display:none; color:#e6d3a3;">
                        From: <input type="date" id="edFrom"> To: <input type="date" id="edTo">
                    </label>

                    <label style="color:#e6d3a3;">Medicine:
                        <select id="edMedicineFilter">
                            <option value="">All</option>
                        </select>
                    </label>

                    <button class="btn btn-primary" id="edApplyBtn">Apply</button>
                    <button class="btn" id="edRefreshBtn">Refresh</button>
                    <button class="btn btn-danger" id="edExportBtn">Export CSV</button>
                </div>
            </div>

            <!-- Missed Dose History table -->
            <div class="card" id="missedHistoryCard" style="margin-bottom:20px;">
                <h3 style="color:#ffb347; margin-bottom:10px;">üóÇ Missed Dose History</h3>
                <div style="overflow:auto; max-height:260px;">
                    <table id="edHistoryTable" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom:1px solid rgba(255,179,71,0.2);">
                                <th style="padding:8px;">Date</th>
                                <th style="padding:8px;">Medicine</th>
                                <th style="padding:8px;">Status</th>
                                <th style="padding:8px;">Logged At</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>


            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìà Adherence Trends Over Time</h3>
                <canvas id="adherenceChartMain"></canvas>

            </div>

            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìä Missed vs Taken Doses</h3>
                <canvas id="missedVsTakenChart"
                    style="max-width: 250px; max-height: 250px; margin: 0 auto; display: block;"></canvas>

            </div>

            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìâ Adherence Progress Over 30 Days</h3>
                <canvas id="trendLineChart"></canvas>
            </div>


            <div class="card">
                <h3 style="color: #ffb347; margin-bottom: 15px;">‚è∞ Upcoming Performances</h3>
                <div id="upcomingDoses" class="upcoming-doses"></div>
            </div>

        </div>


        <div id="userDashboard" class="tab-content">
            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">üìÖ Upcoming Reminders</h2>
                <div id="upcomingRemindersList"></div>
            </div>

            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">üìú Past Reminders</h2>
                <button class="btn btn-danger" onclick="clearPastReminders()">üóëÔ∏è Clear All Past Reminders</button>
                <div id="pastRemindersList" style="margin-top: 15px;"></div>
            </div>

        </div>
        <!-- üî• Streak Dashboard Tab -->
        <div id="streakTab" class="tab-content">
            <div class="card">
                <h2 style="color:#ffb347; margin-bottom:20px;">üî• Streak Performance</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="currentStreak">0 days</div>
                        <div class="stat-label">Current Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="longestStreak">0 days</div>
                        <div class="stat-label">Longest Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDaysTracked">0</div>
                        <div class="stat-label">Total Days Tracked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="perfectDays">0</div>
                        <div class="stat-label">Perfect Adherence Days</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="color: #ffb347; margin-bottom: 15px;">üìÖ Streak Trend Over Time</h3>
                    <canvas id="streakTrendChart"></canvas>
                </div>
            </div>
        </div>

        <div id="notification" class="notification">
            <span id="notificationText"></span>
            <button id="snoozeBtn"
                style="display:none; margin-left:10px; padding:5px 10px; border:none; border-radius:5px; background:#4ecdc4; color:#fff; cursor:pointer;">
                Snooze 15 min
            </button>
        </div>
        <script>
            // ‚úÖ Global fallback email (replace with your own)
            const DEFAULT_EMAIL = "thakur29aayush@example.com";

            // ‚úÖ Master email variable (always used throughout the app)
            function getUserEmail() {
                return (document.getElementById("email")?.value || "").trim() || DEFAULT_EMAIL;
            }


            let medicines = JSON.parse(localStorage.getItem('medicines') || '[]');
            let doseLogs = JSON.parse(localStorage.getItem('doseLogs') || '[]');
            let currentEditingId = null;
            let notificationTimeout;

            const crierAnnouncements = [
                "üé™ Attention performers! Remember your morning strength elixir before the aerial acts!",
                "üé≠ The show starts in 30 minutes - time for your pre-performance potions!",
                "‚ö° Energy levels looking optimal today thanks to consistent elixir adherence!",
                "üåü Outstanding wellness performance this week! The audience applauds your dedication!",
                "üé™ New safety protocol: Double-check your elixir schedule before entering the ring!",
                "üé® The Alchemist has brewed fresh batches - your supply is ready for pickup!"
            ];

            document.addEventListener('DOMContentLoaded', function () {
                renderMedicines();
                updateDashboard();
                setupNotifications();
                generateRandomCrierAnnouncement();
                updateStreakDisplay();
            });

            function switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');

                if (tabName === 'dashboard') updateDashboard();
                if (tabName === 'userDashboard') renderUserDashboard();
                if (tabName === 'streakTab') updateStreakDisplay(); // ‚úÖ load streak page
            }


            function renderMedicines() {
                const container = document.getElementById('medicineList');

                if (medicines.length === 0) {
                    container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e6d3a3;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìú</div>
                        <p>No elixirs in your Grimoire yet. Add your first magical formula above!</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = medicines.map(medicine => `
                <div class="medicine-item">
                    <h3>üß™ ${medicine.name}</h3>
                    <div class="medicine-details">
                        <div class="detail-item">
                            <span class="detail-label">Dosage:</span> ${medicine.dosage}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Time:</span> ${formatTime(medicine.time)}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Frequency:</span> ${medicine.frequency}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="editMedicine('${medicine.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteMedicine('${medicine.id}')">üóëÔ∏è Remove</button>
                        <button class="btn btn-primary" onclick="markAsTaken('${medicine.id}')">‚úÖ Mark Taken</button>
                        <button class="missed-btn" onclick="markAsMissed('${medicine.id}')">‚ùå Mark as Missed</button>
                    </div>
                </div>
            `).join('');
            }

            function formatTime(time24) {
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12;
                return `${displayHour}:${minutes} ${ampm}`;
            }

            function editMedicine(id) {
                const medicine = medicines.find(med => med.id === id);
                if (medicine) {
                    document.getElementById('medicineName').value = medicine.name;
                    document.getElementById('dosage').value = medicine.dosage;
                    document.getElementById('time').value = medicine.time;
                    document.getElementById('frequency').value = medicine.frequency;
                    currentEditingId = id;
                    switchTab('schedule');
                    showNotification('üìù Ready to edit elixir formula');
                }
            }

            function deleteMedicine(id) {
                if (confirm('Are you sure you want to remove this elixir from your Grimoire?')) {
                    medicines = medicines.filter(med => med.id !== id);
                    localStorage.setItem('medicines', JSON.stringify(medicines));
                    renderMedicines();
                    updateDashboard();
                    showNotification('üóëÔ∏è Elixir removed from Grimoire');
                }
            }

            async function markAsTaken(id) {
                const medicine = medicines.find(m => m.id === id);
                if (!medicine) return;

                const today = new Date().toDateString();

                // ‚úÖ Prevent double marking (taken or missed)
                const alreadyLoggedToday = doseLogs.some(
                    l => l.medicineId === id && new Date(l.takenAt).toDateString() === today
                );
                if (alreadyLoggedToday) {
                    showNotification(`‚ö†Ô∏è ${medicine.name} is already logged for today.`);
                    return;
                }

                const log = {
                    medicineId: id,
                    medicineName: medicine.name,
                    email: document.getElementById("email").value || medicine.email || DEFAULT_EMAIL,
                    status: "taken",
                    takenAt: new Date().toISOString(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };

                try {
                    const res = await fetch("http://localhost:3000/logDose", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(log)
                    });

                    const data = await res.json();

                    if (data.success) {
                        showNotification(`‚úÖ ${medicine.name} marked as taken!`);

                        doseLogs.push(log);
                        localStorage.setItem("doseLogs", JSON.stringify(doseLogs));

                        const btn = document.querySelector(`button[onclick="markAsTaken('${medicine.id}')"]`);
                        if (btn) {
                            btn.textContent = "‚úÖ Taken Logged!";
                            btn.disabled = true;
                            btn.style.backgroundColor = "#2ecc71";
                        }

                        renderUserDashboard();
                        updateUpcomingDoses();
                        loadAdherenceDashboard(log.email);
                        renderMissedDoseHistoryTable();
                        calculateDailyAdherence(); // ‚úÖ Refresh adherence stats
                        setTimeout(updateDashboard, 100);


                    } else {
                        showNotification(`‚ö†Ô∏è Failed to mark ${medicine.name} as taken.`);
                    }
                } catch (err) {
                    console.error("Failed to mark dose as taken:", err);
                    showNotification("‚ö†Ô∏è An error occurred while logging the dose.");
                }
            }


            function updateDashboard() {
                medicines = JSON.parse(localStorage.getItem("medicines")) || [];
                const today = new Date().toDateString();
                let totalDoses = 0;

                medicines.forEach(med => {
                    const medStartDate = new Date(med.startDate || med.addedAt || med.createdAt || Date.now());
                    if (new Date().getTime() < medStartDate.getTime()) return;

                    switch (med.frequency) {
                        case "onceDaily": totalDoses += 1; break;
                        case "twiceDaily": totalDoses += 2; break;
                        case "every8h": totalDoses += 3; break;
                        default: totalDoses += 1;
                    }
                });

                const takenToday = doseLogs.filter(
                    l => new Date(l.takenAt).toDateString() === today && l.status === "taken"
                ).length;

                const missedToday = doseLogs.filter(
                    l => new Date(l.takenAt).toDateString() === today && l.status === "missed"
                ).length;

                const adherenceRate = totalDoses > 0 ? Math.round((takenToday / totalDoses) * 100) : 0;

                document.getElementById('totalMedicines').textContent = medicines.length;
                document.getElementById('totalDosesToday').textContent = totalDoses;
                document.getElementById('takenToday').textContent = takenToday;
                document.getElementById('missedToday').textContent = missedToday;
                document.getElementById('adherenceRate').textContent = `${adherenceRate}%`;

                updateWellnessRate(adherenceRate);
                updateUpcomingDoses();
                renderAdherenceChart();
                renderMissedVsTakenChart();
                renderTrendLineChart();
                renderMissedDoseHistoryTable();
                calculateDailyAdherence();
                updateStreakDisplay?.();
                updateAdherencePredictionAndRisk();

            }
            function updateAdherencePredictionAndRisk() {
                const panel = document.getElementById("predictionPanel");
                if (!panel) return;

                const { adherenceRate, missedToday, totalDoses } = calculateDailyAdherence();

                // ‚úÖ Handle case where no data yet
                if (totalDoses === 0) {
                    panel.innerHTML = `
            <div style="color:#e6d3a3; font-size:1rem; line-height:1.6;">
                üìä No data available yet. Add medicines and log doses to see predictions.
            </div>
        `;
                    return;
                }

                let predictionText = "";
                let riskLevel = "";

                // ‚úÖ Risk prediction logic
                if (adherenceRate >= 90) {
                    predictionText = "üßô‚Äç‚ôÇÔ∏è Excellent adherence! Future adherence likely to remain high.";
                    riskLevel = "üü¢ Low Risk";
                } else if (adherenceRate >= 70) {
                    predictionText = "‚ú® Good adherence, but occasional misses could affect outcomes.";
                    riskLevel = "üü° Moderate Risk";
                } else if (adherenceRate >= 50) {
                    predictionText = "‚ö†Ô∏è Adherence is slipping. Increased risk of treatment inefficacy.";
                    riskLevel = "üü† High Risk";
                } else {
                    predictionText = "üö® Critical adherence risk! Immediate intervention recommended.";
                    riskLevel = "üî¥ Severe Risk";
                }

                // ‚úÖ Predict next 7 days adherence (simple forecast)
                const predictedNext7Days = Math.max(0, Math.min(100, Math.round(adherenceRate - 5)));

                panel.innerHTML = `
        <div style="color:#e6d3a3; font-size:1rem; line-height:1.6;">
            <p>${predictionText}</p>
            <p><strong>Risk Level:</strong> ${riskLevel}</p>
            <p><strong>Missed Today:</strong> ${missedToday} dose(s)</p>
            <p><strong>Predicted adherence next 7 days:</strong> ${predictedNext7Days}%</p>
        </div>
    `;
            }


            function calculateDailyAdherence() {
                let totalDoses = 0;
                let takenToday = 0;
                let missedToday = 0;

                // ‚úÖ 1. Count how many doses are scheduled for today based on frequency
                medicines.forEach(med => {
                    // Skip invalid or incomplete entries
                    if (!med || !med.frequency) return;

                    switch (med.frequency) {
                        case "onceDaily":
                            totalDoses += 1;
                            break;
                        case "twiceDaily":
                            totalDoses += 2;
                            break;
                        case "every8h":
                            totalDoses += 3;
                            break;
                        default:
                            totalDoses += 1;
                    }
                });

                // ‚úÖ 2. Count how many doses were taken or missed today
                const todayString = new Date().toDateString();
                doseLogs.forEach(log => {
                    if (!log || !log.takenAt) return; // skip invalid entries
                    const logDate = new Date(log.takenAt).toDateString();
                    if (logDate === todayString) {
                        if (log.status === "taken") takenToday++;
                        if (log.status === "missed") missedToday++;
                    }
                });

                // ‚úÖ 3. Calculate adherence rate (percentage)
                const adherenceRate = totalDoses > 0 ? Math.round((takenToday / totalDoses) * 100) : 0;

                // ‚úÖ 4. Return all data for other functions (prediction, charts, etc.)
                return {
                    totalDoses,
                    takenToday,
                    missedToday,
                    adherenceRate
                };
            }

            let adherenceChartInstance = null;

            function renderAdherenceChart() {
                const ctx = document.getElementById('adherenceChartMain').getContext('2d');


                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dayStr = date.toDateString();

                    const medsToday = medicines.length;
                    const takenToday = doseLogs.filter(log =>
                        new Date(log.takenAt).toDateString() === dayStr &&
                        log.status === 'taken'
                    ).length;

                    const adherence = medsToday > 0 ? Math.round((takenToday / medsToday) * 100) : 0;
                    labels.push(date.toLocaleDateString(undefined, { weekday: 'short' }));
                    data.push(adherence);
                }

                if (adherenceChartInstance) {
                    adherenceChartInstance.destroy();
                }

                adherenceChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Adherence %',
                            data: data,
                            backgroundColor: 'rgba(255, 179, 71, 0.6)',
                            borderColor: '#ffb347',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            function renderMissedVsTakenChart() {
                const ctx = document.getElementById("missedVsTakenChart").getContext("2d");
                const today = new Date().toDateString();

                const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === today && l.status === 'taken').length;
                const missed = doseLogs.filter(l => new Date(l.takenAt).toDateString() === today && l.status === 'missed').length;

                if (window.missedVsTakenChartInstance) {
                    window.missedVsTakenChartInstance.destroy();
                }

                window.missedVsTakenChartInstance = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Taken", "Missed"],
                        datasets: [{
                            data: [taken, missed],
                            backgroundColor: ["#4CAF50", "#F44336"],
                        }],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: "bottom" },
                            title: { display: true, text: "Today's Doses" },
                        },
                    },
                });
            }

            function renderTrendLineChart() {
                const ctx = document.getElementById('trendLineChart').getContext('2d');
                const labels = [];
                const data = [];

                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dayStr = date.toDateString();

                    const medsToday = medicines.length;
                    const takenToday = doseLogs.filter(log =>
                        new Date(log.takenAt).toDateString() === dayStr &&
                        log.status === 'taken'
                    ).length;

                    const adherence = medsToday > 0 ? Math.round((takenToday / medsToday) * 100) : 0;
                    labels.push(date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                    data.push(adherence);
                }

                if (window.trendLineChartInstance) {
                    window.trendLineChartInstance.destroy();
                }

                window.trendLineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Daily Adherence %',
                            data,
                            borderColor: '#ffb347',
                            backgroundColor: 'rgba(255,179,71,0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            function updateWellnessRate(rate) {
                const wellnessElement = document.getElementById('wellnessRate');
                let ratingText = '';
                let ratingClass = '';

                if (rate >= 90) {
                    ratingText = '‚ú® Excellent Wellness ‚ú®';
                    ratingClass = 'wellness-excellent';
                } else if (rate >= 75) {
                    ratingText = 'üåü Good Wellness üåü';
                    ratingClass = 'wellness-good';
                } else if (rate >= 50) {
                    ratingText = '‚ö° Fair Wellness ‚ö°';
                    ratingClass = 'wellness-fair';
                } else if (rate >= 25) {
                    ratingText = '‚ö†Ô∏è Poor Wellness ‚ö†Ô∏è';
                    ratingClass = 'wellness-poor';
                } else {
                    ratingText = 'üö® Critical Wellness üö®';
                    ratingClass = 'wellness-critical';
                }

                wellnessElement.textContent = ratingText;
                wellnessElement.className = `wellness-rate ${ratingClass}`;
            }

            function updateUpcomingDoses() {
                const container = document.getElementById('upcomingDoses');
                const now = new Date();
                const upcoming = [];

                medicines.forEach(medicine => {
                    const lastTaken = doseLogs
                        .filter(log => log.medicineId === medicine.id && log.status === 'taken')
                        .sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt))[0];

                    let nextDoseTime;

                    if (lastTaken) {
                        nextDoseTime = new Date(lastTaken.takenAt);
                        switch (medicine.frequency) {
                            case "onceDaily":
                                nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                                break;
                            case "twiceDaily":
                                nextDoseTime.setHours(nextDoseTime.getHours() + 12);
                                break;
                            case "every8h":
                                nextDoseTime.setHours(nextDoseTime.getHours() + 8);
                                break;
                            case "everyOtherDay":
                                nextDoseTime.setDate(nextDoseTime.getDate() + 2);
                                break;
                            case "weekly":
                                nextDoseTime.setDate(nextDoseTime.getDate() + 7);
                                break;
                            default:
                                nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                        }
                    } else {
                        const [hours, minutes] = medicine.time.split(':');
                        nextDoseTime = new Date();
                        nextDoseTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                        if (nextDoseTime <= now) {
                            nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                        }
                    }

                    upcoming.push({
                        medicine: medicine.name,
                        time: nextDoseTime,
                        displayTime: nextDoseTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    });
                });

                upcoming.sort((a, b) => a.time - b.time);

                if (upcoming.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #e6d3a3;">No upcoming doses scheduled</p>';
                    return;
                }

                container.innerHTML = upcoming.map(dose => `
                <div class="dose-item">
                    <div>
                        <div class="dose-time">${dose.displayTime}</div>
                        <div class="dose-medicine">üß™ ${dose.medicine}</div>
                    </div>
                    <div style="color: #ffb347;">
                        ${dose.time.toDateString() === now.toDateString() ? 'Today' : 'Tomorrow'}
                    </div>
                </div>
            `).join('');
            }
            function renderUserDashboard() {
                const now = new Date();

                const upcomingReminders = medicines.map(med => {
                    const lastTaken = doseLogs
                        .filter(log => log.medicineId === med.id && log.status === 'taken')
                        .sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt))[0];

                    let nextDoseTime;

                    if (lastTaken) {
                        nextDoseTime = new Date(lastTaken.takenAt);

                        switch (med.frequency) {
                            case "onceDaily":
                                nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                                break;
                            case "twiceDaily":
                                nextDoseTime.setHours(nextDoseTime.getHours() + 12);
                                break;
                            case "every8h":
                                nextDoseTime.setHours(nextDoseTime.getHours() + 8);
                                break;
                            case "everyOtherDay":
                                nextDoseTime.setDate(nextDoseTime.getDate() + 2);
                                break;
                            case "weekly":
                                nextDoseTime.setDate(nextDoseTime.getDate() + 7);
                                break;
                            default:
                                nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                        }
                    } else {
                        // Fallback if never taken
                        const [hours, minutes] = med.time.split(':');
                        nextDoseTime = new Date();
                        nextDoseTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                        if (nextDoseTime < now) nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                    }

                    return {
                        name: med.name,
                        time: nextDoseTime,
                        status: '‚è≥ Upcoming'
                    };
                }).sort((a, b) => a.time - b.time);


                const pastReminders = doseLogs
                    .map(log => ({
                        name: log.medicineName,
                        time: new Date(log.takenAt),
                        status: log.status === 'taken' ? '‚úÖ Taken' : '‚ùå Missed'
                    }))
                    .sort((a, b) => b.time - a.time);

                const upcomingContainer = document.getElementById('upcomingRemindersList');
                if (upcomingReminders.length === 0) {
                    upcomingContainer.innerHTML = `<p style="color: #e6d3a3;">No upcoming reminders scheduled.</p>`;
                } else {
                    upcomingContainer.innerHTML = upcomingReminders.map(reminder => `
            <div class="dose-item" style="display: flex; justify-content: space-between;">
                <div>
                    <div class="dose-time">${reminder.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="dose-medicine">üß™ ${reminder.name}</div>
                </div>
                <div style="font-weight: bold; color: #4ecdc4;">${reminder.status}</div>
            </div>
        `).join('');
                }

                const pastContainer = document.getElementById('pastRemindersList');
                if (pastReminders.length === 0) {
                    pastContainer.innerHTML = `<p style="color: #e6d3a3;">No past reminders recorded yet.</p>`;
                } else {
                    pastContainer.innerHTML = pastReminders.map(reminder => `
            <div class="dose-item" style="display: flex; justify-content: space-between;">
                <div>
                    <div class="dose-time">${reminder.time.toLocaleString()}</div>
                    <div class="dose-medicine">üß™ ${reminder.name}</div>
                </div>
                <div style="font-weight: bold; color: ${reminder.status.includes('‚úÖ') ? '#4ecdc4' : '#eb4d4b'};">
                    ${reminder.status}
                </div>
            </div>
        `).join('');
                }
            }

            function showNotification(message, duration = 4000, options = {}) {
                const notification = document.getElementById('notification');
                const notificationText = document.getElementById('notificationText');
                const snoozeBtn = document.getElementById('snoozeBtn');

                if (notificationTimeout) clearTimeout(notificationTimeout);

                notification.classList.remove('show', 'fade-out');
                snoozeBtn.style.display = options.allowSnooze ? 'inline-block' : 'none';

                snoozeBtn.onclick = () => {
                    notification.classList.remove('show');
                    scheduleSnoozeReminder(options.medicineId || null, 15);
                };

                setTimeout(() => {
                    notificationText.textContent = message;
                    notification.classList.add('show');
                }, 50);

                notificationTimeout = setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        notification.classList.remove('show', 'fade-out');
                    }, 800);
                }, duration);
            }
            async function markAsMissed(id) {
                const medicine = medicines.find(m => m.id === id);
                if (!medicine) return;

                const today = new Date().toDateString();

                // ‚úÖ Prevent double marking (taken or missed)
                const alreadyLoggedToday = doseLogs.some(
                    l => l.medicineId === id && new Date(l.takenAt).toDateString() === today
                );
                if (alreadyLoggedToday) {
                    showNotification(`‚ö†Ô∏è ${medicine.name} is already logged for today.`);
                    return;
                }

                // ‚úÖ Check start date
                const medStartDate = new Date(medicine.startDate || medicine.addedAt || medicine.createdAt || Date.now());

                // ‚úÖ Find today's scheduled dose time (if you store times in medicine.schedule or doses[])
                let scheduledTime = null;
                if (medicine.doses && medicine.doses.length > 0) {
                    const todayDose = medicine.doses.find(d => new Date(d.time).toDateString() === today);
                    if (todayDose) {
                        scheduledTime = new Date(todayDose.time).getTime();
                    }
                }

                // üõë If no scheduled time is found, fallback: assume morning 9AM (or current time - 2h check)
                if (!scheduledTime) {
                    scheduledTime = new Date();
                    scheduledTime.setHours(9, 0, 0, 0); // fallback default
                }

                // ‚úÖ Time-based validation
                const now = Date.now();
                if (scheduledTime > now) {
                    showNotification("‚è± You cannot mark this dose as missed before its scheduled time.");
                    return;
                }

                // üõë Ensure medicine existed before scheduled time
                if (scheduledTime < medStartDate.getTime()) {
                    showNotification("‚ö†Ô∏è This dose is before the medicine was added, so it cannot be marked missed.");
                    return;
                }

                // ‚úÖ Allow marking only if 2 hours have passed since scheduled time
                if (now < scheduledTime + 2 * 60 * 60 * 1000) {
                    showNotification("‚è± Please wait until 2 hours after the scheduled time to mark as missed.");
                    return;
                }

                // ‚úÖ Create missed log object
                const log = {
                    medicineId: id,
                    medicineName: medicine.name,
                    email: document.getElementById("email").value || medicine.email || DEFAULT_EMAIL,
                    status: "missed",
                    takenAt: new Date().toISOString(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };

                try {
                    const res = await fetch("http://localhost:3000/markMissed", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(log)
                    });

                    const data = await res.json();
                    if (data.success) {
                        showNotification(`‚ùå ${medicine.name} marked as missed!`);
                        doseLogs.push(log);
                        localStorage.setItem("doseLogs", JSON.stringify(doseLogs));

                        const btn = document.querySelector(`button[onclick="markAsMissed('${medicine.id}')"]`);
                        if (btn) {
                            btn.textContent = "‚ùå Missed Logged!";
                            btn.disabled = true;
                            btn.style.backgroundColor = "#c0392b";
                        }

                        renderUserDashboard();
                        updateUpcomingDoses();
                        loadAdherenceDashboard(log.email);
                        renderMissedDoseHistoryTable();
                        calculateDailyAdherence(); // ‚úÖ Refresh adherence stats
                        setTimeout(updateDashboard, 100);
                    }
                } catch (err) {
                    console.error("Failed to mark missed dose:", err);
                    showNotification("‚ö†Ô∏è An error occurred while logging missed dose.");
                }
            }

            function checkDueMedicines() {
                const now = Date.now();

                medicines.forEach(med => {
                    if (!med.time) return;

                    const [h, m] = med.time.split(":");
                    const scheduled = new Date();
                    scheduled.setHours(parseInt(h), parseInt(m), 0, 0);

                    const medStartDate = new Date(med.startDate || med.addedAt || med.createdAt || Date.now());
                    const scheduledTime = scheduled.getTime();

                    // üõë Ignore doses before medicine was added or future doses
                    if (scheduledTime < medStartDate.getTime() || scheduledTime > now) return;

                    // ‚úÖ Check if already logged today
                    const alreadyLogged = doseLogs.some(
                        l => l.medicineId === med.id && new Date(l.takenAt).toDateString() === new Date().toDateString()
                    );

                    // ‚úÖ Auto-mark as missed if 2+ hours have passed and not taken/missed yet
                    if (!alreadyLogged && now > scheduledTime + 2 * 60 * 60 * 1000) {
                        markAsMissed(med.id);
                    }

                    // üîî Reminder notification if within 1 min of scheduled time
                    const diff = Math.abs(now - scheduledTime);
                    if (diff <= 60000) {
                        showNotification(
                            `üîî Time for ${med.name}! Dosage: ${med.dosage}`,
                            8000,
                            { allowSnooze: true, medicineId: med.id }
                        );

                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('üé™ Alchemist Reminder', {
                                body: `Time for ${med.name}! Dosage: ${med.dosage}`,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üß™</text></svg>'
                            });
                        }
                    }
                });
            }



            function scheduleSnoozeReminder(medicineId, minutes) {
                const med = medicines.find(m => m.id === medicineId);
                if (!med) return;

                const snoozeTime = new Date(Date.now() + minutes * 60 * 1000);

                showNotification(`üîî Snoozed! I‚Äôll remind you about ${med.name} at ${snoozeTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`, 4000);

                setTimeout(() => {
                    showNotification(`‚è∞ Time to take ${med.name}!`, 8000, { allowSnooze: true, medicineId });
                }, minutes * 60 * 1000);
            }


            function updateClock() {
                const clock = document.getElementById('clock');
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                clock.textContent = `üï∞Ô∏è ${hours}:${minutes}:${seconds}`;
            }
            function clearPastReminders() {
                if (confirm("Are you sure you want to clear all past reminders? This action cannot be undone.")) {
                    doseLogs = [];
                    localStorage.setItem('doseLogs', JSON.stringify(doseLogs));
                    renderUserDashboard();
                    showNotification('üßπ All past reminders cleared successfully!');
                    updateStreakDisplay();
                }
            }

            updateClock();
            setInterval(updateClock, 1000);

            function generateRandomCrierAnnouncement() {
                const randomAnnouncement = crierAnnouncements[Math.floor(Math.random() * crierAnnouncements.length)];
                document.getElementById('circusCrier').innerHTML = `
                <div style="background: rgba(255, 179, 71, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #ffb347;">
                    <p style="font-style: italic; color: #e6d3a3; margin-bottom: 10px;">${randomAnnouncement}</p>
                    <small style="color: #ffb347;">- The Circus Crier, ${new Date().toLocaleTimeString()}</small>
                </div>
            `;
            }

            document.getElementById('medicineForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = {
                    id: currentEditingId || Date.now().toString(),
                    name: document.getElementById('medicineName').value,
                    dosage: document.getElementById('dosage').value,
                    time: document.getElementById('time').value,
                    frequency: document.getElementById('frequency').value,
                    duration: parseInt(document.getElementById('duration').value),
                    createdAt: new Date().toISOString()
                };

                if (currentEditingId) {
                    const index = medicines.findIndex(med => med.id === currentEditingId);
                    medicines[index] = { ...medicines[index], ...formData };
                    showNotification('üß™ Elixir formula updated successfully!');
                    currentEditingId = null;
                } else {
                    medicines.push(formData);
                    showNotification('‚ú® New elixir added to the Grimoire!');
                }

                localStorage.setItem('medicines', JSON.stringify(medicines));
                renderMedicines();
                updateDashboard();

                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const payload = {
                    medicineName: formData.name,
                    dosage: formData.dosage,
                    time: formData.time,
                    frequency: formData.frequency,
                    duration: formData.duration,
                    email: document.getElementById('email').value,
                    startDate: new Date().toISOString().split('T')[0],
                    timezone: userTimezone
                };

                fetch("http://localhost:3000/addSchedule", {  // <-- make sure port matches backend
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(resp => {
                        console.log('üì° Server schedule response:', resp);
                    })
                    .catch(err => {
                        console.warn('‚ùå Failed to add schedule to server:', err);
                    });

                this.reset();
                updateStreakDisplay();
            });

            function frequencyToHours(freq) {
                switch (freq) {
                    case "onceDaily": return 24;
                    case "twiceDaily": return 12;
                    case "every8h": return 8;
                    case "everyOtherDay": return 48;
                    case "weekly": return 24 * 7;
                    default: return 24;
                }
            }

            function updateStreakDisplay() {
                const today = new Date().toDateString();
                let streak = 0;
                let currentDate = new Date();

                while (true) {
                    const dateStr = currentDate.toDateString();

                    // ‚úÖ Calculate expected doses for that date
                    let expectedDoses = 0;
                    medicines.forEach(med => {
                        const medStartDate = new Date(med.startDate || med.addedAt || med.createdAt || Date.now());
                        if (currentDate.getTime() < medStartDate.getTime()) return;

                        switch (med.frequency) {
                            case "onceDaily": expectedDoses += 1; break;
                            case "twiceDaily": expectedDoses += 2; break;
                            case "every8h": expectedDoses += 3; break;
                            default: expectedDoses += 1;
                        }
                    });

                    const taken = doseLogs.filter(
                        l => new Date(l.takenAt).toDateString() === dateStr && l.status === "taken"
                    ).length;

                    // ‚ùå If not all doses taken that day, streak ends
                    if (taken < expectedDoses) break;

                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1); // go back 1 day
                }

                document.getElementById("streakCounter").textContent = `üî• Current Streak: ${streak} days`;
            }


            function analyzeAdherencePatterns() {
                const panel = document.getElementById('predictionPanel');
                if (!panel) return;

                if (!medicines || medicines.length === 0) {
                    panel.innerHTML = `<p style="color:#e6d3a3;">No medicines to analyze.</p>`;
                    return;
                }

                const results = medicines.map(med => computeMedicineRisk(med));

                results.sort((a, b) => b.risk - a.risk);

                const rows = results.map(r => {
                    const color =
                        r.risk >= 75 ? '#eb4d4b' :
                            r.risk >= 50 ? '#f0932b' :
                                r.risk >= 25 ? '#f9ca24' : '#4ecdc4';
                    return `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px dashed rgba(255,255,255,0.03);">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#ffb347;">${r.name}</div>
                    <div style="color:#e6d3a3; font-size:0.9rem;">${r.reasons.join(' ¬∑ ')}</div>
                </div>
                <div style="width:140px; text-align:right;">
                    <div style="font-weight:bold; color:${color}; font-size:1.2rem;">${r.risk}%</div>
                    <div style="font-size:0.85rem; color:#e6d3a3;">${r.suggestion}</div>
                </div>
            </div>
        `;
                }).join('');

                panel.innerHTML = `
        <div style="border-radius:8px; overflow:hidden; background:linear-gradient(90deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25));">
            ${rows}
        </div>
        <div style="margin-top:10px; color:#e6d3a3; font-size:0.9rem;">
            Proactive suggestions are heuristic-based. For persistent high risk, consider adjusting schedule or enabling extra reminders.
        </div>
    `;

                const high = results.find(r => r.risk >= 85);
                if (high) {
                    showNotification(`‚ö†Ô∏è High risk detected for ${high.name} (${high.risk}%). Consider reviewing schedule.`, 7000);
                }
            }

            try {
                const _origUpdate = updateDashboard;
                updateDashboard = function () {
                    _origUpdate();
                    analyzeAdherencePatterns();
                };
            } catch (e) {

            }

            function calculateStreak() {
                const dates = {};
                doseLogs.forEach(log => {
                    const date = new Date(log.takenAt).toDateString();
                    if (!dates[date]) dates[date] = { taken: 0, missed: 0, total: 0 };
                    if (log.status === 'taken') dates[date].taken++;
                    if (log.status === 'missed') dates[date].missed++;
                    dates[date].total++;
                });

                let streak = 0;
                let currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);

                while (true) {
                    const dayKey = currentDate.toDateString();

                    if (!dates[dayKey]) break;

                    if (dates[dayKey].missed > 0 || dates[dayKey].taken < dates[dayKey].total) break;

                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                }

                return streak;
            }

            setInterval(generateRandomCrierAnnouncement, 300000);
            setInterval(checkDueMedicines, 60000);
            const tutorialSteps = [
                {
                    target: '.header',
                    title: 'Welcome to Your Grimoire!',
                    text: 'This is your magical medicine management system...',
                    position: 'bottom'
                },
                {
                    target: '.nav-tabs',
                    title: 'Navigation Crystals',
                    text: 'These enchanted tabs let you switch between sections...',
                    position: 'bottom'
                },
                {
                    target: '#medicineForm',
                    title: 'Schedule Potion Form',
                    text: 'Here you enter the essential details for your elixir.',
                    position: 'top'
                },
                {
                    target: '#email',
                    title: 'üìß Email Field',
                    text: 'Here you must provide your email to receive reminders.',
                    position: 'top'
                },
                {
                    target: '#medicineList',
                    title: 'üìú Current Elixir Schedules',
                    text: 'Here you can see and manage your existing potion plans.',
                    position: 'top'
                },
                {
                    target: '#predictionPanel',
                    title: 'ü§ñ Adherence Predictions',
                    text: 'This panel predicts adherence trends and highlights risk levels.',
                    position: 'top'
                },
                {
                    target: '#dashboard',
                    title: 'üìä Wellness Dashboard',
                    text: 'Here are your wellness metrics, adherence trends, and charts.',
                    position: 'top'
                },

                {
                    target: '#streakCounter',
                    title: 'üî• Streak Counter',
                    text: 'This shows how many days you have successfully followed your schedule.',
                    position: 'top'
                },
                {
                    target: '#notification',
                    title: '‚è∞ Notification System',
                    text: 'This magical bell alerts you when it is time to take your potion.',
                    position: 'top'
                },
            ];

            let currentStepIndex = 0;
            let wizardActive = false;
            function startWizard() {
                wizardActive = true;
                currentStepIndex = 0;

                document.getElementById('wizardOverlay').classList.add('active');
                document.getElementById('wizardContainer').classList.add('active');
                document.getElementById('restartWizard').style.display = 'none';

                showStep(0);
            }
            function showStep(index) {
                if (index < 0 || index >= tutorialSteps.length) return;

                currentStepIndex = index;
                const step = tutorialSteps[index];

                // Update dialogue content
                document.querySelector('.dialogue-title').textContent = step.title;
                document.querySelector('.dialogue-text').textContent = step.text;

                // Update progress
                document.getElementById('currentStep').textContent = index + 1;
                document.getElementById('totalSteps').textContent = tutorialSteps.length;
                const progress = ((index + 1) / tutorialSteps.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';

                // Update buttons
                document.querySelector('.wizard-btn-prev').disabled = index === 0;
                const nextBtn = document.querySelector('.wizard-btn-next');
                nextBtn.textContent = index === tutorialSteps.length - 1 ? 'Finish' : 'Next';

                // Highlight target element
                highlightElement(step.target, step.position);
            }
            function highlightElement(selector, position) {
                const element = document.querySelector(selector);
                if (!element) return;

                const spotlight = document.querySelector('.wizard-spotlight');
                const rect = element.getBoundingClientRect();

                spotlight.style.top = (rect.top - 10) + 'px';
                spotlight.style.left = (rect.left - 10) + 'px';
                spotlight.style.width = (rect.width + 20) + 'px';
                spotlight.style.height = (rect.height + 20) + 'px';

                // ‚ú® Reposition witch to the right side of the explained element
                const witch = document.getElementById('witchContainer');
                if (witch) {
                    witch.style.position = 'absolute';
                    witch.style.top = (window.scrollY + rect.top) + 'px';
                    witch.style.left = (window.scrollX + rect.right + 20) + 'px'; // 20px to the right of target
                }

                // Scroll element into view
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            function nextStep() {
                if (currentStepIndex < tutorialSteps.length + 8) {
                    showStep(currentStepIndex + 1);
                } else {
                    completeTutorial();
                }
            }
            function previousStep() {
                if (currentStepIndex > 0) {
                    showStep(currentStepIndex - 1);
                }
            }
            function skipTutorial() {
                if (confirm('Are you sure you want to skip the magical tour?')) {
                    completeTutorial();
                }
            }
            function completeTutorial() {
                wizardActive = false;

                document.getElementById('wizardOverlay').classList.remove('active');
                document.getElementById('wizardContainer').classList.remove('active');
                document.getElementById('restartWizard').style.display = 'block';

                // Save completion to localStorage
                localStorage.setItem('grimoire_tutorial_completed', 'true');

                // Show completion notification
                showNotification('üéâ Tutorial Complete! You are now a master of the Grimoire!');
            }
            // Auto-start wizard on first visit
            window.addEventListener('load', () => {
                const tutorialCompleted = localStorage.getItem('grimoire_tutorial_completed');
                if (!tutorialCompleted) {
                    setTimeout(startWizard, 1000); // Start after 1 second
                } else {
                    document.getElementById('restartWizard').style.display = 'block';
                }
            });

            (function () {

                // spotlight helpers (uses existing .wizard-spotlight element)
                const overlay = document.getElementById('wizardOverlay'); // .wizard-overlay parent
                const spotlight = document.querySelector('.wizard-spotlight');
                const container = document.getElementById('wizardContainer');

                function showWizardUI() {
                    if (overlay) overlay.classList.add('active');
                    if (container) container.classList.add('active');
                    // ensure restart visible hidden as appropriate
                    const restart = document.getElementById('restartWizard');
                    if (restart) restart.style.display = 'none';
                }
                function hideWizardUI() {
                    if (overlay) overlay.classList.remove('active');
                    if (container) container.classList.remove('active');
                    // show restart
                    const restart = document.getElementById('restartWizard');
                    if (restart) restart.style.display = 'inline-block';
                    removeHighlight();
                }

                function setSpotlightOnElement(el) {
                    if (!spotlight) return;
                    if (!el) {
                        spotlight.style.display = 'none';
                        return;
                    }
                    const rect = el.getBoundingClientRect();
                    // include scroll offsets
                    const top = rect.top + window.scrollY - 8;
                    const left = rect.left + window.scrollX - 8;
                    const width = rect.width + 16;
                    const height = rect.height + 16;
                    spotlight.style.display = 'block';
                    spotlight.style.left = left + 'px';
                    spotlight.style.top = top + 'px';
                    spotlight.style.width = width + 'px';
                    spotlight.style.height = height + 'px';
                    // highlight CSS on element
                    removeHighlight();
                    try { el.classList.add('mentor-highlight'); } catch (e) { }
                    // scroll smoothly so the element is visible
                    try { el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' }); } catch (e) { }
                }

                function removeHighlight() {
                    document.querySelectorAll('.mentor-highlight').forEach(n => n.classList.remove('mentor-highlight'));
                    if (spotlight) spotlight.style.display = 'none';
                }
                const steps = [
                    { id: 'schedule_intro', openTab: 'schedule', selector: '.header', type: 'none', title: 'Schedule Potions', text: 'Welcome! We will begin in the Schedule Potions section. I will guide you through each form field step by step.' },
                    { id: 'field_name', openTab: 'schedule', selector: '#medicineName', type: 'focus', title: 'Potion Name', text: 'Enter the name of your medicine ‚Äî for example, "Flying Potion".' },
                    { id: 'field_email', openTab: 'schedule', selector: '#email', type: 'focus', title: 'Email', text: 'Provide your email ID to receive reminder notifications for scheduled doses.' },
                    { id: 'field_dosage', openTab: 'schedule', selector: '#dosage', type: 'focus', title: 'Dosage', text: 'Enter the dosage, for example 500 mg.' },
                    { id: 'field_time', openTab: 'schedule', selector: '#time', type: 'focus', title: 'First Dose Time', text: 'Set the time for the first dose. This will act as the base schedule for all reminders.' },
                    { id: 'field_frequency', openTab: 'schedule', selector: '#frequency', type: 'focus', title: 'Frequency', text: 'Choose how often the medicine should repeat ‚Äî once daily, twice daily, or every 8 hours.' },
                    { id: 'field_duration', openTab: 'schedule', selector: '#duration', type: 'focus', title: 'Duration', text: 'Set how many days the schedule should continue.' },
                    { id: 'form_submit', openTab: 'schedule', selector: '#medicineForm button[type="submit"], #medicineForm .btn-primary, #medicineForm input[type="submit"]', type: 'submit', title: 'Add Medication', text: 'Click "Add Medication" to save your schedule.' },
                    { id: 'current_schedules', openTab: 'schedule', selector: '#medicineList', type: 'click', title: 'Current Elixir Schedules', text: 'Here you can view, edit, or remove your active schedules.' },

                    { id: 'user_dashboard_intro', openTab: 'userDashboard', selector: '#upcomingRemindersList', type: 'none', title: 'User Dashboard', text: 'Next, let‚Äôs explore the User Dashboard, where you can manage reminders and logs.' },
                    { id: 'upcoming_reminders', openTab: 'userDashboard', selector: '#upcomingRemindersList', type: 'click', title: 'Upcoming Reminders', text: 'These are your upcoming doses. Click to mark them as taken or missed.' },
                    { id: 'past_reminders', openTab: 'userDashboard', selector: '#pastRemindersList', type: 'click', title: 'Past Reminders', text: 'This section lists your past doses and how they were logged.' },
                    { id: 'missed_dose_history', openTab: 'userDashboard', selector: '#missedDoseHistoryTable', type: 'click', title: 'Missed Dose History', text: 'A new feature: this table shows all your missed doses with timestamps, helping you track adherence issues over time.' },

                    { id: 'wellness_intro', openTab: 'dashboard', selector: '.dashboard-grid', type: 'none', title: 'Wellness Dashboard', text: 'Here‚Äôs where we visualize your adherence data with analytics and predictions.' },
                    { id: 'adherence_prediction', openTab: 'dashboard', selector: '#predictionCard', type: 'click', title: 'Adherence Predictions & Risk', text: 'üìä New Feature: This section predicts your future adherence based on your dose history and highlights your current risk level.' },
                    { id: 'risk_level', openTab: 'dashboard', selector: '#predictionPanel', type: 'click', title: 'Risk Level & Recommendations', text: 'This panel breaks down your adherence risk, missed doses, and provides personalized tips to improve consistency.' },
                    { id: 'adherence_chart', openTab: 'dashboard', selector: '#adherenceChart', type: 'click', title: 'Daily Adherence Trends', text: 'See your adherence percentage day by day. Hover for detailed stats.' },
                    { id: 'missed_chart', openTab: 'dashboard', selector: '#missedVsTakenChart', type: 'click', title: 'Missed vs Taken', text: 'This donut chart compares how many doses you‚Äôve taken versus missed.' },
                    { id: 'trend_chart', openTab: 'dashboard', selector: '#trendLineChart', type: 'click', title: '30-day Progress', text: 'This line graph shows how your adherence has evolved over the past month.' },
                    { id: 'streak', openTab: 'dashboard', selector: '#streakCounter', type: 'click', title: 'Streak Counter', text: 'Track how many consecutive days you‚Äôve followed your schedule. Keep the streak alive!' },
                    { id: 'sound_settings', openTab: 'dashboard', selector: '#soundControls', type: 'click', title: 'Sound & Voice Settings', text: 'üéß New Feature: Control the witch voice narration, tutorial sounds, and notification tones here.' },
                    { id: 'clock_notify', openTab: 'dashboard', selector: '#clock', type: 'click', title: 'Clock & Notifications', text: 'This clock shows your current time. Notifications for doses will appear in the top-right corner.' },

                    { id: 'complete', selector: '.header', type: 'none', title: 'Tutorial Complete', text: 'You‚Äôre now ready to master potion adherence! You can restart this tour anytime from the menu.' }
                ];


                let idx = 0;
                let waiting = false;
                let currentListener = null;

                const nextBtn = document.querySelector('.wizard-btn-next');
                const prevBtn = document.querySelector('.wizard-btn-prev');
                const skipBtn = document.querySelector('.wizard-btn-skip');

                if (nextBtn) nextBtn.addEventListener('click', () => {
                    if (!waiting) goToStep(idx + 1);
                    else {
                        removeWaitListeners();
                        goToStep(idx + 1);
                    }
                });
                if (prevBtn) prevBtn.addEventListener('click', () => {
                    removeWaitListeners();
                    goToStep(Math.max(0, idx - 1));
                });
                if (skipBtn) skipBtn.addEventListener('click', () => {
                    removeWaitListeners();
                    finishTutorial();
                });

                function removeWaitListeners() {
                    waiting = false;
                    if (currentListener && currentListener.remove) currentListener.remove();
                    currentListener = null;
                }

                function waitForClick(target, callback) {
                    if (!target) return callback();
                    waiting = true;
                    const handler = function (e) {
                        if (target.contains(e.target) || e.target === target) {
                            removeWaitListeners();
                            callback();
                        }
                    };
                    document.addEventListener('click', handler, { capture: true });
                    currentListener = { remove: () => document.removeEventListener('click', handler, { capture: true }) };
                }
                function updateStreakDisplay() {
                    const today = new Date().toDateString();
                    let totalDosesToday = 0;

                    medicines.forEach(med => {
                        switch (med.frequency) {
                            case "onceDaily": totalDosesToday += 1; break;
                            case "twiceDaily": totalDosesToday += 2; break;
                            case "every8h": totalDosesToday += 3; break;
                            case "everyOtherDay":
                                const start = new Date(med.startDate || Date.now());
                                const diffDays = Math.floor((Date.now() - start.getTime()) / (1000 * 60 * 60 * 24));
                                if (diffDays % 2 === 0) totalDosesToday += 1;
                                break;
                            case "weekly":
                                const todayIdx = new Date().getDay();
                                const scheduledDay = med.weekday !== undefined ? med.weekday : 1;
                                if (todayIdx === scheduledDay) totalDosesToday += 1;
                                break;
                            default: totalDosesToday += 1;
                        }
                    });

                    const takenToday = doseLogs.filter(
                        l => new Date(l.takenAt).toDateString() === today && l.status === "taken"
                    ).length;

                    const allTaken = totalDosesToday > 0 && takenToday === totalDosesToday;

                    let streak = parseInt(localStorage.getItem("currentStreak")) || 0;
                    let longest = parseInt(localStorage.getItem("longestStreak")) || 0;
                    const lastDate = localStorage.getItem("lastStreakDate");

                    if (lastDate !== today) {
                        if (allTaken) {
                            streak++;
                            if (streak > longest) longest = streak;
                        } else {
                            streak = 0;
                        }
                        localStorage.setItem("currentStreak", streak);
                        localStorage.setItem("longestStreak", longest);
                        localStorage.setItem("lastStreakDate", today);
                    }

                    document.getElementById("currentStreak").textContent = `${streak} days`;
                    document.getElementById("longestStreak").textContent = `${longest} days`;
                    document.getElementById("totalDaysTracked").textContent = doseLogs.length > 0 ?
                        new Set(doseLogs.map(l => new Date(l.takenAt).toDateString())).size : 0;

                    const perfectDays = [...new Set(doseLogs.map(l => new Date(l.takenAt).toDateString()))].filter(date => {
                        const total = totalDosesToday;
                        const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === date && l.status === "taken").length;
                        return total > 0 && total === taken;
                    }).length;
                    document.getElementById("perfectDays").textContent = perfectDays;
                }


                function waitForFocus(target, callback) {
                    if (!target) return callback();
                    waiting = true;
                    const focusHandler = function (e) {
                        if (e.target === target) {
                            removeWaitListeners();
                            callback();
                        }
                    };
                    target.addEventListener('focus', focusHandler, { once: true });
                    currentListener = { remove: () => target.removeEventListener('focus', focusHandler) };
                }

                function waitForSubmit(form, callback) {
                    if (!form) return callback();
                    waiting = true;
                    const submitHandler = function () {
                        removeWaitListeners();
                        setTimeout(() => callback(), 250);
                    };
                    form.addEventListener('submit', submitHandler, { once: true });
                    currentListener = { remove: () => form.removeEventListener('submit', submitHandler) };
                }

                function safeQuery(selector) {
                    if (!selector) return null;
                    return document.querySelector(selector) || null;
                }

                function speakAndShow(title, text) {
                    if ('speechSynthesis' in window) {
                        window.speechSynthesis.cancel();

                        const utterance = new SpeechSynthesisUtterance(text || title || '');

                        // ‚úÖ Load saved voice selection
                        const savedVoiceIndex = localStorage.getItem('grimoire_voice_index');
                        const voices = window.speechSynthesis.getVoices();
                        if (savedVoiceIndex && voices[savedVoiceIndex]) {
                            utterance.voice = voices[savedVoiceIndex];
                        }

                        // ‚úÖ Load saved rate & pitch
                        const savedRate = localStorage.getItem('grimoire_voice_rate');
                        const savedPitch = localStorage.getItem('grimoire_voice_pitch');
                        utterance.rate = savedRate ? parseFloat(savedRate) : 0.95;
                        utterance.pitch = savedPitch ? parseFloat(savedPitch) : 1.0;

                        // ‚úÖ Optional: adjust volume
                        utterance.volume = 1;

                        // Speak!
                        window.speechSynthesis.speak(utterance);
                    }

                    // Also update the dialogue bubble text
                    const titleNode = document.querySelector('.dialogue-title');
                    const textNode = document.querySelector('.dialogue-text');
                    if (titleNode) titleNode.textContent = title || '';
                    if (textNode) textNode.textContent = text || '';
                }

                // üéß Global audio player for tutorial steps
                const tutorialAudio = new Audio();

                function playStepAudio(stepIndex) {
                    // pause broom SFX if playing
                    const broom = document.getElementById('witchSound');
                    if (broom && !broom.paused) { try { broom.pause(); broom.currentTime = 0; } catch (e) { } }

                    tutorialAudio.pause();
                    tutorialAudio.currentTime = 0;
                    tutorialAudio.src = `assets/audio/tutorial/step${stepIndex + 1}.mp3`;
                    tutorialAudio.play().catch(err => console.warn("Audio missing for step", stepIndex + 1));
                }


                function goToStep(i) {
                    removeWaitListeners();
                    idx = i;
                    if (idx < 0) idx = 0;
                    if (idx >= steps.length) return finishTutorial();

                    const step = steps[idx];

                    if (step.openTab && typeof switchTab === 'function') {
                        try { switchTab(step.openTab); } catch (e) { }
                    }

                    showWizardUI();

                    const el = safeQuery(step.selector);
                    const total = steps.length;
                    const curStepNode = document.getElementById('currentStep');
                    const totalNode = document.getElementById('totalSteps');
                    const progressFill = document.getElementById('progressFill');
                    if (curStepNode) curStepNode.textContent = Math.min(idx + 1, total);
                    if (totalNode) totalNode.textContent = total;
                    if (progressFill) progressFill.style.width = ((idx + 1) / total * 100) + '%';

                    if (el) {
                        setSpotlightOnElement(el);
                    } else {
                        removeHighlight();
                        const header = document.querySelector('.header') || document.body;
                        setSpotlightOnElement(header);
                    }

                    const titleNode = document.querySelector('.dialogue-title');
                    const textNode = document.querySelector('.dialogue-text');
                    if (titleNode) titleNode.textContent = step.title || '';
                    if (textNode) textNode.textContent = step.text || '';
                    playStepAudio(idx);


                    if (step.type === 'click') {
                        if (el) {
                            waitForClick(el, () => goToStep(idx + 1));
                        } else {
                            waiting = true;
                        }
                    } else if (step.type === 'focus') {
                        if (el) {
                            try { el.focus(); } catch (e) { }
                            waitForFocus(el, () => goToStep(idx + 1));
                        } else {
                            waiting = true;
                        }
                    } else if (step.type === 'submit') {
                        const form = el || document.querySelector('#medicineForm');
                        if (form) waitForSubmit(form, () => {
                            setTimeout(() => goToStep(idx + 1), 400);
                        });
                        else waiting = true;
                    } else if (step.type === 'any') {
                        if (el) waitForClick(el, () => goToStep(idx + 1));
                        else waiting = true;
                    } else {
                        waiting = true;
                    }

                    const nextBtnLocal = document.querySelector('.wizard-btn-next');
                    if (nextBtnLocal) nextBtnLocal.textContent = (idx === steps.length - 1) ? 'Finish' : 'Next';
                    const prevBtnLocal = document.querySelector('.wizard-btn-prev');
                    if (prevBtnLocal) prevBtnLocal.disabled = idx === 0;
                }

                function finishTutorial() {
                    // Final spotlight
                    const header = document.querySelector('.header') || document.body;
                    setSpotlightOnElement(header);

                    // Play final mp3 (optional)
                    const finalAudio = new Audio('assets/audio/tutorial/final.mp3');
                    finalAudio.play().catch(() => console.warn("Final audio missing"));


                    // close UI after the audio starts (no alert())
                    setTimeout(() => {
                        hideWizardUI();
                        removeHighlight();
                        const restart = document.getElementById('restartWizard');
                        if (restart) restart.style.display = 'inline-block';
                        // non-blocking notice instead of alert()
                        showNotification && showNotification('üéâ Tutorial Complete! You are now the Master of the Grimoire!');
                    }, 4000);
                }


                window.startInteractiveTutorial = function () {
                    idx = 0;
                    goToStep(0);
                };

                const startBtn = document.getElementById('restartWizard');
                if (startBtn) startBtn.addEventListener('click', () => {
                    startBtn.style.display = 'none';
                    startInteractiveTutorial();
                });

                const summonEl = document.getElementById('mentorSummonBtn') || document.getElementById('wizardSummonBtn');
                if (summonEl) {
                    summonEl.addEventListener('click', () => {
                        startInteractiveTutorial();
                    });
                    summonEl.style.display = 'inline-block';
                }

                document.addEventListener('keydown', (e) => {
                    if (!overlay.classList.contains('active')) return;
                    if (e.key === 'ArrowRight') {
                        removeWaitListeners();
                        goToStep(idx + 1);
                    } else if (e.key === 'ArrowLeft') {
                        removeWaitListeners();
                        goToStep(Math.max(0, idx - 1));
                    } else if (e.key === 'Escape') {
                        removeWaitListeners();
                        finishTutorial();
                    }
                });

                if (overlay) overlay.style.pointerEvents = 'none';
                if (spotlight) spotlight.style.pointerEvents = 'none';

                window.__InteractiveTutorial = {
                    start: startInteractiveTutorial,
                    stop: finishTutorial
                };

            })();
            async function loadAdherenceDashboard(email) {
                const res = await fetch(`http://localhost:3000/adherenceSummary?email=${encodeURIComponent(email)}&days=7`);
                const data = await res.json();

                const labels = data.summary.map(d => d.date);
                const taken = data.summary.map(d => d.taken);
                const missed = data.summary.map(d => d.missed);

                // Update stats
                document.getElementById("adherenceStats").innerHTML = `
    <p><strong>Total Taken:</strong> ${data.totalTaken}</p>
    <p><strong>Total Missed:</strong> ${data.totalMissed}</p>
    <p><strong>Adherence Rate:</strong> ${data.adherence}%</p>
  `;

                // Draw chart
                const ctx = document.getElementById("adherenceChartUser").getContext("2d");

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Taken',
                                data: taken,
                                backgroundColor: '#4CAF50'
                            },
                            {
                                label: 'Missed',
                                data: missed,
                                backgroundColor: '#F44336'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            // ===== Enhanced Dashboard client functions =====
            let edTrendChart = null;
            let edPerMedicineChart = null;

            function isoDateFromInput(val) {
                if (!val) return null;
                return DateTime.fromISO(val).toISODate(); // yyyy-MM-dd
            }

            async function loadEnhancedDashboardControls() {
                // populate medicines filter from schedules (frontend uses 'medicines' localStorage)
                const select = document.getElementById('edMedicineFilter');
                select.innerHTML = '<option value="">All</option>';
                medicines.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    select.appendChild(opt);
                });
            }

            function setupEnhancedControls() {
                const rangeSelect = document.getElementById('edRangeSelect');
                const customInputs = document.getElementById('customRangeInputs');
                rangeSelect.addEventListener('change', () => {
                    customInputs.style.display = (rangeSelect.value === 'custom') ? 'inline-block' : 'none';
                });

                // ‚úÖ Apply Button
                document.getElementById('edApplyBtn').addEventListener('click', () => {
                    const email = document.getElementById('email').value || DEFAULT_EMAIL;
                    if (!email) {
                        showNotification("‚ö†Ô∏è Please set DEFAULT_EMAIL in script before applying filters.");
                        return;
                    }
                    loadEnhancedDashboard();
                });

                // ‚úÖ Refresh Button
                document.getElementById('edRefreshBtn').addEventListener('click', () => {
                    const email = document.getElementById('email').value || DEFAULT_EMAIL;
                    if (!email) {
                        showNotification("‚ö†Ô∏è Please set DEFAULT_EMAIL in script before refreshing dashboard.");
                        return;
                    }
                    loadEnhancedDashboard();
                });

                document.getElementById('edExportBtn').addEventListener('click', () => exportEnhancedCSV());
            }

            // Get range params
            function getEnhancedRangeParams() {
                const rangeOption = document.getElementById('edRangeSelect').value;
                if (rangeOption === 'custom') {
                    const from = document.getElementById('edFrom').value;
                    const to = document.getElementById('edTo').value;
                    return { from, to };
                } else {
                    const days = parseInt(rangeOption, 10);
                    return { days };
                }
            }

            // Main loader
            async function loadEnhancedDashboard() {
                const email = document.getElementById("email").value || DEFAULT_EMAIL;
                if (!email) {
                    showNotification("‚ö†Ô∏è Please set DEFAULT_EMAIL in script before loading dashboard");
                    return;
                }

                const medFilter = document.getElementById('edMedicineFilter').value;
                const range = getEnhancedRangeParams();

                // Build query strings
                let q = `?email=${encodeURIComponent(email)}`;
                if (range.days) q += `&days=${range.days}`;
                else {
                    if (range.from) q += `&from=${encodeURIComponent(range.from)}`;
                    if (range.to) q += `&to=${encodeURIComponent(range.to)}`;
                }
                if (medFilter) q += `&medicineId=${encodeURIComponent(medFilter)}`;

                // 1) fetch trend
                try {
                    const trendRes = await fetch(`http://localhost:3000/adherenceTrend${q}`);
                    const trendJson = await trendRes.json();
                    if (trendJson.success) {
                        renderEDTrendChart(trendJson.trend);
                    }
                } catch (err) {
                    console.error('Failed to fetch trend', err);
                }

                // 2) fetch per-medicine summary
                try {
                    const perRes = await fetch(`http://localhost:3000/perMedicineSummary?email=${encodeURIComponent(email)}${range.days ? `&days=${range.days}` : (range.from ? `&from=${range.from}&to=${range.to}` : '')}`);
                    const perJson = await perRes.json();
                    if (perJson.success) {
                        renderEDPerMedicine(perJson.summary);
                    }
                } catch (err) {
                    console.error('Failed to fetch per medicine', err);
                }

                // 3) fetch history (limit 200)
                try {
                    const histRes = await fetch(`http://localhost:3000/adherenceHistory${q}&limit=200`);
                    const histJson = await histRes.json();
                    if (histJson.success) {
                        renderEDHistoryTable(histJson.logs);
                    }
                } catch (err) {
                    console.error('Failed to fetch history', err);
                }
            }

            // Renderers
            function renderEDTrendChart(trend) {
                const labels = trend.map(d => DateTime.fromISO(d.date).toLocaleString(DateTime.DATE_MED));
                const data = trend.map(d => d.adherence);

                const ctx = document.getElementById('trendLineChart').getContext('2d');
                if (edTrendChart) edTrendChart.destroy();
                edTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Adherence %', data, borderColor: '#ffb347', backgroundColor: 'rgba(255,179,71,0.15)', fill: true, tension: 0.25 }] },
                    options: { scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }

            function renderEDPerMedicine(summary) {
                const labels = summary.map(s => s.medicineName);
                const taken = summary.map(s => s.taken);
                const missed = summary.map(s => s.missed);

                const ctx = document.getElementById('missedVsTakenChart').getContext('2d');
                if (edPerMedicineChart) edPerMedicineChart.destroy();
                edPerMedicineChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Taken', data: taken, backgroundColor: '#4ecdc4' }, { label: 'Missed', data: missed, backgroundColor: '#eb4d4b' }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } }
                });
            }

            function renderEDHistoryTable(logs) {
                const tbody = document.querySelector('#edHistoryTable tbody');
                tbody.innerHTML = '';
                logs.forEach(l => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
      <td style="padding:8px;">${DateTime.fromISO(l.takenAt).toLocaleString(DateTime.DATETIME_MED)}</td>
      <td style="padding:8px;">${l.medicineName || ''}</td>
      <td style="padding:8px; color:${l.status === 'taken' ? '#4ecdc4' : '#eb4d4b'}; font-weight:bold;">${l.status.toUpperCase()}</td>
      <td style="padding:8px;">${l.timezone || ''}</td>
    `;
                    tbody.appendChild(tr);
                });
            }

            // Initialize controls on page load
            document.addEventListener('DOMContentLoaded', () => {
                loadEnhancedDashboardControls();
                setupEnhancedControls();
            });

            // Also reload enhanced dashboard when switching to 'dashboard' tab
            const originalSwitchTab = window.switchTab;
            window.switchTab = function (tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'dashboard') {
                    loadEnhancedDashboard();
                }
            };

            function autoMarkMissed() {
                const now = new Date();

                medicines.forEach(med => {
                    const [h, m] = med.time.split(":");
                    const scheduled = new Date();
                    scheduled.setHours(parseInt(h), parseInt(m), 0, 0);

                    // ‚úÖ If more than 2 hours past scheduled and not taken/missed, mark missed
                    if (now - scheduled > 2 * 60 * 60 * 1000) {
                        const alreadyLogged = doseLogs.some(
                            l => l.medicineId === med.id && new Date(l.takenAt).toDateString() === now.toDateString()
                        );
                        if (!alreadyLogged) {
                            doseLogs.push({
                                medicineId: med.id,
                                medicineName: med.name,
                                email: med.email || getUserEmail(),
                                status: "missed",
                                takenAt: now.toISOString(),
                                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                            });
                            localStorage.setItem("doseLogs", JSON.stringify(doseLogs));
                        }
                    }
                });
            }
            setInterval(autoMarkMissed, 5 * 60 * 1000); // check every 5 min


            // ‚úÖ Final working export function
            async function exportEnhancedCSV() {
                const emailInput = document.getElementById("email").value || "";
                const email = emailInput.trim() || DEFAULT_EMAIL;

                if (!email || !email.includes("@")) {
                    showNotification("‚ö†Ô∏è Please enter a valid email or set DEFAULT_EMAIL before exporting.");
                    return;
                }

                const medFilter = document.getElementById("edMedicineFilter").value;
                const range = getEnhancedRangeParams();
                let q = `?email=${encodeURIComponent(email)}`;

                if (range.days) {
                    q += `&days=${encodeURIComponent(range.days)}`;
                } else {
                    if (range.from) q += `&from=${encodeURIComponent(range.from)}`;
                    if (range.to) q += `&to=${encodeURIComponent(range.to)}`;
                }

                if (medFilter) q += `&medicineId=${encodeURIComponent(medFilter)}`;

                try {
                    const res = await fetch(`http://localhost:3000/exportLogs${q}`);
                    if (!res.ok) throw new Error(`Server returned ${res.status}`);

                    const blob = await res.blob();
                    if (blob.size === 0) {
                        showNotification("‚ö†Ô∏è Export completed but file is empty (no data in range).");
                        return;
                    }

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "adherence_logs.csv";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);

                    showNotification("‚úÖ CSV exported successfully!");
                } catch (err) {
                    console.error("Export failed:", err);
                    showNotification("‚ö†Ô∏è Failed to export adherence logs.");
                }
            }
            async function renderMissedDoseHistory(email) {
                const res = await fetch(`/adherenceHistory?email=${encodeURIComponent(email)}&limit=100`);
                const json = await res.json();
                if (!json.success) return;

                const container = document.getElementById('missedHistoryList');
                if (!container) return;

                container.innerHTML = ''; // Clear old content

                const missed = json.logs.filter(l => l.status === 'missed');
                if (missed.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">‚úÖ No missed doses recorded!</p>`;
                    return;
                }

                missed.forEach(log => {
                    const logTime = new Date(log.takenAt).toLocaleString();
                    const item = document.createElement('div');
                    item.className = 'missed-entry';
                    item.innerHTML = `
            <div><strong>${log.medicineName}</strong> (${log.medicineId || 'N/A'})</div>
            <div>Status: ‚ùå Missed</div>
            <div>Date: ${logTime}</div>
        `;
                    container.appendChild(item);
                });
            }

            function renderMissedDoseHistoryTable() {
                const tbody = document.querySelector('#edHistoryTable tbody');
                if (!tbody) return;

                const missedLogs = doseLogs
                    .filter(log => log.status === 'missed')
                    .sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt));

                tbody.innerHTML = '';

                if (missedLogs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="padding:8px; color:#aaa;">‚úÖ No missed doses logged yet.</td></tr>`;
                    return;
                }

                missedLogs.forEach(log => {
                    const date = new Date(log.takenAt);
                    tbody.innerHTML += `
            <tr style="border-bottom:1px solid rgba(255,179,71,0.1);">
                <td style="padding:8px;">${date.toLocaleDateString()}</td>
                <td style="padding:8px;">${log.medicineName}</td>
                <td style="padding:8px; color:#eb4d4b;">‚ùå Missed</td>
                <td style="padding:8px;">${date.toLocaleString()}</td>
            </tr>
        `;
                });
            }
            function createStars(count = 100) {
                const overlay = document.getElementById("starOverlay");
                overlay.innerHTML = ""; // clear previous stars
                for (let i = 0; i < count; i++) {
                    const star = document.createElement("div");
                    star.classList.add("star");
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.setProperty("--s", `${Math.random() * 3 + 1}px`);
                    star.style.setProperty("--d", `${2 + Math.random() * 2}s`);
                    overlay.appendChild(star);
                }
            }

            function startWitchFlight() {
                const witch = document.getElementById("flyingWitch");
                const stars = document.getElementById("starOverlay");

                // ‚ú® Create and show stars
                createStars(120);
                stars.style.display = "block";
                requestAnimationFrame(() => stars.style.opacity = "1");

                // üßô‚Äç‚ôÄÔ∏è Trigger witch flight animation
                witch.classList.add("fly");

                // üåü Hide stars and reset witch after flight
                setTimeout(() => {
                    witch.classList.remove("fly");
                    stars.style.opacity = "0";
                    setTimeout(() => stars.style.display = "none", 600);
                }, 4000); // match animation duration
            }

            document.getElementById("startFlight").addEventListener("click", startWitchFlight);


            // ‚ú® Flying witch animation remains unchanged
            (function () {
                // REPLACE lines 2490-2519 with this consolidated safe handler
                document.getElementById("startFlight").addEventListener("click", function () {
                    document.getElementById("witchSound").currentTime = 0;
                    document.getElementById("witchSound").play().catch(err => console.log("Audio play blocked:", err));

                    const witch = document.getElementById("flyingWitch");
                    const stars = document.getElementById("starOverlay");
                    const broom = document.getElementById("witchSound");

                    // guard: don't re-trigger while already flying
                    if (witch.classList.contains("fly")) return;

                    // pause tutorial audio if playing (avoid overlap)
                    if (window.tutorialAudio && !window.tutorialAudio.paused) {
                        try { window.tutorialAudio.pause(); window.tutorialAudio.currentTime = 0; } catch (e) { }
                    }

                    // Reset / show stars
                    witch.style.display = "none";
                    witch.classList.remove("fly");
                    stars.style.display = "none";
                    stars.style.opacity = "0";
                    stars.style.display = "block";
                    requestAnimationFrame(() => (stars.style.opacity = "1"));

                    // Start flight after a short delay
                    setTimeout(() => {
                        witch.style.display = "block";

                        // play broom SFX (safe)
                        if (broom) {
                            try { broom.currentTime = 0; broom.play().catch(() => { }); } catch (e) { }
                        }

                        // start flying animation
                        witch.classList.add("fly");

                        // cleanup after animation ends
                        witch.addEventListener("animationend", () => {
                            witch.classList.remove("fly");
                            stars.style.opacity = "0";
                            setTimeout(() => (stars.style.display = "none"), 800);
                        }, { once: true });

                    }, 200);
                });

            })();
        </script>
</body>

</html>
