<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemist's Grand Grimoire</title>
    <style>
        #startFlight {
            background: linear-gradient(135deg, #7c3aed, #9333ea);
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 28px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.6);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 99999;
            margin: 20px auto;
            display: block;
        }

        #startFlight:hover {
            transform: scale(1.08);
            box-shadow: 0 0 25px rgba(167, 139, 250, 0.9);
        }

        .missed-btn {
            background-color: #e74c3c;
            color: #fff;
            border: none;
            padding: 6px 12px;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.2s;
        }

        .missed-btn:hover {
            background-color: #c0392b;
        }

        #flyingWitch {
            position: absolute;
            top: 350px;
            left: -150px;
            width: 80px;
            z-index: 9999;
            pointer-events: none;
            transform: translateX(0);
            opacity: 0;
        }

        #flyingWitch img {
            width: 100px;
            height: auto;
        }

        #flyingWitch.fly {
            animation: flyAcross 4s linear forwards;
            opacity: 1;
        }

        @keyframes flyAcross {
            0% {
                transform: translateX(-300px) translateY(0) rotate(0deg);
                /* 🪄 start far left */
                opacity: 1;
            }

            30% {
                transform: translate(300px, -100px) rotate(-5deg);
            }

            60% {
                transform: translate(600px, -250px) rotate(0deg);
            }

            100% {
                transform: translateX(120vw) translateY(-10vh) rotate(10deg);
                opacity: 0.9;
            }
        }

        #starOverlay .star {
            position: absolute;
            width: var(--s, 2px);
            height: var(--s, 2px);
            border-radius: 50%;
            background: radial-gradient(circle, #ffffff 0%, #ffd700 60%, rgba(255, 200, 0, 0) 100%);
            box-shadow: 0 0 calc(var(--s, 2px) * 6) rgba(255, 200, 80, 0.9);
            transform-origin: center;
            opacity: 0;
            animation: starTwinkle var(--d, 2.8s) ease-in-out infinite;
        }

        @keyframes starTwinkle {
            0% {
                opacity: 0;
                transform: scale(0.6);
            }

            40% {
                opacity: 1;
                transform: scale(1.0);
            }

            80% {
                opacity: 0.6;
                transform: scale(0.9);
            }

            100% {
                opacity: 0;
                transform: scale(0.6);
            }
        }

        @keyframes fall {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(80vh) scale(0.2);
                opacity: 0;
            }
        }

        #startGuideBtn {
            display: block;
            margin: 30px auto;
            padding: 14px 40px;
            font-size: 1.4rem;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(135deg, #7c3aed, #a855f7, #9333ea);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.7);
            position: relative;
            overflow: hidden;
            z-index: 10;
            animation: pulseGlow 3s infinite ease-in-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #startGuideBtn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 30px rgba(167, 139, 250, 0.95);
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(167, 139, 250, 0.8);
            }

            50% {
                box-shadow: 0 0 35px rgba(192, 132, 252, 1);
            }
        }

        .tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 8, 25, 0.3);
            backdrop-filter: blur(2px);
            z-index: 12000;
            pointer-events: none;
            transition: background 0.4s ease;
        }

        .t-spotlight {
            position: absolute;
            border-radius: 16px;
            box-shadow: 0 0 0 9999px rgba(15, 8, 25, 0.3), 0 0 25px rgba(255, 179, 71, 0.9);
            border: 3px solid rgba(255, 200, 100, 0.95);
            transition: all 0.4s cubic-bezier(.2, .8, .2, 1);
            pointer-events: none;
            z-index: 12010;
        }

        .tutorial-widget {
            position: absolute;
            z-index: 12020;
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            max-width: 480px;
            padding: 12px;
            background: rgba(20, 10, 35, 0.85);
            border: 2px solid rgba(255, 179, 71, 0.4);
            border-radius: 16px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.6);
            transform-origin: top left;
            backdrop-filter: blur(8px);
            animation: fadeInWidget 0.6s ease forwards;
        }

        @keyframes fadeInWidget {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #floatingWitch {
            position: fixed;
            bottom: 40px;
            left: 40px;
            z-index: 15000;
            animation: floatWitch 4s ease-in-out infinite;
            pointer-events: none;
        }

        #floatingWitch img {
            width: 140px;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.6));
        }

        @keyframes floatWitch {

            0%,
            100% {
                transform: translateY(-10px) rotate(-4deg);
            }

            50% {
                transform: translateY(10px) rotate(4deg);
            }
        }

        #floatingWitch {
            position: fixed;
            bottom: 40px;
            left: 40px;
            z-index: 15000;
            pointer-events: none;
            transition: all 1s ease-in-out;
        }

        #floatingWitch img {
            width: 140px;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.6));
            animation: floatWitch 4s ease-in-out infinite;
        }

        @keyframes floatWitch {

            0%,
            100% {
                transform: translateY(-10px) rotate(-4deg);
            }

            50% {
                transform: translateY(10px) rotate(4deg);
            }
        }

        .tutorial-widget {
            position: absolute;
            z-index: 12020;
            max-width: 420px;
            background: rgba(25, 15, 45, 0.92);
            padding: 16px;
            border-radius: 16px;
            border: 2px solid rgba(255, 200, 100, 0.5);
            color: #f5e6c9;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            transform: translate(-50%, -50%);
            transition: top 0.8s ease, left 0.8s ease;
        }

        .tutorial-title {
            font-size: 1.4rem;
            color: #ffb347;
            margin-bottom: 6px;
        }

        .tutorial-progress {
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .tutorial-text {
            font-size: 1rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .tutorial-controls {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .tutorial-controls .btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tutorial-controls .btn.btn-primary {
            background: linear-gradient(45deg, #ffb347, #ff6b6b);
            color: #2d1b3d;
        }

        .tutorial-controls .btn:hover {
            transform: scale(1.05);
        }

        #floatingWitch {
            position: fixed;
            bottom: 40px;
            left: 40px;
            z-index: 99999;
            display: none;
            pointer-events: none;
            transition: left 5s cubic-bezier(.2, .9, .25, 1), top 0.8s cubic-bezier(.2, .9, .25, 1), opacity 0.3s;
        }

        #floatingWitch img {
            width: 140px;
            max-width: 32vw;
            filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.6));
            animation: floatIdle 4s ease-in-out infinite;
        }

 @keyframes floatIdle {

            0%,
            100% {
                transform: translateY(-6px) rotate(-2deg);
            }

            50% {
                transform: translateY(6px) rotate(2deg);
            }
        }

        .wizard-container {
            position: fixed;
            z-index: 99999;
            right: 40px;
            top: 30%;
            max-width: 420px;
            background: linear-gradient(135deg, rgba(40, 18, 50, 0.98), rgba(28, 12, 40, 0.98));
            border: 2px solid rgba(255, 179, 71, 0.18);
            color: #f4e4c1;
            padding: 14px;
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
            display: none;
            transition: top 0.6s ease, right 0.6s ease, opacity 0.3s;
            opacity: 0;
            pointer-events: auto;
            font-family: 'Georgia', serif;
        }

        .wizard-container.visible {
            display: block;
            opacity: 1;
        }

        .wizard-title {
            font-size: 1.2rem;
            color: #ffb347;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .wizard-progress {
            font-size: 0.9rem;
            color: #e6d3a3;
            margin-bottom: 8px;
        }

        .wizard-text {
            font-size: 1rem;
            color: #e6d3a3;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .wizard-controls {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .wizard-controls .btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .wizard-controls .btn-primary {
            background: linear-gradient(45deg, #ffb347, #ff6b6b);
            color: #2d1b3d;
        }

        .sparkle {
            position: fixed;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #fff, #ffb347);
            border-radius: 50%;
            animation: sparkleFly 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkleFly {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            to {
                opacity: 0;
                transform: scale(0) translateY(-120px) rotate(360deg);
            }
        }

        @keyframes witchEntry {
            0% {
                transform: translate(-300px, 300px) scale(0) rotate(-360deg);
                opacity: 0;
            }

            60% {
                transform: translate(50px, -30px) scale(1.2) rotate(15deg);
                opacity: 1;
            }

            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
        }

        #floatingWitch.show-entry img {
            animation: witchEntry 2.5s ease-out forwards;
        }


        #floatingWitch.show-entry img {
            animation: witchEntry 5s cubic-bezier(.25, 1.3, .45, 1) forwards;
        }

        @media (max-width:720px) {
            .wizard-container {
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                top: 12%;
                max-width: 92vw;
            }

            #floatingWitch img {
                width: 110px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #4a1c40 0%, #2d1b3d 50%, #1a0f2e 100%);
            color: #f4e4c1;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 70%, rgba(255, 105, 180, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
            border-radius: 20px;
            border: 2px dashed #ffb347;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 20px;
            font-size: 24px;
            animation: sparkle 2s infinite;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -10px;
            right: 20px;
            font-size: 24px;
            animation: sparkle 2s infinite 1s;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .header h1 {
            font-size: 3rem;
            color: #ffb347;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            font-style: italic;
            color: #e6d3a3;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 5px;
        }

        .nav-tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: #f4e4c1;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            margin: 0 5px;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #ffb347, #ff6b6b);
            color: #2d1b3d;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 179, 71, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 179, 71, 0.2);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 179, 71, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 179, 71, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffb347;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 179, 71, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #f4e4c1;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ffb347;
            box-shadow: 0 0 10px rgba(255, 179, 71, 0.3);
        }

        .btn {
            padding: 5px 5px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ffb347);
            color: #2d1b3d;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .medicine-list {
            display: grid;
            gap: 20px;
        }

        .medicine-item {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #ffb347;
            position: relative;
            transition: all 0.3s ease;
        }

        .medicine-item:hover {
            background: rgba(0, 0, 0, 0.8);
            border-left-color: #ff6b6b;
        }

        .medicine-item h3 {
            color: #ffb347;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .medicine-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: rgba(255, 179, 71, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #ffb347;
            font-weight: bold;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }


        .stat-card {
            background: linear-gradient(135deg, rgba(255, 179, 71, 0.1), rgba(255, 107, 107, 0.1));
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 179, 71, 0.3);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: #ffb347;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #e6d3a3;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .chart {
            width: 100%;
            height: 300px;
            background: rgba(255, 179, 71, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ffb347;
        }

        .upcoming-doses {
            max-height: 400px;
            overflow-y: auto;
        }

        .dose-item {
            background: rgba(255, 179, 71, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ffb347;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dose-time {
            font-weight: bold;
            color: #ffb347;
        }

        .dose-medicine {
            color: #e6d3a3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffb347);
            color: #2d1b3d;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.8s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.fade-out {
            opacity: 0;
        }


        .mystic-fortune {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(255, 105, 180, 0.2));
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .fortune-text {
            font-size: 1.3rem;
            font-style: italic;
            color: #e6d3a3;
            margin-bottom: 15px;
        }

        .fortune-crystal {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .wellness-rate {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .wellness-excellent {
            color: #4ecdc4;
        }

        .wellness-good {
            color: #45b7d1;
        }

        .wellness-fair {
            color: #f9ca24;
        }

        .wellness-poor {
            color: #f0932b;
        }

        .wellness-critical {
            color: #eb4d4b;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎪 Alchemist's Grand Grimoire 🎪</h1>

            <div id="flyingWitch">
                <img src="18fe33bb-e7da-451a-ac22-5c3ee5bfdd63.png" alt="Flying Witch">
            </div>

            <div id="starOverlay"></div>

            <audio id="witchSound" src="witch-sound.mp3" preload="auto"></audio>

            <div id="floatingWitch" aria-hidden="true" style="display:none;">
                <img src="witch.png" alt="Witch Guide">
            </div>

            <button id="startGuideBtn" style="display:none">Start Tutorial</button>

            <div id="wizardTutorial" class="wizard-container" aria-hidden="true" style="display:none;">
                <div class="wizard-title" id="wizardTitle">Welcome</div>
                <div class="wizard-progress" id="wizardProgress">Step 1 / 15</div>
                <div class="wizard-text" id="wizardText">…</div>

                <div class="wizard-controls" style="margin-top:8px;">
                    <button id="wizardPrev" class="btn">Previous</button>
                    <button id="wizardNext" class="btn btn-primary">Next</button>
                    <button id="wizardSkip" class="btn">Skip</button>
                </div>
            </div>

        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('schedule')">📋 Schedule Potions</button>
            <button class="nav-tab" onclick="switchTab('userDashboard')">📅 User Dashboard</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">📊 Wellness Dashboard</button>
            <button class="nav-tab" onclick="switchTab('streakTab')">🔥 Streak</button>

            <div id="clock" style="
              position: fixed;
              top: 20px;
              right: 20px;
              background:black;
              padding: 10px 20px;
              border-radius: 15px;
              font-size: 1.2rem;
              color: #ffb347;
              font-weight: bold;
              box-shadow: 0 5px 15px rgba(3, 3, 3, 0.3);
              z-index: 1000;
              "></div>
        </div>

        <div id="schedule" class="tab-content active">
            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">🧪 Brew New Elixir Schedule</h2>
                <form id="medicineForm">
                    <div class="form-group">
                        <label for="medicineName">🧴 Potion Name:</label>
                        <input type="text" id="medicineName" required placeholder="e.g., flyingpotion">
                    </div>
                    <div class="form-group">
                        <label for="email">📧 User Email:</label>
                        <input type="email" id="email" required placeholder="e.g., user@example.com">
                    </div>

                    <div class="form-group">
                        <label for="dosage">📏 Dosage:</label>
                        <input type="text" id="dosage" required placeholder="e.g., 500 mg">
                    </div>

                    <div class="form-group">
                        <label for="time">⏰ First Dose Time:</label>
                        <input type="time" id="time" required>
                    </div>

                    <div class="form-group">
                        <label for="frequency">📅 Frequency:</label>
                        <select id="frequency" required>
                            <option value="">Select frequency</option>
                            <option value="onceDaily">Once a day</option>
                            <option value="twiceDaily">Twice a day (every 12 hrs)</option>
                            <option value="every8h">Every 8 hours</option>
                            <option value="everyOtherDay">Every other day</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="duration">🗓️ Duration:</label>
                        <input type="number" id="duration" required min="1" max="365" placeholder="e.g., 7 days">
                    </div>

                    <button type="submit" class="btn btn-primary">➕ Add Medication</button>
                </form>

            </div>

            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">📜 Current Elixir Schedules</h2>
                <div id="medicineList" class="medicine-list"></div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="mystic-fortune">
                <div class="fortune-crystal">🔮</div>
                <div class="wellness-rate" id="wellnessRate">Calculating Wellness Rate...</div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMedicines">0</div>
                    <div class="stat-label">Active Elixirs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDosesToday">0</div>
                    <div class="stat-label">Total Doses Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="takenToday">0</div>
                    <div class="stat-label">Taken Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="missedToday">0</div>
                    <div class="stat-label">Missed Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adherenceRate">0%</div>
                    <div class="stat-label">Adherence Rate</div>
                </div>
            </div>


            <div class="card" id="predictionCard" style="margin-bottom:20px;">
                <h3 style="color: #ffb347; margin-bottom: 12px;">🤖 Adherence Predictions & Risk</h3>
                <div id="predictionPanel">
                    <p style="color:#e6d3a3;">Analyzing adherence patterns...</p>
                </div>
            </div>

            <div class="card" id="enhancedControls" style="margin-bottom:20px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <label style="color:#e6d3a3;">Range:
                        <select id="edRangeSelect">
                            <option value="7">Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="custom">Custom</option>
                        </select>
                    </label>

                    <label id="customRangeInputs" style="display:none; color:#e6d3a3;">
                        From: <input type="date" id="edFrom"> To: <input type="date" id="edTo">
                    </label>

                    <label style="color:#e6d3a3;">Medicine:
                        <select id="edMedicineFilter">
                            <option value="">All</option>
                        </select>
                    </label>

                    <button class="btn btn-primary" id="edApplyBtn">Apply</button>
                    <button class="btn" id="edRefreshBtn">Refresh</button>
                    <button class="btn btn-danger" id="edExportBtn">Export CSV</button>
                </div>
            </div>

            <div class="card" id="missedHistoryCard" style="margin-bottom:20px;">
                <h3 style="color:#ffb347; margin-bottom:10px;">🗂 Missed Dose History</h3>
                <div style="overflow:auto; max-height:260px;">
                    <table id="edHistoryTable" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom:1px solid rgba(255,179,71,0.2);">
                                <th style="padding:8px;">Date</th>
                                <th style="padding:8px;">Medicine</th>
                                <th style="padding:8px;">Status</th>
                                <th style="padding:8px;">Logged At</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>


            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">📈 Adherence Trends Over Time</h3>
                <canvas id="adherenceChartMain"></canvas>

            </div>

            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">📊 Missed vs Taken Doses</h3>
                <canvas id="missedVsTakenChart"
                    style="max-width: 250px; max-height: 250px; margin: 0 auto; display: block;"></canvas>

            </div>

            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">📉 Adherence Progress Over 30 Days</h3>
                <canvas id="trendLineChart"></canvas>
            </div>


            <div class="card">
                <h3 style="color: #ffb347; margin-bottom: 15px;">⏰ Upcoming Performances</h3>
                <div id="upcomingDoses" class="upcoming-doses"></div>
            </div>

        </div>


        <div id="userDashboard" class="tab-content">
            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">📅 Upcoming Reminders</h2>
                <div id="upcomingRemindersList"></div>
            </div>

            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">📜 Past Reminders</h2>
                <button class="btn btn-danger" onclick="clearPastReminders()">🗑️ Clear All Past Reminders</button>
                <div id="pastRemindersList" style="margin-top: 15px;"></div>
            </div>

        </div>

        <div id="streakTab" class="tab-content">
            <div class="card">
                <h2 style="color:#ffb347; margin-bottom:20px;">🔥 Streak Performance</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="currentStreak">0 days</div>
                        <div class="stat-label">Current Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="longestStreak">0 days</div>
                        <div class="stat-label">Longest Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDaysTracked">0</div>
                        <div class="stat-label">Total Days Tracked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="perfectDays">0</div>
                        <div class="stat-label">Perfect Adherence Days</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="color: #ffb347; margin-bottom: 15px;">📅 Streak Trend Over Time</h3>
                    <canvas id="streakTrendChart"></canvas>
                </div>
            </div>
        </div>

        <div id="notification" class="notification">
            <span id="notificationText"></span>
            <button id="snoozeBtn"
                style="display:none; margin-left:10px; padding:5px 10px; border:none; border-radius:5px; background:#4ecdc4; color:#fff; cursor:pointer;">
                Snooze 15 min
            </button>
        </div>
        <div id="tutorialRoot" style="display:none">
            <div class="tutorial-overlay" id="tutorialOverlay">
                <div class="tutorial-backdrop"></div>
                <div id="tSpotlight" class="t-spotlight" style="display:none"></div>
            </div>

            <div id="tutorialWidget" class="tutorial-widget" style="display:none" aria-hidden="false">
                <div class="witch-frame" id="wizardWitch">
                    <img id="wizardWitchImg" src="" alt="Witch"
                        style="width:100%; height:auto; display:block; filter: drop-shadow(0 6px 18px rgba(0,0,0,0.6));">
                </div>

                <div class="tutorial-box" id="tutorialBox">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="tutorial-title" id="tutorialTitle">Welcome</div>
                            <div class="tutorial-progress" id="tutorialProgress">Step 1 / 1</div>
                        </div>
                    </div>
                    <div class="tutorial-text" id="tutorialText">…</div>
                    <div class="tutorial-hint" id="tutorialHint" style="display:none"></div>
                    <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                        <div class="tutorial-controls">
                            <button id="tutorialPrev" class="btn">Previous</button>
                            <button id="tutorialNext" class="btn btn-primary">Next</button>
                            <button id="tutorialSkip" class="btn">Skip</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>

                const DEFAULT_EMAIL = "thakur29aayush@example.com";

                function getUserEmail() {
                    return (document.getElementById("email")?.value || "").trim() || DEFAULT_EMAIL;
                }

                let medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                let doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                let currentEditingId = null;
                let notificationTimeout = null;
                let adherenceChartInstance = null;

                function persistMedicines() {
                    localStorage.setItem("medicines", JSON.stringify(medicines || []));
                }

                function persistDoseLogs() {
                    localStorage.setItem("doseLogs", JSON.stringify(doseLogs || []));
                }

                function nowISO() {
                    return new Date().toISOString();
                }

                function startOfDay(d) { const x = new Date(d); x.setHours(0, 0, 0, 0); return x; }
                function endOfDay(d) { const x = new Date(d); x.setHours(23, 59, 59, 999); return x; }

                document.addEventListener("DOMContentLoaded", () => {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");

                    attachEventHandlers();
                    renderAll();
                    setTimeout(renderAll, 300);
                });
                
 function attachEventHandlers() {
                    const medForm = document.getElementById("medicineForm");
                    if (medForm) medForm.addEventListener("submit", medicineFormSubmit);
                    document.getElementById("edApplyBtn")?.addEventListener("click", () => {
                        updateDashboard();
                        setTimeout(renderMissedDoseHistoryTable, 250);
                    });
                    document.getElementById("edRefreshBtn")?.addEventListener("click", () => {
                        renderAll();
                        showNotification("🔄 Refreshed all components");
                    });
                    document.getElementById("edExportBtn")?.addEventListener("click", exportMissedHistoryCSV);
                    const rangeSelect = document.getElementById("edRangeSelect");
                    if (rangeSelect) {
                        rangeSelect.addEventListener("change", (e) => {
                            const val = e.target.value;
                            document.getElementById("customRangeInputs").style.display = val === "custom" ? "inline-block" : "none";
                        });
                    }
                    document.getElementById("startFlight")?.addEventListener("click", startWitchFlight);
                }

                async function medicineFormSubmit(e) {
                    e.preventDefault();
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const form = e.target;
                    const name = (document.getElementById("medicineName")?.value || "").trim();
                    const email = getUserEmail();
                    const dosage = (document.getElementById("dosage")?.value || "").trim();
                    const time = (document.getElementById("time")?.value || "09:00").trim();
                    const frequency = (document.getElementById("frequency")?.value || "onceDaily");
                    const duration = parseInt(document.getElementById("duration")?.value || "0", 10) || 0;
                    const formData = {
                        id: currentEditingId || Date.now().toString(),
                        name,
                        email,
                        dosage,
                        time,
                        frequency,
                        duration,
                        startDate: (new Date()).toISOString().split("T")[0],
                        createdAt: nowISO()
                    };
                    if (currentEditingId) {
                        const idx = medicines.findIndex(m => m.id === currentEditingId);
                        if (idx !== -1) {
                            medicines[idx] = { ...medicines[idx], ...formData }; // <-- correct spread merge
                            showNotification("🧪 Elixir updated");
                        } else {
                            medicines.push(formData);
                            showNotification("➕ Elixir added (fallback)");
                        }
                        currentEditingId = null;
                    } else {
                        medicines.push(formData);
                        showNotification("➕ Elixir added");
                    }
                    persistMedicines();
                    form.reset();
                    renderAll();
                    try {
                        fetch("http://localhost:3000/addSchedule", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(formData) })
                            .then(() => console.log("server sync attempted"));
                    } catch (e) { console.warn("Server sync error", e); }
                }

                function renderMedicines() {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    const container = document.getElementById("medicineList");
                    if (!container) return;
                    if (!medicines.length) {
                        container.innerHTML = `<div style="text-align:center;color:#e6d3a3;padding:30px;">No elixirs yet. Add one above.</div>`;
                        return;
                    }
                    container.innerHTML = medicines.map(m => `
    <div class="medicine-item">
      <h3>🧪 ${escapeHtml(m.name)}</h3>
      <div class="medicine-details">
        <div class="detail-item"><span class="detail-label">Dosage:</span> ${escapeHtml(m.dosage)}</div>
        <div class="detail-item"><span class="detail-label">Time:</span> ${formatTime(m.time || "09:00")}</div>
        <div class="detail-item"><span class="detail-label">Frequency:</span> ${escapeHtml(m.frequency)}</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="editMedicine('${m.id}')">✏️ Edit</button>
        <button class="btn btn-danger" onclick="deleteMedicine('${m.id}')">🗑️ Remove</button>
        <button class="btn btn-primary" onclick="markAsTaken('${m.id}')">✅ Mark Taken</button>
        <button class="missed-btn" onclick="markAsMissed('${m.id}')">❌ Mark Missed</button>
      </div>
    </div>
  `).join("");
                }

                function editMedicine(id) {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    const med = medicines.find(m => m.id === id);
                    if (!med) { showNotification("⚠️ Not found"); return; }
                    document.getElementById("medicineName").value = med.name;
                    document.getElementById("dosage").value = med.dosage;
                    document.getElementById("time").value = med.time;
                    document.getElementById("frequency").value = med.frequency;
                    document.getElementById("duration").value = med.duration || 0;
                    currentEditingId = id;
                    switchTab('schedule');
                    showNotification("✏️ Edit ready");
                }

                function deleteMedicine(id) {
                    if (!confirm("Remove this elixir?")) return;
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    medicines = medicines.filter(m => m.id !== id);
                    persistMedicines();
                    renderAll();
                    showNotification("🗑️ Elixir removed");
                }

                function escapeHtml(s) {
                    return String(s || "").replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
                }

                async function markAsTaken(id) {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const med = medicines.find(m => m.id === id);
                    if (!med) { showNotification("⚠️ Elixir not found"); return; }
                    const today = new Date().toDateString();
                    const alreadyLogged = doseLogs.some(
                        l => l.medicineId === id && new Date(l.takenAt).toDateString() === today && l.status === "taken"
                    );
                    if (alreadyLogged) {
                        showNotification("⚠️ Already logged today");
                        return;
                    }
                    const log = {
                        id: "log_" + Math.random().toString(36).slice(2, 10),
                        medicineId: id,
                        medicineName: med.name,
                        email: getUserEmail(),
                        status: "taken",
                        takenAt: new Date().toISOString(),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        synced: false
                    };
                    doseLogs.push(log);
                    localStorage.setItem("doseLogs", JSON.stringify(doseLogs));
                    const btn = document.getElementById(`takenBtn_${id}`);
                    if (btn) btn.disabled = true;
                    try {
                        const res = await fetch("http://localhost:3000/sendEmail", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                email: getUserEmail(),
                                medicineName: med.name,
                                status: "taken",
                                time: new Date().toLocaleTimeString(),
                            }),
                        });
                        const result = await res.json();
                        if (res.ok && result.success) {
                            showNotification(`✅ ${med.name} marked taken & email sent`);
                        } else {
                            showNotification(`⚠️ ${med.name} marked taken but email failed`);
                        }
                    } catch (err) {
                        console.error("❌ Failed to send taken email:", err);
                        showNotification(`⚠️ ${med.name} marked taken but email failed`);
                    }
                    try { renderMissedDoseHistoryTable(); } catch (e) { }
                    try { updateDashboard(); } catch (e) { }
                    try {
                        await fetch("http://localhost:3000/logDose", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(log)
                        });
                    } catch (err) {
                        console.warn("Server sync failed for taken:", err);
                    }
                }

                function calculateDailyAdherence(dateObj = new Date()) {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const target = startOfDay(dateObj);
                    let totalDoses = 0;
                    medicines.forEach(med => {
                        const startDate = startOfDay(new Date(med.startDate || med.createdAt || new Date()));
                        const duration = parseInt(med.duration || 0, 10);
                        let endDate = med.endDate ? startOfDay(new Date(med.endDate)) : null;
                        if (!endDate && duration > 0) { endDate = new Date(startDate); endDate.setDate(endDate.getDate() + duration - 1); }
                        if (target < startDate) return;
                        if (endDate && target > endDate) return;
                        switch (med.frequency) {
                            case "onceDaily": totalDoses += 1; break;
                            case "twiceDaily": totalDoses += 2; break;
                            case "every8h": totalDoses += 3; break;
                            case "everyOtherDay": {
                                const daysSinceStart = Math.floor((target - startDate) / (1000 * 60 * 60 * 24));
                                if (daysSinceStart % 2 === 0) totalDoses += 1;
                                break;
                            }
                            case "weekly": {
                                if (startDate.getDay() === target.getDay()) totalDoses += 1;
                                break;
                            }
                            default: totalDoses += 1;
                        }
                    });
                    const dateStr = target.toDateString();
                    const takenToday = doseLogs.filter(l => new Date(l.takenAt).toDateString() === dateStr && l.status === "taken").length;
                    const missedToday = doseLogs.filter(l => new Date(l.takenAt).toDateString() === dateStr && l.status === "missed").length;
                    const adherenceRate = totalDoses > 0 ? Math.round((takenToday / totalDoses) * 100) : 0;
                    return { totalDoses, takenToday, missedToday, adherenceRate };
                }

                function calculateStreak() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const dates = {};
                    doseLogs.forEach(log => {
                        const d = new Date(log.takenAt).toDateString();
                        if (!dates[d]) dates[d] = { taken: 0, missed: 0, total: 0 };
                        if (log.status === "taken") dates[d].taken++;
                        if (log.status === "missed") dates[d].missed++;
                        dates[d].total++;
                    });
                    let streak = 0;
                    let day = startOfDay(new Date());
                    while (true) {
                        const key = day.toDateString();
                        if (!dates[key]) break;
                        if (dates[key].missed > 0 || dates[key].taken < dates[key].total) break;
                        streak++;
                        day.setDate(day.getDate() - 1);
                    }
                    return streak;
                }

                function updateDashboard() {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const today = new Date();
                    const { totalDoses, takenToday, missedToday, adherenceRate } = calculateDailyAdherence(today);
                    document.getElementById("totalDosesToday").textContent = totalDoses;
                    document.getElementById("takenToday").textContent = takenToday;
                    document.getElementById("missedToday").textContent = missedToday;
                    document.getElementById("adherenceRate").textContent = totalDoses > 0 ? `${adherenceRate}%` : "N/A";
                    document.getElementById("totalMedicines").textContent = medicines.length;
                    updateWellnessRate(adherenceRate);
                    updateAdherencePredictionAndRisk();
                    try { renderAdherenceChart(); } catch (e) { console.warn(e); }
                    try { renderMissedVsTakenChart(); } catch (e) { console.warn(e); }
                    try { renderTrendLineChart(); } catch (e) { console.warn(e); }
                    try { renderMissedDoseHistoryTable(); } catch (e) { console.warn(e); }
                    try { updateUpcomingDoses(); } catch (e) { console.warn(e); }
                    try { renderUserDashboard(); } catch (e) { console.warn(e); }
                }

                function updateWellnessRate(rate) {
                    const el = document.getElementById("wellnessRate");
                    if (!el) return;
                    let text = "", cls = "";
                    if (rate >= 90) { text = "✨ Excellent Wellness ✨"; cls = "wellness-excellent"; }
                    else if (rate >= 75) { text = "🌟 Good Wellness 🌟"; cls = "wellness-good"; }
                    else if (rate >= 50) { text = "⚡ Fair Wellness ⚡"; cls = "wellness-fair"; }
                    else if (rate >= 25) { text = "⚠️ Poor Wellness ⚠️"; cls = "wellness-poor"; }
                    else { text = "🚨 Critical Wellness 🚨"; cls = "wellness-critical"; }
                    el.textContent = text;
                    el.className = `wellness-rate ${cls}`;
                }

                function updateAdherencePredictionAndRisk() {
                    const panel = document.getElementById("predictionPanel"); if (!panel) return;
                    let total = 0, counted = 0;
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(); d.setDate(d.getDate() - i);
                        const { adherenceRate } = calculateDailyAdherence(d);
                        total += adherenceRate; counted++;
                    }
                    const avg7 = counted > 0 ? total / counted : 0;
                    let riskText = "", riskLevel = "";
                    if (avg7 >= 90) { riskText = "🧙‍♂️ Excellent adherence trend!"; riskLevel = "🟢 Low Risk"; }
                    else if (avg7 >= 70) { riskText = "✨ Mostly consistent adherence."; riskLevel = "🟡 Moderate Risk"; }
                    else if (avg7 >= 50) { riskText = "⚠️ Adherence is slipping."; riskLevel = "🟠 High Risk"; }
                    else { riskText = "🚨 Severe adherence risk!"; riskLevel = "🔴 Critical"; }
                    const prediction = Math.max(0, Math.min(100, avg7 - 2));
                    panel.innerHTML = `
    <p>${riskText}</p>
    <p><strong>Risk Level:</strong> ${riskLevel}</p>
    <p><strong>7-day Avg Adherence:</strong> ${avg7.toFixed(1)}%</p>
    <p><strong>Predicted Next Week:</strong> ${prediction.toFixed(1)}%</p>
  `;
                }

                function renderAdherenceChart() {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const el = document.getElementById("adherenceChartMain"); if (!el) return;
                    const ctx = el.getContext("2d");
                    const labels = [], data = [];
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date(); d.setDate(d.getDate() - i);
                        const { totalDoses } = calculateDailyAdherence(d);
                        const dayStr = d.toDateString();
                        const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === dayStr && l.status === "taken").length;
                        const rate = totalDoses > 0 ? Math.round((taken / totalDoses) * 100) : 0;
                        labels.push(d.toLocaleDateString(undefined, { weekday: 'short' }));
                        data.push(rate);
                    }
                    if (adherenceChartInstance) adherenceChartInstance.destroy();
                    adherenceChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Adherence %', data, backgroundColor: 'rgba(255,179,71,0.6)', borderColor: '#ffb347', borderWidth: 2 }] },
                        options: { scales: { y: { beginAtZero: true, max: 100 } } }
                    });
                }

                function renderMissedVsTakenChart() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const el = document.getElementById("missedVsTakenChart"); if (!el) return;
                    const ctx = el.getContext("2d");
                    const today = new Date().toDateString();
                    const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === today && l.status === 'taken').length;
                    const missed = doseLogs.filter(l => new Date(l.takenAt).toDateString() === today && l.status === 'missed').length;
                    if (window.missedVsTakenChartInstance) window.missedVsTakenChartInstance.destroy();
                    window.missedVsTakenChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Taken', 'Missed'], datasets: [{ data: [taken, missed], backgroundColor: ['#4CAF50', '#F44336'] }] }, options: { plugins: { legend: { position: 'bottom' } } } });
                }

                function renderTrendLineChart() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const el = document.getElementById("trendLineChart"); if (!el) return;
                    const ctx = el.getContext("2d");
                    const labels = [], data = [];
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date(); d.setDate(d.getDate() - i);
                        const { totalDoses } = calculateDailyAdherence(d);
                        const dayStr = d.toDateString();
                        const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === dayStr && l.status === 'taken').length;
                        const rate = totalDoses > 0 ? Math.round((taken / totalDoses) * 100) : 0;
                        labels.push(d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                        data.push(rate);
                    }
                    if (window.trendLineChartInstance) window.trendLineChartInstance.destroy();
                    window.trendLineChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Daily Adherence %', data, borderColor: '#ffb347', backgroundColor: 'rgba(255,179,71,0.2)', fill: true, tension: 0.3 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } } } });
                }

                function renderMissedDoseHistoryTable() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    const tableBody = document.querySelector("#edHistoryTable tbody");
                    if (!tableBody) return;
                    const medFilter = document.getElementById("edMedicineFilter");
                    if (medFilter) {
                        const current = medFilter.value || "";
                        medFilter.innerHTML = `<option value="">All</option>` + medicines.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join("");
                        if (current) medFilter.value = current;
                    }
                    const selectedMed = document.getElementById("edMedicineFilter")?.value || "";
                    const range = document.getElementById("edRangeSelect")?.value || "7";
                    const fromVal = document.getElementById("edFrom")?.value;
                    const toVal = document.getElementById("edTo")?.value;
                    let from = fromVal ? startOfDay(new Date(fromVal)) : null;
                    let to = toVal ? endOfDay(new Date(toVal)) : null;
                    if (!from && !to && range !== "custom") {
                        to = endOfDay(new Date());
                        from = startOfDay(new Date());
                        from.setDate(to.getDate() - parseInt(range, 10) + 1);
                    }

                    let missed = doseLogs.filter(l => l.status === "missed");

                    missed = missed.filter(log => {
                        const med = medicines.find(m => m.id === log.medicineId);
                        if (!med) return false;
                        const startDate = startOfDay(new Date(med.startDate || med.createdAt || new Date()));
                        let endDate = med.endDate ? startOfDay(new Date(med.endDate)) : null;
                        if (!endDate && med.duration) {
                            endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + parseInt(med.duration, 10) - 1);
                        }
                        const logDate = startOfDay(new Date(log.takenAt));
                        if (logDate < startDate) return false;
                        if (endDate && logDate > endDate) return false;
                        return true;
                    });
                    if (selectedMed) missed = missed.filter(l => l.medicineId === selectedMed);
                    if (from) missed = missed.filter(l => new Date(l.takenAt) >= from);
                    if (to) missed = missed.filter(l => new Date(l.takenAt) <= to);
                    missed.sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt));
                    if (!missed.length) {
                        tableBody.innerHTML = `<tr><td colspan="4" style="padding:10px;text-align:center;color:#e6d3a3;">No missed doses found for the selected filters.</td></tr>`;
                        return;
                    }
                    tableBody.innerHTML = missed.map(m => `
        <tr>
            <td style="padding:8px;">${new Date(m.takenAt).toLocaleDateString()}</td>
            <td style="padding:8px;">${escapeHtml(m.medicineName)}</td>
            <td style="padding:8px;color:#e74c3c;font-weight:bold;">❌ Missed</td>
            <td style="padding:8px;">${new Date(m.takenAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
        </tr>
    `).join("");
                }

                function updateUpcomingDoses() {
                    const medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    const doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const container = document.getElementById("upcomingDoses");
                    if (!container) return;
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const LOG_WINDOW_MS = 2 * 60 * 60 * 1000; // 2 hours window
                    let upcoming = [];
                    medicines.forEach(med => {
                        const startDate = new Date(med.startDate || med.createdAt || now);
                        startDate.setHours(0, 0, 0, 0);
                        const duration = parseInt(med.duration || 0, 10);
                        let endDate = med.endDate ? new Date(med.endDate) : null;
                        if (!endDate && duration > 0) {
                            endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + duration - 1);
                        }
                        if (now < startDate || (endDate && now > endDate)) return;
                        const [h, min] = (med.time || "09:00").split(":").map(Number);
                        const dosesToday = [];
                        const base = new Date(todayStart.getTime());

                        if (med.frequency === "onceDaily") {
                            dosesToday.push(new Date(base.getTime() + h * 3600000 + min * 60000));
                        }
                        if (med.frequency === "twiceDaily") {
                            dosesToday.push(new Date(base.getTime() + h * 3600000 + min * 60000));
                            dosesToday.push(new Date(base.getTime() + (h + 12) * 3600000 + min * 60000));
                        }
                        if (med.frequency === "every8h") {
                            for (let i = 0; i < 24; i += 8) {
                                dosesToday.push(new Date(base.getTime() + (h + i) * 3600000 + min * 60000));
                            }
                        }
                        if (med.frequency === "everyOtherDay") {
                            const diffDays = Math.floor((todayStart - startDate) / (1000 * 60 * 60 * 24));
                            if (diffDays % 2 === 0) {
                                dosesToday.push(new Date(base.getTime() + h * 3600000 + min * 60000));
                            }
                        }
                        if (med.frequency === "weekly") {
                            const diffDays = Math.floor((todayStart - startDate) / (1000 * 60 * 60 * 24));
                            if (diffDays % 7 === 0) {
                                dosesToday.push(new Date(base.getTime() + h * 3600000 + min * 60000));
                            }
                        }
                        dosesToday.forEach(doseTime => {
                            const log = doseLogs.find(l =>
                                l.medicineId === med.id &&
                                Math.abs(new Date(l.takenAt) - doseTime) < LOG_WINDOW_MS
                            );
                            let status = "Upcoming";
                            if (log?.status === "taken") status = "✅ Taken";
                            else if (log?.status === "missed") status = "❌ Missed";
                            else if (now > doseTime) status = "❌ Missed"; // not logged & time passed
                            upcoming.push({
                                medicine: med.medicineName || med.name,
                                dosage: med.dosage,
                                time: doseTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
                                status
                            });
                        });
                    });
                    container.innerHTML = upcoming.length
                        ? upcoming
                            .sort((a, b) => (a.time > b.time ? 1 : -1))
                            .map(
                                d => `
        <div class="dose-item">
          <div>
            <div class="dose-time">${d.time}</div>
            <div class="dose-medicine">${d.medicine}</div>
            <div class="dose-dosage">${d.dosage || ""}</div>
          </div>
          <div class="dose-status">${d.status}</div>
        </div>  
         `
                            )
                            .join("")
                        : `<div style="color:#e6d3a3; text-align:center;">No doses scheduled today.</div>`;
                }

                function renderUserDashboard() {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const upcomingContainer = document.getElementById("upcomingRemindersList");
                    const pastContainer = document.getElementById("pastRemindersList");
                    if (!upcomingContainer || !pastContainer) return;
                    const now = new Date();
                    const todayStart = startOfDay(now);
                    const LOG_WINDOW_MS = 2 * 60 * 60 * 1000;
                    const upcoming = [];
                    medicines.forEach(med => {
                        const startDate = startOfDay(new Date(med.startDate || med.createdAt || new Date()));
                        const duration = parseInt(med.duration || 0, 10);
                        let endDate = med.endDate ? startOfDay(new Date(med.endDate)) : null;
                        if (!endDate && duration > 0) { endDate = new Date(startDate); endDate.setDate(endDate.getDate() + duration - 1); }
                        if (now < startDate || (endDate && now > endDate)) return;
                        const [h, min] = (med.time || "09:00").split(":").map(Number);
                        const makeDoseAt = (hourOffset = 0, dayOffset = 0) => {
                            const d = new Date(todayStart);
                            d.setDate(d.getDate() + dayOffset);
                            d.setHours(h + hourOffset, min, 0, 0);
                            return d;
                        };
                        let doses = [];
                        switch (med.frequency) {
                            case "onceDaily":
                                doses.push(makeDoseAt(0, 0));
                                break;
                            case "twiceDaily":
                                doses.push(makeDoseAt(0, 0), makeDoseAt(12, 0));
                                break;
                            case "every8h":
                                doses.push(makeDoseAt(0, 0), makeDoseAt(8, 0), makeDoseAt(16, 0));
                                break;
                            case "everyOtherDay": {
                                const s = startOfDay(new Date(med.startDate || med.createdAt || new Date()));
                                const daysSince = Math.floor((todayStart - s) / (1000 * 60 * 60 * 24));
                                if (daysSince % 2 === 0) doses.push(makeDoseAt(0, 0));
                                break;
                            }
 case "weekly": {
                                const sd = new Date(med.startDate || med.createdAt || new Date());
                                if (sd.getDay() === todayStart.getDay()) doses.push(makeDoseAt(0, 0));
                                break;
                            }
                            default:
                                doses.push(makeDoseAt(0, 0));
                        }
                        doses.forEach(dt => {
                            const isLogged = doseLogs.some(l => {
                                if (l.medicineId !== med.id) return false;
                                const takenMs = new Date(l.takenAt).getTime();
                                return Math.abs(takenMs - dt.getTime()) <= LOG_WINDOW_MS;
                            });
                            if (!isLogged) {
                                upcoming.push({ medicine: med.name, time: dt, overdue: dt < now });
                            }
                        });
                    });
                    upcoming.sort((a, b) => a.time - b.time);
                    if (!upcoming.length) {
                        upcomingContainer.innerHTML = `<p style="color:#e6d3a3;text-align:center;">✅ All doses taken or none scheduled today.</p>`;
                    } else {
                        upcomingContainer.innerHTML = upcoming.map(d => `
            <div class="dose-item" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div>
                    <div class="dose-time">${d.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="dose-medicine">🧪 ${escapeHtml(d.medicine)}</div>
                </div>
                <div style="font-weight:bold;color:${d.overdue ? '#eb4d4b' : '#4ecdc4'};">
                    ${d.overdue ? 'Overdue' : 'Upcoming'}
                </div>
            </div>
        `).join("");
                    }
                    const past = (doseLogs || []).filter(log => log.takenAt).map(log => ({
                        name: log.medicineName || "Unknown",
                        time: new Date(log.takenAt),
                        status: log.status === "taken" ? "✅ Taken" : "❌ Missed"
                    })).sort((a, b) => b.time - a.time);

                    if (!past.length) {
                        pastContainer.innerHTML = `<p style="color:#e6d3a3;text-align:center;">📜 No past reminders logged yet.</p>`;
                    } else {
                        pastContainer.innerHTML = past.map(p => `
            <div style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.35);margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;">
                    <div>
                        <strong>${escapeHtml(p.name)}</strong><br>
                        <small style="color:#e6d3a3;">${p.time.toLocaleDateString()} ${p.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                    </div>
                    <div style="color:${p.status.includes('✅') ? '#4ecdc4' : '#eb4d4b'}; font-weight:bold;">${p.status}</div>
                </div>
            </div>
        `).join("");
                    }
                }

                function showNotification(text, duration = 3000, opts = {}) {
                    const el = document.getElementById("notification");
                    const txt = document.getElementById("notificationText");
                    if (!el || !txt) return;
                    txt.textContent = text;
                    el.classList.add("show");
                    document.getElementById("snoozeBtn").style.display = opts.allowSnooze ? "inline-block" : "none";

                    clearTimeout(notificationTimeout);
                    notificationTimeout = setTimeout(() => { el.classList.remove("show"); }, duration);
                    const snoozeBtn = document.getElementById("snoozeBtn");
                    if (snoozeBtn) {
                        snoozeBtn.onclick = () => {
                            el.classList.remove("show");
                            setTimeout(() => {
                                showNotification(text, 3000, opts);
                            }, 15 * 60 * 1000);
                        };
                    }
                }

                function exportMissedHistoryCSV() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const rows = [["Date", "Medicine", "Status", "LoggedAt"]];
                    doseLogs.filter(l => l.status === "missed").forEach(l => rows.push([new Date(l.takenAt).toLocaleDateString(), l.medicineName, l.status, new Date(l.takenAt).toLocaleString()]));
                    if (rows.length === 1) { showNotification("No missed logs to export"); return; }
                    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\r\n");
                    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a"); a.href = url; a.download = "missed_history.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    showNotification("📥 Exported missed history CSV");

                }
                let wizardActive = false;
                function startWizard() {
                    wizardActive = true;
                    document.getElementById('wizardOverlay')?.classList.add('active');
                    document.getElementById('wizardContainer')?.classList.add('active');
                    document.getElementById('restartWizard').style.display = 'none';
                    showNotification("🎪 Tutorial started");
                }

                function stopWizard() {
                    wizardActive = false;
                    document.getElementById('wizardOverlay')?.classList.remove('active');
                    document.getElementById('wizardContainer')?.classList.remove('active');
                    document.getElementById('restartWizard').style.display = 'inline-block';
                    showNotification("🎪 Tutorial ended");
                }

                function startWitchFlight() {
                    const flying = document.getElementById("flyingWitch");
                    const starOverlay = document.getElementById("starOverlay");
                    const audio = document.getElementById("witchSound");
                    if (!flying) return;
                    starOverlay.style.display = 'block'; starOverlay.style.opacity = '1';
                    flying.classList.add("fly");
                    try { audio?.play(); } catch (e) { }
                    setTimeout(() => { flying.classList.remove("fly"); starOverlay.style.opacity = '0'; setTimeout(() => starOverlay.style.display = 'none', 600); }, 4500);
                }

                function formatTime(time24) {
                    if (!time24) return "";
                    const [h, m] = time24.split(":").map(Number);
                    const ampm = h >= 12 ? "PM" : "AM";
                    const hh = h % 12 || 12;
                    return `${hh}:${String(m).padStart(2, "0")} ${ampm}`;
                }

                function switchTab(name) {
                    if (!name) return;
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                    document.getElementById(name)?.classList.add('active');
                    const btn = Array.from(document.querySelectorAll('.nav-tab')).find(b => (b.getAttribute('onclick') || '').includes(`'${name}'`));
                    if (btn) btn.classList.add('active');
                    if (name === 'dashboard') updateDashboard();
                    if (name === 'userDashboard') renderUserDashboard();
                    if (name === 'schedule') renderMedicines();
                    if (name === 'streakTab') updateStreakDisplay();
                }

                function updateStreakDisplay() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    document.getElementById("currentStreak").textContent = `${calculateStreak()} days`;
                    const totalDays = Object.keys(doseLogs.reduce((acc, l) => { acc[new Date(l.takenAt).toDateString()] = true; return acc; }, {})).length;
                    document.getElementById("totalDaysTracked").textContent = totalDays;
                    let perfect = 0;
                    const grouped = {};
                    doseLogs.forEach(l => { const d = new Date(l.takenAt).toDateString(); grouped[d] = grouped[d] || { taken: 0, total: 0 }; grouped[d].total++; if (l.status === "taken") grouped[d].taken++; });
                    Object.values(grouped).forEach(g => { if (g.taken === g.total) perfect++; });
                    document.getElementById("perfectDays").textContent = perfect;
                    document.getElementById("longestStreak").textContent = `${calculateLongestStreak()} days`;
                }

                function calculateLongestStreak() {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const dayMap = {};
                    doseLogs.forEach(l => {
                        const d = new Date(l.takenAt).toDateString();
                        dayMap[d] = dayMap[d] || { taken: 0, total: 0 };
                        if (l.status === "taken") dayMap[d].taken++;
                        dayMap[d].total++;
                    });
                    const days = Object.keys(dayMap).sort((a, b) => new Date(a) - new Date(b));
                    let max = 0, cur = 0, prev = null;
                    days.forEach(d => {
                        if (dayMap[d].taken === dayMap[d].total) {
                            if (prev && (new Date(d).getTime() - new Date(prev).getTime() === 24 * 3600 * 1000)) cur++; else cur = 1;
                        } else cur = 0;
                        max = Math.max(max, cur);
                        prev = d;
                    });
                    return max;
                }

                function renderAll() {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    renderMedicines();
                    updateDashboard();
                    renderMissedDoseHistoryTable();
                    updateUpcomingDoses();
                    renderUserDashboard();
                    updateStreakDisplay();
                }

                function checkElementId(id) { return !!document.getElementById(id); }
                window._app = {
                    renderAll, renderMedicines, markAsTaken, markAsMissed, medicines, doseLogs, persistMedicines, persistDoseLogs
                };

                function generateRandomCrierAnnouncement() {
                    const crierAnnouncements = [
                        "🎪 Attention performers! Remember your morning strength elixir before the aerial acts!",
                        "🎭 The show starts in 30 minutes - time for your pre-performance potions!",
                        "⚡ Energy levels looking optimal today thanks to consistent elixir adherence!",
                        "🌟 Outstanding wellness performance this week! The audience applauds your dedication!",
                        "🎪 New safety protocol: Double-check your elixir schedule before entering the ring!",
                        "🎨 The Alchemist has brewed fresh batches - your supply is ready for pickup!"
                    ];
                    return crierAnnouncements[Math.floor(Math.random() * crierAnnouncements.length)];
                }

                let _crierInterval = null;
                function startCrierTicker(intervalMs = 8000) {
                    const el = document.getElementById("crierTicker") || (() => {
                        const banner = document.createElement("div");
                        banner.id = "crierTicker";
                        banner.style.cssText = "position:fixed;left:20px;bottom:20px;background:rgba(0,0,0,0.6);color:#ffb347;padding:8px 12px;border-radius:12px;z-index:1200;";
                        document.body.appendChild(banner);
                        return banner;
                    })();
                    if (_crierInterval) clearInterval(_crierInterval);
                    el.textContent = generateRandomCrierAnnouncement();
                    _crierInterval = setInterval(() => {
                        el.textContent = generateRandomCrierAnnouncement();
                    }, intervalMs);
                }

                function stopCrierTicker() {
                    if (_crierInterval) {
                        clearInterval(_crierInterval);
                        _crierInterval = null;
                    }
                    const el = document.getElementById("crierTicker");
                    if (el) el.remove();
                }

                function generateUUID(prefix = "") {
                    const s4 = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
                    return prefix + s4() + s4() + "-" + s4() + "-" + s4();
                }

                function clearPastReminders(confirmFirst = true) {
                    if (confirmFirst && !confirm("Clear all past reminder logs? This cannot be undone.")) return;
                    const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    doseLogs = [];
                    localStorage.setItem("doseLogs", JSON.stringify(doseLogs));
                    showNotification("🧹 Past reminders cleared");
                    try { renderUserDashboard(); } catch (e) { }
                    try { renderMissedDoseHistoryTable(); } catch (e) { }
                    try { updateDashboard(); } catch (e) { }
                }

                function resetDashboardData(confirmFirst = true) {
                    if (confirmFirst && !confirm("Reset all app data? This will remove all medicines and logs.")) return;
                    localStorage.removeItem("medicines");
                    localStorage.removeItem("doseLogs");
                    medicines = []; doseLogs = [];
                    showNotification("⚠️ App data reset");
                    renderAll && renderAll();
                }

                function exportLogs(options = { type: "missedCSV", from: null, to: null }) {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    let filtered = doseLogs.slice();
                    if (options.from) {
                        const from = new Date(options.from); from.setHours(0, 0, 0, 0);
                        filtered = filtered.filter(l => new Date(l.takenAt) >= from);
                    }
                    if (options.to) {
                        const to = new Date(options.to); to.setHours(23, 59, 59, 999);
                        filtered = filtered.filter(l => new Date(l.takenAt) <= to);
                    }
                    if (options.type === "json") {
                        const blob = new Blob([JSON.stringify(filtered, null, 2)], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a"); a.href = url; a.download = "dose_logs.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                        showNotification("📦 Exported logs (JSON)");
                        return;
                    }
                    const rows = [];
                    if (options.type === "allCSV") rows.push(["id", "medicineId", "medicineName", "status", "takenAt", "email", "timezone"]);
                    else rows.push(["Date", "Medicine", "Status", "LoggedAt"]);
                    filtered.forEach(l => {
                        if (options.type === "allCSV") {
                            rows.push([l.id, l.medicineId, l.medicineName, l.status, new Date(l.takenAt).toISOString(), l.email || "", l.timezone || ""]);
                        } else if (l.status === "missed" || options.type === "allCSV") {
                            rows.push([new Date(l.takenAt).toLocaleDateString(), l.medicineName, l.status, new Date(l.takenAt).toLocaleTimeString()]);
                        }
                    });
                    if (rows.length <= 1) {
                        showNotification("ℹ️ No logs to export for selected range");
                        return;
                    }
                    const csv = rows.map(r => r.map(v => `"${String(v || "").replace(/"/g, '""')}"`).join(",")).join("\r\n");
                    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a"); a.href = url; a.download = (options.type === "allCSV" ? "all_logs.csv" : "missed_history.csv"); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    showNotification("📥 Export complete");
                }

                document.getElementById("edExportBtn")?.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    exportLogs({ type: "allCSV" });
                });

                let _notificationScheduler = null;
                function setupNotifications(pollIntervalMs = 60_000) {
                    if (_notificationScheduler) clearInterval(_notificationScheduler);
                    checkForUpcomingNotifications();
                    _notificationScheduler = setInterval(checkForUpcomingNotifications, pollIntervalMs);
                }

                function checkForUpcomingNotifications() {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const now = new Date();
                    medicines.forEach(med => {
                        const baseTime = med.time || "09:00";
                        const [h, m] = baseTime.split(":").map(Number);
                        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                        const candidateTimes = [];
                        if (med.frequency === "twiceDaily") {
                            candidateTimes.push(new Date(todayStart).setHours(h, m, 0, 0));
                            candidateTimes.push(new Date(todayStart).setHours(h + 12, m, 0, 0));
                        } else if (med.frequency === "every8h") {
                            candidateTimes.push(new Date(todayStart).setHours(h, m, 0, 0));
                            candidateTimes.push(new Date(todayStart).setHours(h + 8, m, 0, 0));
                            candidateTimes.push(new Date(todayStart).setHours(h + 16, m, 0, 0));
                        } else {
                            candidateTimes.push(new Date(todayStart).setHours(h, m, 0, 0));
                        }
                        candidateTimes.forEach(ts => {
                            const doseDate = new Date(ts);
                            const diffMs = doseDate - now;
                            if (diffMs > 0 && diffMs <= 10 * 60 * 1000) {
                                const alreadyLoggedToday = doseLogs.some(l => l.medicineId === med.id && new Date(l.takenAt).toDateString() === new Date().toDateString());
                                if (!alreadyLoggedToday) {
                                    showNotification(`⏰ Upcoming dose: ${med.name} at ${formatTime(med.time)}`, 8000);
                                    sendEmailNotification({
                                        to: getUserEmail(),
                                        subject: `Upcoming dose: ${med.name}`,
                                        body: `Your scheduled dose for ${med.name} is at ${formatTime(med.time)}. Mark it taken when done.`
                                    }).catch(() => { });
                                }
                            }
                        });
                    });
                }

                async function sendEmailNotification(type, med) {
                    try {
                        const res = await fetch("http://localhost:3000/sendEmail", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                email: med.email || getUserEmail(),
                                medicineName: med.medicineName || med.name,
                                dosage: med.dosage,
                                time: med.time,
                                status: type
                            })
                        });

                        const data = await res.json();
                        if (res.ok) {
                            console.log(`📧 Email sent for ${med.medicineName} (${type})`);
                        } else {
                            console.warn("❌ Email sending failed:", data);
                        }
                    } catch (err) {
                        console.error("❌ Email API error:", err);
                    }
                }

                function showNotification(text, duration = 4000, opts = {}) {
                    let root = document.getElementById("notification");
                    if (!root) {
                        root = document.createElement("div");
                        root.id = "notification";
                        root.className = "notification";
                        root.innerHTML = '<span id="notificationText"></span><button id="snoozeBtn" style="display:none;margin-left:10px;padding:5px 10px;border:none;border-radius:5px;background:#4ecdc4;color:#fff;cursor:pointer;">Snooze 15 min</button>';
                        document.body.appendChild(root);
                    }
                    const textEl = root.querySelector("#notificationText");
                    const snoozeBtn = root.querySelector("#snoozeBtn");
                    textEl.textContent = text;
                    root.classList.add("show");
                    if (opts.allowSnooze) snoozeBtn.style.display = "inline-block"; else snoozeBtn.style.display = "none";
                    snoozeBtn.onclick = () => {
                        root.classList.remove("show");
                        setTimeout(() => {
                            showNotification(text, duration, opts);
                        }, 15 * 60 * 1000); // 15 minutes
                    };
                    clearTimeout(notificationTimeout);
                    notificationTimeout = setTimeout(() => {
                        root.classList.remove("show");
                    }, duration);
                }

                function triggerMagicTrail() {
                    const overlay = document.getElementById("starOverlay");
                    if (!overlay) return;
                    overlay.style.display = "block";
                    overlay.style.opacity = "1";
                    const starCount = 18;
                    for (let i = 0; i < starCount; i++) {
                        const s = document.createElement("div");
                        s.className = "star";
                        const size = (Math.random() * 4) + 1;
                        s.style.setProperty('--s', `${size}px`);
                        s.style.left = `${Math.random() * 100}%`;
                        s.style.top = `${Math.random() * 80}%`;
                        s.style.animationDuration = `${2 + Math.random() * 3}s`;
                        overlay.appendChild(s);
                        setTimeout(() => {
                            s.remove();
                        }, 5200);
                    }
                    setTimeout(() => {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 700);
                    }, 4200);
                }

                function stopFlightAnimation() {
                    const flying = document.getElementById("flyingWitch");
                    if (!flying) return;
                    flying.classList.remove("fly");
                    const overlay = document.getElementById("starOverlay");
                    if (overlay) {
                        overlay.style.display = 'none';
                        overlay.innerHTML = '';
                    }
                }

                function calculateAdherenceTrend(days = 30) {
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    const result = [];
                    for (let i = days - 1; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const { totalDoses } = calculateDailyAdherence(d);
                        const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === d.toDateString() && l.status === "taken").length;
                        const adherence = totalDoses > 0 ? Math.round((taken / totalDoses) * 100) : 0;
                        result.push({ date: new Date(d), adherence });
                    }
                    return result;
                }

                let _streakTrendChart = null;

                function renderStreakTrendChart(elId = "streakTrendChart") {
                    const el = document.getElementById(elId);
                    if (!el) return;
                    const ctx = el.getContext("2d");
                    const series = calculateAdherenceTrend(30);
                    const labels = series.map(s => s.date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                    const data = series.map(s => s.adherence);

                    if (_streakTrendChart) _streakTrendChart.destroy();
                    _streakTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets: [{ label: 'Adherence %', data, borderColor: '#ffd166', backgroundColor: 'rgba(255,209,102,0.15)', fill: true, tension: 0.25 }] },
                        options: { scales: { y: { beginAtZero: true, max: 100 } } }
                    });
                }

                function renderDoseHistoryTimeline(containerId = "doseTimelineContainer", days = 30, opts = { onlyMissed: true }) {
                    const parentCard = document.getElementById("missedHistoryCard");
                    if (!parentCard) return;
                    let container = document.getElementById(containerId);
                    if (!container) {
                        const el = document.createElement("div");
                        el.id = containerId;
                        el.style.cssText = "margin-top:12px;overflow:auto;padding:8px 12px;background:rgba(255,255,255,0.02);border-radius:10px;max-height:260px;";
                        parentCard.appendChild(el);
                        container = el;
                    }
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const end = new Date(); end.setHours(23, 59, 59, 999);
                    const start = new Date(); start.setDate(start.getDate() - (days - 1)); start.setHours(0, 0, 0, 0);
                    const dayMap = {};
                    doseLogs.forEach(l => {
                        if (!l || !l.takenAt) return;
                        const d = new Date(l.takenAt);
                        if (isNaN(d)) return;
                        if (d < start || d > end) return;
                        const isoDay = startOfDay(d).toISOString();
                        dayMap[isoDay] = dayMap[isoDay] || { date: startOfDay(d), taken: 0, missed: 0, logs: [] };
                        if (l.status === "taken") dayMap[isoDay].taken++;
                        if (l.status === "missed") dayMap[isoDay].missed++;
                        dayMap[isoDay].logs.push(l);
                    });
                    let items = Object.values(dayMap).sort((a, b) => b.date - a.date);
                    if (opts.onlyMissed) items = items.filter(it => it.missed > 0);
                    if (!items.length) {
                        container.innerHTML = `<div style="padding:12px;color:#e6d3a3;text-align:center;">No missed-dose days in the last ${days} days.</div>`;
                        return;
                    }
                    container.innerHTML = items.map(it => {
                        const d = it.date;
                        const dateLabel = d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                        const badge = it.missed > 0
                            ? `<span style="color:#eb4d4b;font-weight:bold;margin-right:6px;">●</span>`
                            : `<span style="color:#4ecdc4;font-weight:bold;margin-right:6px;">●</span>`;
                        return `
          <div class="timeline-row" data-date="${d.toISOString()}"
             style="display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-bottom:1px dashed rgba(255,179,71,0.03);cursor:pointer;">
            <div style="flex:1">${dateLabel}</div>
            <div style="width:140px;text-align:right">${badge} ${it.taken}✅ ${it.missed}❌</div>
          </div>
        `;
                    }).join("");
                    container.querySelectorAll('.timeline-row').forEach(el => {
                        el.removeEventListener?.('click', el._timelineClickHandler);
                        const handler = () => {
                            const iso = el.getAttribute('data-date');
                            if (!iso) return;
                            const d = new Date(iso);
                            const yyyyMmDd = d.toISOString().split('T')[0];
                            const rangeSelect = document.getElementById("edRangeSelect");
                            if (rangeSelect) rangeSelect.value = "custom";
                            document.getElementById("customRangeInputs").style.display = "inline-block";
                            document.getElementById("edFrom").value = yyyyMmDd;
                            document.getElementById("edTo").value = yyyyMmDd;
                            renderMissedDoseHistoryTable();
                            try { switchTab && switchTab('dashboard'); } catch (e) { }
                        };
                        el._timelineClickHandler = handler;
                        el.addEventListener('click', handler);
                    });
                }

                async function markAsMissed(id) {
                    medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                    doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                    const med = medicines.find(m => m.id === id);
                    if (!med) {
                        showNotification("⚠️ Elixir not found");
                        return;
                    }
                    const today = new Date();
                    const already = doseLogs.some(
                        l => l.medicineId === id && new Date(l.takenAt).toDateString() === today.toDateString() && l.status === "missed"
                    );
                    if (already) {
                        showNotification("⚠️ Already logged today");
                        return;
                    }
                    const log = {
                        id: "log_" + Math.random().toString(36).slice(2, 10),
                        medicineId: id,
                        medicineName: med.name,
                        email: getUserEmail(),
                        status: "missed",
                        takenAt: new Date().toISOString(),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        synced: false
                    };
                    doseLogs.push(log);
                    localStorage.setItem("doseLogs", JSON.stringify(doseLogs));
                    showNotification(`❌ ${med.name} marked missed`);
                    try { renderMissedDoseHistoryTable(); } catch (e) { }
                    try { updateDashboard(); } catch (e) { }
                    try { updateUpcomingDoses(); } catch (e) { }
                    try {
                        await fetch("http://localhost:3000/logDose", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(log)
                        });
                    } catch (err) {
                        console.warn("Server sync failed for missed:", err);
                    }
                    try {
                        await fetch("http://localhost:3000/sendEmail", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                email: getUserEmail(),
                                medicineName: med.name,
                                status: "missed",
                                time: new Date().toLocaleString()
                            })
                        });
                        console.log(`📧 Missed dose email sent for ${med.name}`);
                    } catch (err) {
                        console.warn("Email notification failed:", err);
                    }
                }

                (function bootstrapMissingParts() {
                    document.querySelectorAll("[onclick='clearPastReminders()']").forEach(btn => {
                        btn.addEventListener("click", (e) => { e.preventDefault(); clearPastReminders(true); });
                    });
                    document.querySelectorAll("[onclick='startWizard()']").forEach(btn => {
                        btn.addEventListener("click", (e) => { e.preventDefault(); startWizard(); });
                    });
                    document.querySelectorAll("[onclick='restartWizard()']").forEach(btn => {
                        btn.addEventListener("click", (e) => { e.preventDefault(); restartWizard(); });
                    });
                    document.getElementById("edExportBtn")?.addEventListener("click", (e) => {
                        e.preventDefault();
                        const from = document.getElementById("edFrom")?.value || null;
                        const to = document.getElementById("edTo")?.value || null;
                        exportLogs({ type: "missedCSV", from, to });
                    });
                    try { startCrierTicker(); } catch (e) { console.warn("Crier start failed", e); }
                    try { setupNotifications(60_000); } catch (e) { console.warn("Notifications setup failed", e); }
                    try { renderStreakTrendChart(); } catch (e) { }
                    try { renderDoseHistoryTimeline(); } catch (e) { }

                    document.getElementById("snoozeBtn")?.addEventListener("click", () => {
                    });
                })();

                (function clockFix() {
                    function updateClock() {
                        const el = document.getElementById("clock");
                        if (!el) return;
                        const now = new Date();
                        const opts = { timeZone: "Asia/Kolkata", hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit", day: "2-digit", month: "short", year: "numeric" };
                        const ist = new Intl.DateTimeFormat([], opts).format(now);
                        el.textContent = `IST ${ist}`;
                    }
                    updateClock();
                    setInterval(updateClock, 1000);
                })();

                async function syncDoseLogsFromServer() {
                    try {
                        const res = await fetch("http://localhost:3000/doseLogs");
                        const logs = await res.json();
                        localStorage.setItem("doseLogs", JSON.stringify(logs));
                        doseLogs = logs;
                        renderUserDashboard();
                        updateUpcomingDoses();
                    } catch (e) {
                        console.error("❌ Failed to sync dose logs:", e);
                    }
                }

                document.addEventListener("DOMContentLoaded", syncDoseLogsFromServer);

                (function crierTicker() {
                    const messages = [
                        "🎪 Remember your morning potion — an ounce of ritual keeps the chaos away!",
                        "🔔 Pro tip: mark doses Taken promptly to keep your wellness rate high.",
                        "📦 Export logs regularly to keep archives of your elixir regimes.",
                        "⭐ Keep an eye on streaks — perfect days build long-term gains.",
                        "⚠️ If a dose is missed, mark it in the Grimoire to keep stats accurate.",
                        "🧙‍♂️ The Alchemist recommends a review of schedules weekly."
                    ];
                    function generateRandomCrierAnnouncement() {
                        return messages[Math.floor(Math.random() * messages.length)];
                    }
                    let _crierInterval = null;
                    window.startCrierTicker = function (intervalMs = 8000) {
                        let el = document.getElementById("crierTicker");
                        if (!el) {
                            el = document.createElement("div");
                            el.id = "crierTicker";
                            el.style.cssText = "position:fixed;left:20px;bottom:20px;background:rgba(0,0,0,0.6);color:#ffb347;padding:8px 12px;border-radius:12px;z-index:1200;font-weight:bold;";
                            document.body.appendChild(el);
                        }
                        el.textContent = generateRandomCrierAnnouncement();
                        if (_crierInterval) clearInterval(_crierInterval);
                        _crierInterval = setInterval(() => { el.textContent = generateRandomCrierAnnouncement(); }, intervalMs);
                    };
                    window.stopCrierTicker = function () {
                        if (_crierInterval) {
                            clearInterval(_crierInterval);
                            _crierInterval = null;
                        }
                        const el = document.getElementById("crierTicker");
                        if (el) el.remove();
                    };
                })();

                (function notificationSystem() {
                    let _schedulerId = null;
                    window.setupNotifications = function (pollIntervalMs = 60_000) {
                        if (_schedulerId) clearInterval(_schedulerId);
                        // run immediately then start interval
                        checkForUpcomingNotifications();
                        _schedulerId = setInterval(checkForUpcomingNotifications, pollIntervalMs);
                    };

                    async function checkForUpcomingNotifications() {
                        medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                        doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                        const now = new Date();
                        medicines.forEach(med => {
                            const [h, min] = (med.time || "09:00").split(":").map(Number);
                            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                            const candidateTimes = [];
                            if (med.frequency === "twiceDaily") {
                                candidateTimes.push(new Date(todayStart).setHours(h, min, 0, 0));
                                candidateTimes.push(new Date(todayStart).setHours(h + 12, min, 0, 0));
                            } else if (med.frequency === "every8h") {
                                candidateTimes.push(new Date(todayStart).setHours(h, min, 0, 0));
                                candidateTimes.push(new Date(todayStart).setHours(h + 8, min, 0, 0));
                                candidateTimes.push(new Date(todayStart).setHours(h + 16, min, 0, 0));
                            } else {
                                candidateTimes.push(new Date(todayStart).setHours(h, min, 0, 0));
                            }
                            candidateTimes.forEach(ts => {
                                const doseDate = new Date(ts);
                                const diff = doseDate - now;
                                if (diff > 0 && diff <= 10 * 60 * 1000) {
                                    const logged = doseLogs.some(l => l.medicineId === med.id && new Date(l.takenAt).toDateString() === new Date().toDateString());
                                    if (!logged) {
                                        showNotification(`⏰ Upcoming: ${med.name} at ${formatTime(med.time)}`, 8000, { allowSnooze: true });
                                        sendEmailNotification({ to: getUserEmail(), subject: `Upcoming dose: ${med.name}`, body: `Dose at ${formatTime(med.time)}.` }).catch(() => { });
                                    }
                                }
                            });
                        });
                    }
                    window.sendEmailNotification = async function ({ to, subject, body }) {
                        try {
                            await fetch("http://localhost:3000/sendEmail", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ to, subject, body }) });
                        } catch (e) { console.warn("Email send failed (local)", e); }
                    };
                    window.checkForUpcomingNotifications = checkForUpcomingNotifications;
                })();

                (function notificationUI() {
                    if (typeof window._notificationTimeout === "undefined") window._notificationTimeout = null;
                    window.showNotification = function (text, duration = 4000, opts = {}) {
                        let root = document.getElementById("notification");
                        if (!root) {
                            root = document.createElement("div");
                            root.id = "notification";
                            root.className = "notification";
                            root.innerHTML = '<span id="notificationText"></span><button id="snoozeBtn" style="display:none;margin-left:10px;padding:5px 10px;border:none;border-radius:5px;background:#4ecdc4;color:#fff;cursor:pointer;">Snooze 15 min</button>';
                            document.body.appendChild(root);
                        }
                        const txt = root.querySelector("#notificationText");
                        const snooze = root.querySelector("#snoozeBtn");
                        txt.textContent = text;
                        root.classList.add("show");
                        if (opts.allowSnooze) snooze.style.display = "inline-block"; else snooze.style.display = "none";
                        snooze.onclick = () => {
                            root.classList.remove("show");
                            setTimeout(() => showNotification(text, duration, opts), 15 * 60 * 1000);
                        };
                        clearTimeout(window._notificationTimeout);
                        window._notificationTimeout = setTimeout(() => { root.classList.remove("show"); }, duration);
                    };
                })();
  (function streakTrend() {
                    window.calculateAdherenceTrend = function (days = 30) {
                        doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                        medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
                        const out = [];
                        for (let i = days - 1; i >= 0; i--) {
                            const d = new Date(); d.setDate(d.getDate() - i);
                            const { totalDoses } = calculateDailyAdherence(d);
                            const taken = doseLogs.filter(l => new Date(l.takenAt).toDateString() === d.toDateString() && l.status === "taken").length;
                            const adherence = totalDoses > 0 ? Math.round((taken / totalDoses) * 100) : 0;
                            out.push({ date: new Date(d), adherence });
                        }
                        return out;
                    };
                    let _streakTrendChart = window._streakTrendChart || null;
                    window.renderStreakTrendChart = function (elId = "streakTrendChart") {
                        const el = document.getElementById(elId);
                        if (!el) return;
                        const ctx = el.getContext("2d");
                        const series = calculateAdherenceTrend(30);
                        const labels = series.map(s => s.date.toLocaleDateString(undefined, { month: "short", day: "numeric" }));
                        const data = series.map(s => s.adherence);
                        if (_streakTrendChart) _streakTrendChart.destroy();
                        _streakTrendChart = new Chart(ctx, {
                            type: "line",
                            data: { labels, datasets: [{ label: "Adherence %", data, borderColor: "#ffd166", backgroundColor: "rgba(255,209,102,0.15)", fill: true, tension: 0.25 }] },
                            options: { scales: { y: { beginAtZero: true, max: 100 } } }
                        });
                        window._streakTrendChart = _streakTrendChart;
                    };
                })();

                (function exportsAdvanced() {
                    window.exportLogs = function (opts = { type: "missedCSV", from: null, to: null }) {
                        doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                        let filtered = doseLogs.slice();
                        if (opts.from) {
                            const from = new Date(opts.from); from.setHours(0, 0, 0, 0);
                            filtered = filtered.filter(l => new Date(l.takenAt) >= from);
                        }
                        if (opts.to) {
                            const to = new Date(opts.to); to.setHours(23, 59, 59, 999);
                            filtered = filtered.filter(l => new Date(l.takenAt) <= to);
                        }
                        if (opts.type === "json") {
                            const blob = new Blob([JSON.stringify(filtered, null, 2)], { type: "application/json" });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a"); a.href = url; a.download = "dose_logs.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                            showNotification("📦 Exported logs (JSON)");
                            return;
                        }
                        const rows = [];
                        if (opts.type === "allCSV") rows.push(["id", "medicineId", "medicineName", "status", "takenAt", "email", "timezone"]);
                        else rows.push(["Date", "Medicine", "Status", "LoggedAt"]);

                        filtered.forEach(l => {
                            if (opts.type === "allCSV") rows.push([l.id, l.medicineId, l.medicineName, l.status, new Date(l.takenAt).toISOString(), l.email || "", l.timezone || ""]);
                            else if (l.status === "missed" || opts.type === "allCSV") rows.push([new Date(l.takenAt).toLocaleDateString(), l.medicineName, l.status, new Date(l.takenAt).toLocaleTimeString()]);
                        });
                        if (rows.length <= 1) { showNotification("ℹ️ No logs to export for selected range"); return; }
                        const csv = rows.map(r => r.map(v => `"${String(v || "").replace(/"/g, '""')}"`).join(",")).join("\r\n");
                        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a"); a.href = url; a.download = (opts.type === "allCSV" ? "all_logs.csv" : "missed_history.csv"); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                        showNotification("📥 Export complete");
                    };
                    window.exportMissedHistoryCSV = function () {
                        const from = document.getElementById("edFrom")?.value || null;
                        const to = document.getElementById("edTo")?.value || null;
                        exportLogs({ type: "missedCSV", from, to });
                    };
                    document.getElementById("edExportBtn")?.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        exportLogs({ type: "allCSV" });
                    });
                })();

                (function clearReset() {
                    window.clearPastReminders = function (confirmFirst = true) {
                        if (confirmFirst && !confirm("Clear all past reminder logs? This cannot be undone.")) return;
                        doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                        doseLogs = [];
                        localStorage.setItem("doseLogs", JSON.stringify(doseLogs));
                        showNotification("🧹 Past reminders cleared");
                        try { renderUserDashboard(); } catch (e) { }
                        try { renderMissedDoseHistoryTable(); } catch (e) { }
                        try { updateDashboard(); } catch (e) { }
                    };
                    window.resetDashboardData = function (confirmFirst = true) {
                        if (confirmFirst && !confirm("Reset all app data? This will remove all medicines and logs.")) return;
                        localStorage.removeItem("medicines");
                        localStorage.removeItem("doseLogs");
                        medicines = []; doseLogs = [];
                        showNotification("⚠️ App data reset");
                        try { renderAll(); } catch (e) { }
                    };
                })();

                (function pastReminders() {
                    window.renderPastReminders = function () {
                        doseLogs = JSON.parse(localStorage.getItem("doseLogs") || "[]");
                        const pastContainer = document.getElementById("pastRemindersList");
                        if (!pastContainer) return;
                        const now = new Date();
                        const past = (doseLogs || []).filter(log => log.takenAt && new Date(log.takenAt) <= now)
                            .map(log => ({ name: log.medicineName || "Unknown", time: new Date(log.takenAt), status: log.status === "taken" ? "taken" : "missed" }))
                            .sort((a, b) => b.time - a.time);
                        if (!past.length) {
                            pastContainer.innerHTML = `<p style="color:#e6d3a3;text-align:center;">📜 No past reminders logged yet.</p>`;
                            return;
                        }
                        pastContainer.innerHTML = past.map(p => `
      <div style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.35);margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;">
          <div>
            <strong>${escapeHtml(p.name)}</strong><br>
            <small style="color:#e6d3a3;">${p.time.toLocaleDateString()} ${p.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
          </div>
          <div style="color:${p.status === 'taken' ? '#4ecdc4' : '#eb4d4b'}; font-weight:bold;">${p.status === 'taken' ? '✅ Taken' : '❌ Missed'}</div>
        </div>
      </div>
    `).join("");
                    };
                })();

                (function bootstrapMissing() {
                    document.getElementById("restartWizard")?.addEventListener("click", (e) => { e.preventDefault(); startWizard(); });
                    document.querySelectorAll("[onclick='clearPastReminders()']").forEach(btn => btn.addEventListener("click", (e) => { e.preventDefault(); clearPastReminders(true); }));
                    document.querySelectorAll("[onclick='startWizard()']").forEach(btn => btn.addEventListener("click", (e) => { e.preventDefault(); startWizard(); }));
                    const exportBtn = document.getElementById("edExportBtn");
                    if (exportBtn) {
                        exportBtn.removeEventListener?.("click", exportMissedHistoryCSV); // defensive
                        exportBtn.addEventListener("click", (e) => { e.preventDefault(); exportMissedHistoryCSV(); });
                    }
                    try { startCrierTicker(); } catch (e) { console.warn("Crier start failed", e); }
                    try { setupNotifications(60_000); } catch (e) { console.warn("Notifications setup failed", e); }
                    try { renderStreakTrendChart(); } catch (e) { console.warn("Streak chart render failed", e); }
                    try { renderDoseHistoryTimeline && renderDoseHistoryTimeline(); } catch (e) { }
                    try { renderPastReminders(); } catch (e) { }
                    window._grimoire = window._grimoire || {};
                    Object.assign(window._grimoire, { startWitchFlight, triggerMagicTrail, clearPastReminders, resetDashboardData, startWizard, stopCrierTicker, renderPastReminders });
                })();

                function createStars(count = 300) {
                    const starOverlay = document.getElementById("starOverlay");
                    starOverlay.innerHTML = "";
                    for (let i = 0; i < count; i++) {
                        const star = document.createElement("div");
                        star.className = "star";
                        star.style.setProperty("--s", `${Math.random() * 3 + 1}px`);
                        star.style.setProperty("--d", `${2 + Math.random() * 3}s`);
                        star.style.left = `${Math.random() * 100}vw`;
                        star.style.top = `${Math.random() * 100}vh`;
                        starOverlay.appendChild(star);
                    }
                }

                function startWitchFlight() {
                    const witch = document.getElementById("flyingWitch");
                    const starOverlay = document.getElementById("starOverlay");
                    const sound = document.getElementById("witchSound");
                    witch.classList.remove("fly");
                    void witch.offsetWidth;
                    createStars();
                    starOverlay.style.display = "block";
                    setTimeout(() => {
                        starOverlay.style.opacity = "1";
                    }, 50);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(() => { });
                    }
                    witch.classList.add("fly");
                    setTimeout(() => {
                        starOverlay.style.opacity = "0";
                        setTimeout(() => {
                            starOverlay.style.display = "none";
                        }, 600);
                    }, 4000);
                }

                document.addEventListener("DOMContentLoaded", () => {
                    setTimeout(() => {
                        startWitchFlight();
                    }, 500);
                });

                document.addEventListener("click", () => {
                    const sound = document.getElementById("witchSound");
                    if (sound) {
                        sound.play().catch(err => console.warn("🔇 Audio blocked:", err));
                    }
                }, { once: true });

                const steps = [
                    { title: "Welcome", text: "Welcome! I will guide you through the main parts of the Grimoire.", target: "h2:contains('Brew New Elixir Schedule') , #medicineForm", tab: "schedule" },
                    { title: "Schedule Form", text: "This form is where you add a new elixir: name, dose, time and frequency.", target: "#medicineForm", tab: "schedule" },
                    { title: "Current Elixirs", text: "All active elixirs are listed here. Edit or remove them as needed.", target: "#medicineList", tab: "schedule" },
                    { title: "User Dashboard - Overview", text: "The User Dashboard shows upcoming reminders and quick stats.", target: "#userDashboard h2, #upcomingRemindersList", tab: "userDashboard" },
                    { title: "Upcoming Reminders", text: "Upcoming reminders list your next scheduled doses.", target: "#upcomingRemindersList", tab: "userDashboard" },
                    { title: "Past Reminders", text: "Past reminders are listed here — useful for audit and history.", target: "#pastRemindersList", tab: "userDashboard" },
                    { title: "📊 Wellness Dashboard", text: "This is your Wellness Dashboard. It summarizes adherence, missed doses, and provides insights to improve consistency.", target: "#dashboard h2", tab: "dashboard" },
                    { title: "Wellness Rate", text: "At the very top, you'll see your current wellness/adherence rating.", target: "#wellnessRate", tab: "dashboard" },
                    { title: "Predictions & Risk", text: "This panel contains predictions and risk assessments for adherence.", target: "#predictionPanel", tab: "dashboard" },
                    { title: "Missed Dose History", text: "Missed Dose History logs every missed intake for review.", target: "#missedHistoryCard", tab: "dashboard" },
                    { title: "Adherence Trends", text: "Adherence Trends chart shows your weekly performance.", target: "#adherenceChartMain", tab: "dashboard" },
                    { title: "Taken vs Missed", text: "This chart compares taken vs missed doses.", target: "#missedVsTakenChart", tab: "dashboard" },
                    { title: "30-Day Progress", text: "30-day trend shows long-term improvements or declines.", target: "#trendLineChart", tab: "dashboard" },
                    { title: "⏰ Upcoming Performances", text: "Here you’ll see all scheduled doses for the day — whether they're taken, missed, or upcoming. It’s a quick way to stay on track with your regimen.", target: "#upcomingDoses" },
                    { title: "Streak Dashboard", text: "Here you can see your current and longest streak records.", target: "#currentStreak", tab: "streakTab" },
                ];

                function queryByContains(selectorWithContains) {
                    try {
                        if (!selectorWithContains) return null;
                        const parts = selectorWithContains.split(',').map(s => s.trim());
                        for (const p of parts) {
                            const m = /^(.*):contains\(['"](.+)['"]\)$/.exec(p);
                            if (m) {
                                const tag = m[1];
                                const txt = m[2].toLowerCase();
                                const nodes = Array.from(document.querySelectorAll(tag));
                                const found = nodes.find(n => (n.textContent || '').toLowerCase().includes(txt));
                                if (found) return found;
                            } else {
                                const el = document.querySelector(p);
                                if (el) return el;
                            }
                        }
                        return null;
                    } catch (e) {
                        return null;
                    }
                }

                function getTargetElement(selector) {
                    if (!selector) return null;
                    try {
                        const el = document.querySelector(selector);
                        if (el) return el;
                    } catch (e) { }
                    return queryByContains(selector);
                }

                const floating = document.getElementById('floatingWitch');
                const wizardBox = document.getElementById('wizardTutorial');
                const wizardTitle = document.getElementById('wizardTitle');
                const wizardProgress = document.getElementById('wizardProgress');
                const wizardText = document.getElementById('wizardText');
                const btnNext = document.getElementById('wizardNext');
                const btnPrev = document.getElementById('wizardPrev');
                const btnSkip = document.getElementById('wizardSkip');
                const startBtn = document.getElementById('startGuideBtn');

                if (!startBtn) {
                    const alt = document.getElementById('startFlight');
                    if (alt) alt.id = 'startGuideBtn';
                }

                const realStartBtn = document.getElementById('startGuideBtn');
                let idx = 0;
                let running = false;

                function moveWitchNearDialogue() {
                    if (!floating || !wizardBox) return;
                    const boxRect = wizardBox.getBoundingClientRect();
                    const witchLeft = boxRect.left - 300;
                    const witchTop = boxRect.top + boxRect.height / 2 - 50;
                    floating.style.left = witchLeft + 'px';
                    floating.style.top = witchTop + 'px';
                }

                function showWizardBox() {
                    if (!wizardBox) return;
                    wizardBox.classList.add('visible');
                    wizardBox.style.display = 'block';
                    wizardBox.style.opacity = 1;
                    setTimeout(moveWitchNearDialogue, 50);
                }

                function hideWizardBox() {
                    if (!wizardBox) return;
                    wizardBox.classList.remove('visible');
                    wizardBox.style.opacity = 0;
                    setTimeout(() => { wizardBox.style.display = 'none'; }, 320);
                }

                async function gotoStep(i) {
                    if (!steps[i]) return;
                    const step = steps[i];
                    if (wizardTitle) wizardTitle.textContent = step.title || '';
                    if (wizardText) wizardText.textContent = step.text || '';
                    if (wizardProgress) wizardProgress.textContent = `Step ${i + 1} / ${steps.length}`;
                    if (step.tab && typeof switchTab === 'function') {
                        try {
                            switchTab(step.tab);
                            await new Promise(r => setTimeout(r, 250));
                        } catch (e) { }
                    }
                    const el = getTargetElement(step.target);
                    if (el) {
                        try { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                        catch (e) { window.scrollTo({ top: 0, behavior: 'smooth' }); }
                        await new Promise(r => setTimeout(r, 520));
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        await new Promise(r => setTimeout(r, 320));
                    }
                    showWizardBox();
                    btnPrev.disabled = i === 0;
                    btnNext.textContent = i === steps.length - 1 ? 'Finish' : 'Next';
                }

                function startTutorial() {
                    const witch = document.getElementById("floatingWitch");
                    witch.style.display = "block";
                    void witch.offsetWidth;
                    witch.classList.add("show-entry");
                    const wizardBox = document.getElementById("wizardTutorial");
                    wizardBox.style.display = "block";
                    wizardBox.classList.add("visible");
                    wizardBox.style.opacity = 1;
                    moveWitchNearDialogue();
                }

                function nextStep() {
                    if (!running) return;
                    if (idx < steps.length - 1) {
                        hideWizardBox();
                        idx++;
                        setTimeout(() => gotoStep(idx), 260);
                    } else {
                        endTutorial();
                    }
                }

                function prevStep() {
                    if (!running) return;
                    if (idx > 0) {
                        hideWizardBox();
                        idx--;
                        setTimeout(() => gotoStep(idx), 260);
                    }
                }

                function endTutorial() {
                    if (!running && !wizardBox.classList.contains("visible")) return;
                    running = false;
                    idx = 0;
                    if (wizardBox) {
                        wizardTitle.textContent = "✨ Tutorial Complete!";
                        wizardText.textContent = "You’ve now explored all sections of the Grimoire. May your elixirs always brew on time!";
                        wizardProgress.textContent = "✔ All steps done";
                        btnNext.style.display = "none";
                        btnPrev.style.display = "none";
                        btnSkip.textContent = "Close";
                        wizardBox.classList.add('visible');
                        wizardBox.style.display = 'block';
                        wizardBox.style.opacity = 1;
                        btnSkip.disabled = true;
                        setTimeout(() => {
                            hideWizardBox();
                            if (floating) floating.style.display = 'none';
                            btnNext.style.display = "";
                            btnPrev.style.display = "";
                            btnSkip.textContent = "Skip";
                            btnSkip.disabled = false;
                        }, 2500);
                    } else {
                        hideWizardBox();
                        if (floating) floating.style.display = 'none';
                    }
                }

                function summonSparkles(x = 100, y = 500) {
                    for (let i = 0; i < 100; i++) {
                        const star = document.createElement("div");
                        star.className = "sparkle";
                        star.style.left = x + (Math.random() * 100 - 50) + "px";
                        star.style.top = y + (Math.random() * 100 - 50) + "px";
                        document.body.appendChild(star);
                        setTimeout(() => star.remove(), 1500);
                    }
                }

                (function attachButtons() {
                    const s = document.getElementById('startGuideBtn');
                    if (s) {
                        s.style.display = '';
                        s.addEventListener('click', e => {
                            e.preventDefault();
                            if (running) return;
                            running = true;
                            summonSparkles(window.innerWidth * 0.1, window.innerHeight * 0.8);
                            setTimeout(() => {
                                const witch = document.getElementById("floatingWitch");
                                witch.style.display = "block";
                                void witch.offsetWidth;
                                witch.classList.add("show-entry");
                                startTutorial();
                                setTimeout(() => {
                                    gotoStep(0);
                                }, 400);
                            }, 300);
                        });
                    }
                    if (btnNext) {
                        btnNext.addEventListener('click', e => {
                            e.preventDefault();
                            nextStep();
                        });
                    }
                    if (btnPrev) {
                        btnPrev.addEventListener('click', e => {
                            e.preventDefault();
                            prevStep();
                        });
                    }
                    if (btnSkip) {
                        btnSkip.addEventListener('click', e => {
                            e.preventDefault();
                            if (!running && !wizardBox.classList.contains("visible")) return;
                            endTutorial();
                        });
                    }
                })();

            </script>
</body>

</html>
