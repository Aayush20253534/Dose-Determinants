<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemist's Grand Grimoire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #4a1c40 0%, #2d1b3d 50%, #1a0f2e 100%);
            color: #f4e4c1;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Magical background effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 70%, rgba(255, 105, 180, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
            border-radius: 20px;
            border: 2px dashed #ffb347;
            position: relative;
        }

        .header::before {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            left: 20px;
            font-size: 24px;
            animation: sparkle 2s infinite;
        }

        .header::after {
            content: 'üîÆ';
            position: absolute;
            top: -10px;
            right: 20px;
            font-size: 24px;
            animation: sparkle 2s infinite 1s;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .header h1 {
            font-size: 3rem;
            color: #ffb347;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            font-style: italic;
            color: #e6d3a3;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 5px;
        }

        .nav-tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: #f4e4c1;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            margin: 0 5px;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #ffb347, #ff6b6b);
            color: #2d1b3d;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 179, 71, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 179, 71, 0.2);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 179, 71, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 179, 71, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffb347;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 179, 71, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #f4e4c1;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ffb347;
            box-shadow: 0 0 10px rgba(255, 179, 71, 0.3);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ffb347);
            color: #2d1b3d;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .medicine-list {
            display: grid;
            gap: 20px;
        }

        .medicine-item {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #ffb347;
            position: relative;
            transition: all 0.3s ease;
        }

        .medicine-item:hover {
            background: rgba(0, 0, 0, 0.8);
            border-left-color: #ff6b6b;
        }

        .medicine-item h3 {
            color: #ffb347;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .medicine-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: rgba(255, 179, 71, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #ffb347;
            font-weight: bold;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 179, 71, 0.1), rgba(255, 107, 107, 0.1));
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 179, 71, 0.3);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: #ffb347;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #e6d3a3;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .chart {
            width: 100%;
            height: 300px;
            background: rgba(255, 179, 71, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ffb347;
        }

        .upcoming-doses {
            max-height: 400px;
            overflow-y: auto;
        }

        .dose-item {
            background: rgba(255, 179, 71, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ffb347;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dose-time {
            font-weight: bold;
            color: #ffb347;
        }

        .dose-medicine {
            color: #e6d3a3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffb347);
            color: #2d1b3d;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.8s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.fade-out {
            opacity: 0;
        }


        .mystic-fortune {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(255, 105, 180, 0.2));
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .fortune-text {
            font-size: 1.3rem;
            font-style: italic;
            color: #e6d3a3;
            margin-bottom: 15px;
        }

        .fortune-crystal {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .wellness-rate {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .wellness-excellent {
            color: #4ecdc4;
        }

        .wellness-good {
            color: #45b7d1;
        }

        .wellness-fair {
            color: #f9ca24;
        }

        .wellness-poor {
            color: #f0932b;
        }

        .wellness-critical {
            color: #eb4d4b;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé™ Alchemist's Grand Grimoire üé™</h1>
            <p>Where Circus Magic Meets Medicine Mastery</p>
        </div>

        <div class="nav-tabs">

            <button class="nav-tab active" onclick="switchTab('schedule')">üìã Schedule Potions</button>
            <button class="nav-tab" onclick="switchTab('userDashboard')">üìÖ User Dashboard</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">üìä Wellness Dashboard</button>
            <button class="nav-tab" onclick="switchTab('mystic')">üîÆ Mystic Fortune</button>
            <button onclick="showDailySummary()" class="btn">üìä View Daily Summary</button>

            <div id="clock" style="
    position: fixed;
    top: 20px;
    right: 20px;
    background:black;
    padding: 10px 20px;
    border-radius: 15px;
    font-size: 1.2rem;
    color: #ffb347;
    font-weight: bold;
    box-shadow: 0 5px 15px rgba(3, 3, 3, 0.3);
    z-index: 1000;
"></div>
        </div>

        <div id="streakCounter" style="margin: 15px 0; font-size: 1.2rem; font-weight: bold; color: #ffb347;">
            üî• Current Streak: 0 days
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content active">
            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">üß™ Brew New Elixir Schedule</h2>
                <form id="medicineForm">
                    <div class="form-group">
                        <label for="medicineName">üß¥ Potion Name:</label>
                        <input type="text" id="medicineName" required placeholder="e.g., Paracetamol">
                    </div>
                    <div class="form-group">
                        <label for="email">üìß User Email:</label>
                        <input type="email" id="email" required placeholder="e.g., user@example.com">
                    </div>

                    <div class="form-group">
                        <label for="dosage">üìè Dosage:</label>
                        <input type="text" id="dosage" required placeholder="e.g., 500 mg">
                    </div>

                    <div class="form-group">
                        <label for="time">‚è∞ First Dose Time:</label>
                        <input type="time" id="time" required>
                    </div>

                    <div class="form-group">
                        <label for="frequency">üìÖ Frequency:</label>
                        <select id="frequency" required>
                            <option value="">Select frequency</option>
                            <option value="onceDaily">Once a day</option>
                            <option value="twiceDaily">Twice a day (every 12 hrs)</option>
                            <option value="every8h">Every 8 hours</option>
                            <option value="everyOtherDay">Every other day</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="duration">üóìÔ∏è Duration:</label>
                        <input type="number" id="duration" required min="1" max="365" placeholder="e.g., 7 days">
                    </div>

                    <button type="submit" class="btn btn-primary">‚ûï Add Medication</button>
                </form>

            </div>

            <div class="card">
                <h2 style="color: #ffb347; margin-bottom: 20px;">üìú Current Elixir Schedules</h2>
                <div id="medicineList" class="medicine-list"></div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="mystic-fortune">
                <div class="fortune-crystal">üîÆ</div>
                <div class="wellness-rate" id="wellnessRate">Calculating Wellness Rate...</div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMedicines">0</div>
                    <div class="stat-label">Active Elixirs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="takenToday">0</div>
                    <div class="stat-label">Taken Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="missedToday">0</div>
                    <div class="stat-label">Missed Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adherenceRate">0%</div>
                    <div class="stat-label">Adherence Rate</div>
                </div>
            </div>

            <div class="card" id="predictionCard" style="margin-bottom:20px;">
                <h3 style="color: #ffb347; margin-bottom: 12px;">ü§ñ Adherence Predictions & Risk</h3>
                <div id="predictionPanel">
                    <p style="color:#e6d3a3;">Analyzing adherence patterns...</p>
                </div>
            </div>



            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìà Adherence Trends Over Time</h3>
                <canvas id="adherenceChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìä Missed vs Taken Doses</h3>
                <canvas id="missedVsTakenChart"
                    style="max-width: 250px; max-height: 250px; margin: 0 auto; display: block;"></canvas>

            </div>

            <div class="chart-container">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìâ Adherence Progress Over 30 Days</h3>
                <canvas id="trendLineChart"></canvas>
            </div>


            <div class="card">
                <h3 style="color: #ffb347; margin-bottom: 15px;">‚è∞ Upcoming Performances</h3>
                <div id="upcomingDoses" class="upcoming-doses"></div>
            </div>

        </div>

        <!-- Mystic Fortune Tab -->
        <div id="mystic" class="tab-content">
            <div class="mystic-fortune">
                <div class="fortune-crystal">üîÆ</div>
                <h2 style="color: #ffb347; margin-bottom: 20px;">Mystic Fortune Teller</h2>
                <div class="fortune-text" id="fortuneText">
                    The crystal ball swirls with mystical energy, ready to reveal your wellness destiny...
                </div>
                <button class="btn btn-primary" onclick="generateFortune()">üåü Consult the Oracle</button>
            </div>

            <div class="card">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üé™ Circus Crier Announcements</h3>
                <div id="circusCrier">
                    <p style="font-style: italic; color: #e6d3a3;">
                        "Hear ye, hear ye! The Circus Crier will announce important reminders and wellness updates
                        here!"
                    </p>
                </div>
            </div>



            <div class="card">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üóìÔ∏è Great Sky Calendar Sync</h3>
                <p style="color: #e6d3a3; margin-bottom: 15px;">
                    Connect your Grimoire to the celestial calendar for enhanced predictions and cosmic timing.
                </p>
                <button class="btn btn-primary" onclick="syncCalendar()">üåô Sync with Stars</button>
            </div>
        </div>
    </div>
    <!-- User Dashboard Tab -->
    <div id="userDashboard" class="tab-content">
        <div class="card">
            <h2 style="color: #ffb347; margin-bottom: 20px;">üìÖ Upcoming Reminders</h2>
            <div id="upcomingRemindersList"></div>
        </div>

        <div class="card">
            <h2 style="color: #ffb347; margin-bottom: 20px;">üìú Past Reminders</h2>
            <button class="btn btn-danger" onclick="clearPastReminders()">üóëÔ∏è Clear All Past Reminders</button>
            <div id="pastRemindersList" style="margin-top: 15px;"></div>
        </div>

    </div>


    <div id="notification" class="notification">
        <span id="notificationText"></span>
        <button id="snoozeBtn"
            style="display:none; margin-left:10px; padding:5px 10px; border:none; border-radius:5px; background:#4ecdc4; color:#fff; cursor:pointer;">
            Snooze 15 min
        </button>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let medicines = JSON.parse(localStorage.getItem('medicines') || '[]');
        let doseLogs = JSON.parse(localStorage.getItem('doseLogs') || '[]');
        let currentEditingId = null;
        let notificationTimeout; // üî• add this globally (top of script or before showNotification)

        // Fortune texts
        const fortunes = [
            "The stars align favorably for your wellness journey. Consistency in your elixir consumption will bring magical results.",
            "A missed dose in your future I foresee... But fear not, the Circus Crier will guide you back to the path of wellness.",
            "Your dedication to health shines brighter than the circus lights. The performers celebrate your commitment!",
            "Beware of forgetfulness on the third day hence. Set extra reminders, for the show must go on!",
            "The mystical energies suggest a 95% adherence rate in your near future. Your discipline impresses even the wise owls.",
            "I see great vitality in your aura. Your elixirs work in harmony with your body's natural rhythms.",
            "A challenging period approaches, but your established routine will be your guiding star through the storm."
        ];

        // Circus Crier announcements
        const crierAnnouncements = [
            "üé™ Attention performers! Remember your morning strength elixir before the aerial acts!",
            "üé≠ The show starts in 30 minutes - time for your pre-performance potions!",
            "‚ö° Energy levels looking optimal today thanks to consistent elixir adherence!",
            "üåü Outstanding wellness performance this week! The audience applauds your dedication!",
            "üé™ New safety protocol: Double-check your elixir schedule before entering the ring!",
            "üé® The Alchemist has brewed fresh batches - your supply is ready for pickup!"
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            renderMedicines();
            updateDashboard();
            setupNotifications();
            generateRandomCrierAnnouncement();
            updateStreakDisplay();
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked nav tab
            event.target.classList.add('active');

            // Update dashboard if switching to dashboard tab
            if (tabName === 'dashboard') {
                updateDashboard();
            }
            if (tabName === 'userDashboard') {
                renderUserDashboard();
            }

        }

        // Render medicines list
        function renderMedicines() {
            const container = document.getElementById('medicineList');

            if (medicines.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e6d3a3;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìú</div>
                        <p>No elixirs in your Grimoire yet. Add your first magical formula above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = medicines.map(medicine => `
                <div class="medicine-item">
                    <h3>üß™ ${medicine.name}</h3>
                    <div class="medicine-details">
                        <div class="detail-item">
                            <span class="detail-label">Dosage:</span> ${medicine.dosage}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Time:</span> ${formatTime(medicine.time)}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Frequency:</span> ${medicine.frequency}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="editMedicine('${medicine.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteMedicine('${medicine.id}')">üóëÔ∏è Remove</button>
                        <button class="btn btn-primary" onclick="markAsTaken('${medicine.id}')">‚úÖ Mark Taken</button>
                    </div>
                </div>
            `).join('');
        }

        // Format time for display
        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Edit medicine
        function editMedicine(id) {
            const medicine = medicines.find(med => med.id === id);
            if (medicine) {
                document.getElementById('medicineName').value = medicine.name;
                document.getElementById('dosage').value = medicine.dosage;
                document.getElementById('time').value = medicine.time;
                document.getElementById('frequency').value = medicine.frequency;
                currentEditingId = id;
                switchTab('schedule');
                showNotification('üìù Ready to edit elixir formula');
            }
        }

        // Delete medicine
        function deleteMedicine(id) {
            if (confirm('Are you sure you want to remove this elixir from your Grimoire?')) {
                medicines = medicines.filter(med => med.id !== id);
                localStorage.setItem('medicines', JSON.stringify(medicines));
                renderMedicines();
                updateDashboard();
                showNotification('üóëÔ∏è Elixir removed from Grimoire');
            }
        }

        // Mark medicine as taken
        function markAsTaken(id) {
            const medicine = medicines.find(med => med.id === id);
            if (!medicine) return;

            const now = new Date();
            const today = now.toDateString();

            // Find last time this medicine was taken
            const lastTaken = doseLogs
                .filter(log => log.medicineId === id && log.status === 'taken')
                .sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt))[0];

            // Calculate next allowed time based on frequency
            let nextAllowedTime = null;
            if (lastTaken) {
                const lastDate = new Date(lastTaken.takenAt);
                nextAllowedTime = new Date(lastDate);

                switch (medicine.frequency) {
                    case "onceDaily":
                        nextAllowedTime.setDate(lastDate.getDate() + 1);
                        break;
                    case "twiceDaily":
                        nextAllowedTime.setHours(lastDate.getHours() + 12);
                        break;
                    case "every8h":
                        nextAllowedTime.setHours(lastDate.getHours() + 8);
                        break;
                    case "everyOtherDay":
                        nextAllowedTime.setDate(lastDate.getDate() + 2);
                        break;
                    case "weekly":
                        nextAllowedTime.setDate(lastDate.getDate() + 7);
                        break;
                }
            }

            // If frequency time hasn‚Äôt arrived yet ‚Üí block marking
            if (nextAllowedTime && now < nextAllowedTime) {
                showNotification(
                    `‚è≥ Too early! Next dose of ${medicine.name} is allowed after ${nextAllowedTime.toLocaleString()}`,
                    6000 // optional: keep it visible slightly longer
                );
                return;
            }

            // Otherwise mark as taken
            const log = {
                medicineId: id,
                medicineName: medicine.name,
                takenAt: now.toISOString(),
                status: 'taken'
            };
            doseLogs.push(log);
            localStorage.setItem('doseLogs', JSON.stringify(doseLogs));
            renderUserDashboard();
            updateUpcomingDoses(); // ‚úÖ refresh next dose display
            checkDueMedicines();   // ‚úÖ recheck if any reminders should fire
            showNotification(`‚ú® ${medicine.name} marked as taken!`);
            updateStreakDisplay();


        }


        // Update dashboard
        function updateDashboard() {
            const today = new Date().toDateString();

            let totalMedicines = 0;
            let takenToday = 0;
            let missedToday = 0;

            medicines.forEach(med => {
                totalMedicines++;

                // Did user take this today?
                const taken = doseLogs.some(log =>
                    log.medicineId === med.id &&
                    new Date(log.takenAt).toDateString() === today
                );

                if (taken) {
                    takenToday++;
                } else {
                    // Check if scheduled time has already passed
                    const [hours, minutes] = med.time.split(':');
                    const doseTime = new Date();
                    doseTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                    if (doseTime < new Date()) {
                        missedToday++;
                    }
                }
            });

            const adherenceRate = totalMedicines > 0 ?
                Math.round((takenToday / totalMedicines) * 100) : 0;

            // Update dashboard UI
            document.getElementById('totalMedicines').textContent = totalMedicines;
            document.getElementById('takenToday').textContent = takenToday;
            document.getElementById('missedToday').textContent = missedToday;
            document.getElementById('adherenceRate').textContent = adherenceRate + '%';

            updateWellnessRate(adherenceRate);
            updateUpcomingDoses();
            renderAdherenceChart();
            renderMissedVsTakenChart();
            renderTrendLineChart();
        }
        let adherenceChartInstance = null;

        function renderAdherenceChart() {
            const ctx = document.getElementById('adherenceChart').getContext('2d');

            // Collect last 7 days adherence
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayStr = date.toDateString();

                const medsToday = medicines.length;
                const takenToday = doseLogs.filter(log =>
                    new Date(log.takenAt).toDateString() === dayStr &&
                    log.status === 'taken'
                ).length;

                const adherence = medsToday > 0 ? Math.round((takenToday / medsToday) * 100) : 0;
                labels.push(date.toLocaleDateString(undefined, { weekday: 'short' }));
                data.push(adherence);
            }

            // Destroy old chart before re-creating
            if (adherenceChartInstance) {
                adherenceChartInstance.destroy();
            }

            adherenceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Adherence %',
                        data: data,
                        backgroundColor: 'rgba(255, 179, 71, 0.6)',
                        borderColor: '#ffb347',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }


        // Render Missed vs Taken chart
        function renderMissedVsTakenChart() {
            const ctx = document.getElementById('missedVsTakenChart').getContext('2d');
            const today = new Date().toDateString();

            const taken = doseLogs.filter(log => new Date(log.takenAt).toDateString() === today).length;
            const missed = medicines.length > 0 ? medicines.length - taken : 0;

            if (window.missedVsTakenChartInstance) {
                window.missedVsTakenChartInstance.destroy();
            }

            window.missedVsTakenChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Taken', 'Missed'],
                    datasets: [{
                        data: [taken, missed],
                        backgroundColor: ['#4ecdc4', '#eb4d4b'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Render 30-day adherence trend line
        function renderTrendLineChart() {
            const ctx = document.getElementById('trendLineChart').getContext('2d');
            const labels = [];
            const data = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayStr = date.toDateString();

                const medsToday = medicines.length;
                const takenToday = doseLogs.filter(log =>
                    new Date(log.takenAt).toDateString() === dayStr &&
                    log.status === 'taken'
                ).length;

                const adherence = medsToday > 0 ? Math.round((takenToday / medsToday) * 100) : 0;
                labels.push(date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                data.push(adherence);
            }

            if (window.trendLineChartInstance) {
                window.trendLineChartInstance.destroy();
            }

            window.trendLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Daily Adherence %',
                        data,
                        borderColor: '#ffb347',
                        backgroundColor: 'rgba(255,179,71,0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Update wellness rate display
        function updateWellnessRate(rate) {
            const wellnessElement = document.getElementById('wellnessRate');
            let ratingText = '';
            let ratingClass = '';

            if (rate >= 90) {
                ratingText = '‚ú® Excellent Wellness ‚ú®';
                ratingClass = 'wellness-excellent';
            } else if (rate >= 75) {
                ratingText = 'üåü Good Wellness üåü';
                ratingClass = 'wellness-good';
            } else if (rate >= 50) {
                ratingText = '‚ö° Fair Wellness ‚ö°';
                ratingClass = 'wellness-fair';
            } else if (rate >= 25) {
                ratingText = '‚ö†Ô∏è Poor Wellness ‚ö†Ô∏è';
                ratingClass = 'wellness-poor';
            } else {
                ratingText = 'üö® Critical Wellness üö®';
                ratingClass = 'wellness-critical';
            }

            wellnessElement.textContent = ratingText;
            wellnessElement.className = `wellness-rate ${ratingClass}`;
        }

        // Update upcoming doses
        function updateUpcomingDoses() {
            const container = document.getElementById('upcomingDoses');
            const now = new Date();
            const upcoming = [];

            medicines.forEach(medicine => {
                // Find the last time this medicine was taken
                const lastTaken = doseLogs
                    .filter(log => log.medicineId === medicine.id && log.status === 'taken')
                    .sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt))[0];

                let nextDoseTime;

                if (lastTaken) {
                    // If already taken, calculate next based on frequency
                    nextDoseTime = new Date(lastTaken.takenAt);
                    switch (medicine.frequency) {
                        case "onceDaily":
                            nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                            break;
                        case "twiceDaily":
                            nextDoseTime.setHours(nextDoseTime.getHours() + 12);
                            break;
                        case "every8h":
                            nextDoseTime.setHours(nextDoseTime.getHours() + 8);
                            break;
                        case "everyOtherDay":
                            nextDoseTime.setDate(nextDoseTime.getDate() + 2);
                            break;
                        case "weekly":
                            nextDoseTime.setDate(nextDoseTime.getDate() + 7);
                            break;
                        default:
                            // fallback: same time tomorrow
                            nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                    }
                } else {
                    // If never taken, use the initial scheduled time
                    const [hours, minutes] = medicine.time.split(':');
                    nextDoseTime = new Date();
                    nextDoseTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    if (nextDoseTime <= now) {
                        nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                    }
                }

                upcoming.push({
                    medicine: medicine.name,
                    time: nextDoseTime,
                    displayTime: nextDoseTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });
            });


            // Sort by time
            upcoming.sort((a, b) => a.time - b.time);

            if (upcoming.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #e6d3a3;">No upcoming doses scheduled</p>';
                return;
            }

            container.innerHTML = upcoming.map(dose => `
                <div class="dose-item">
                    <div>
                        <div class="dose-time">${dose.displayTime}</div>
                        <div class="dose-medicine">üß™ ${dose.medicine}</div>
                    </div>
                    <div style="color: #ffb347;">
                        ${dose.time.toDateString() === now.toDateString() ? 'Today' : 'Tomorrow'}
                    </div>
                </div>
            `).join('');
        }
        function renderUserDashboard() {
            const now = new Date();

            const upcomingReminders = medicines.map(med => {
                // Find the last taken dose for this medicine
                const lastTaken = doseLogs
                    .filter(log => log.medicineId === med.id && log.status === 'taken')
                    .sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt))[0];

                let nextDoseTime;

                if (lastTaken) {
                    nextDoseTime = new Date(lastTaken.takenAt);

                    switch (med.frequency) {
                        case "onceDaily":
                            nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                            break;
                        case "twiceDaily":
                            nextDoseTime.setHours(nextDoseTime.getHours() + 12);
                            break;
                        case "every8h":
                            nextDoseTime.setHours(nextDoseTime.getHours() + 8);
                            break;
                        case "everyOtherDay":
                            nextDoseTime.setDate(nextDoseTime.getDate() + 2);
                            break;
                        case "weekly":
                            nextDoseTime.setDate(nextDoseTime.getDate() + 7);
                            break;
                        default:
                            nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                    }
                } else {
                    // Fallback if never taken
                    const [hours, minutes] = med.time.split(':');
                    nextDoseTime = new Date();
                    nextDoseTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    if (nextDoseTime < now) nextDoseTime.setDate(nextDoseTime.getDate() + 1);
                }

                return {
                    name: med.name,
                    time: nextDoseTime,
                    status: '‚è≥ Upcoming'
                };
            }).sort((a, b) => a.time - b.time);


            const pastReminders = doseLogs
                .map(log => ({
                    name: log.medicineName,
                    time: new Date(log.takenAt),
                    status: log.status === 'taken' ? '‚úÖ Taken' : '‚ùå Missed'
                }))
                .sort((a, b) => b.time - a.time);

            // Render Upcoming
            const upcomingContainer = document.getElementById('upcomingRemindersList');
            if (upcomingReminders.length === 0) {
                upcomingContainer.innerHTML = `<p style="color: #e6d3a3;">No upcoming reminders scheduled.</p>`;
            } else {
                upcomingContainer.innerHTML = upcomingReminders.map(reminder => `
            <div class="dose-item" style="display: flex; justify-content: space-between;">
                <div>
                    <div class="dose-time">${reminder.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="dose-medicine">üß™ ${reminder.name}</div>
                </div>
                <div style="font-weight: bold; color: #4ecdc4;">${reminder.status}</div>
            </div>
        `).join('');
            }

            // Render Past
            const pastContainer = document.getElementById('pastRemindersList');
            if (pastReminders.length === 0) {
                pastContainer.innerHTML = `<p style="color: #e6d3a3;">No past reminders recorded yet.</p>`;
            } else {
                pastContainer.innerHTML = pastReminders.map(reminder => `
            <div class="dose-item" style="display: flex; justify-content: space-between;">
                <div>
                    <div class="dose-time">${reminder.time.toLocaleString()}</div>
                    <div class="dose-medicine">üß™ ${reminder.name}</div>
                </div>
                <div style="font-weight: bold; color: ${reminder.status.includes('‚úÖ') ? '#4ecdc4' : '#eb4d4b'};">
                    ${reminder.status}
                </div>
            </div>
        `).join('');
            }
        }


        function showNotification(message, duration = 4000, options = {}) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const snoozeBtn = document.getElementById('snoozeBtn');

            if (notificationTimeout) clearTimeout(notificationTimeout);

            // Reset state
            notification.classList.remove('show', 'fade-out');
            snoozeBtn.style.display = options.allowSnooze ? 'inline-block' : 'none';

            snoozeBtn.onclick = () => {
                notification.classList.remove('show');
                scheduleSnoozeReminder(options.medicineId || null, 15);
            };

            setTimeout(() => {
                notificationText.textContent = message;
                notification.classList.add('show');
            }, 50);

            notificationTimeout = setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.classList.remove('show', 'fade-out');
                }, 800);
            }, duration);
        }



        // Check for due medicines
        function checkDueMedicines() {
            const now = new Date();

            medicines.forEach(medicine => {
                const [hours, minutes] = medicine.time.split(':');
                const scheduled = new Date();
                scheduled.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                const diff = Math.abs(now - scheduled);

                if (diff <= 60000) { // ‚úÖ within 1 min window
                    showNotification(
                        `üîî Time for ${medicine.name}! Dosage: ${medicine.dosage}`,
                        8000,
                        { allowSnooze: true, medicineId: medicine.id }
                    );

                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('üé™ Alchemist\'s Reminder', {
                            body: `Time for ${medicine.name}! Dosage: ${medicine.dosage}`,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üß™</text></svg>'
                        });
                    }
                }
            });

        }

        // Show notification



        function scheduleSnoozeReminder(medicineId, minutes) {
            const med = medicines.find(m => m.id === medicineId);
            if (!med) return;

            const snoozeTime = new Date(Date.now() + minutes * 60 * 1000);

            showNotification(`üîî Snoozed! I‚Äôll remind you about ${med.name} at ${snoozeTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`, 4000);

            setTimeout(() => {
                showNotification(`‚è∞ Time to take ${med.name}!`, 8000, { allowSnooze: true, medicineId });
            }, minutes * 60 * 1000);
        }


        function updateClock() {
            const clock = document.getElementById('clock');
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            clock.textContent = `üï∞Ô∏è ${hours}:${minutes}:${seconds}`;
        }
        function clearPastReminders() {
            if (confirm("Are you sure you want to clear all past reminders? This action cannot be undone.")) {
                doseLogs = []; // ‚úÖ Clear the dose log array in memory
                localStorage.setItem('doseLogs', JSON.stringify(doseLogs)); // ‚úÖ Save empty array to localStorage
                renderUserDashboard(); // ‚úÖ Refresh the dashboard view
                showNotification('üßπ All past reminders cleared successfully!');
                updateStreakDisplay();
            }
        }


        // Initialize clock
        updateClock();
        setInterval(updateClock, 1000);


        // Generate fortune
        function generateFortune() {
            const randomFortune = fortunes[Math.floor(Math.random() * fortunes.length)];
            document.getElementById('fortuneText').textContent = randomFortune;
            showNotification('üîÆ The Oracle has spoken!');
        }

        function showDailySummary() {
            const today = new Date().toDateString();
            let taken = 0;
            let missed = 0;
            let total = 0;

            // Count today's taken and missed doses
            doseLogs.forEach(log => {
                const logDate = new Date(log.takenAt).toDateString();
                if (logDate === today) {
                    total++;
                    if (log.status === 'taken') taken++;
                    if (log.status === 'missed') missed++;
                }
            });

            // Count upcoming doses for tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowString = tomorrow.toDateString();

            let upcomingTomorrow = 0;
            medicines.forEach(med => {
                const [hours, minutes] = med.time.split(':');
                const doseTime = new Date();
                doseTime.setDate(tomorrow.getDate());
                doseTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                if (doseTime.toDateString() === tomorrowString) {
                    upcomingTomorrow++;
                }
            });

            // Build the message
            const summaryMessage = `
            üìÖ Daily Summary:
            ‚úÖ Taken: ${taken}
            ‚ùå Missed: ${missed}
            ‚è≥ Upcoming Tomorrow: ${upcomingTomorrow}`;

            // Show the notification
            showNotification(summaryMessage, 8000);
        }

        // üïí Check once a minute if it's time for the daily summary
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 21 && now.getMinutes() === 0) {
                showDailySummary();
            }
        }, 60000);

        // Generate random circus crier announcement
        function generateRandomCrierAnnouncement() {
            const randomAnnouncement = crierAnnouncements[Math.floor(Math.random() * crierAnnouncements.length)];
            document.getElementById('circusCrier').innerHTML = `
                <div style="background: rgba(255, 179, 71, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #ffb347;">
                    <p style="font-style: italic; color: #e6d3a3; margin-bottom: 10px;">${randomAnnouncement}</p>
                    <small style="color: #ffb347;">- The Circus Crier, ${new Date().toLocaleTimeString()}</small>
                </div>
            `;
        }
        // inside your submit handler, after building formData
        document.getElementById('medicineForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                id: currentEditingId || Date.now().toString(),
                name: document.getElementById('medicineName').value,
                dosage: document.getElementById('dosage').value,
                time: document.getElementById('time').value,
                frequency: document.getElementById('frequency').value,
                duration: parseInt(document.getElementById('duration').value),
                createdAt: new Date().toISOString()
            };

            if (currentEditingId) {
                const index = medicines.findIndex(med => med.id === currentEditingId);
                medicines[index] = { ...medicines[index], ...formData };
                showNotification('üß™ Elixir formula updated successfully!');
                currentEditingId = null;
            } else {
                medicines.push(formData);
                showNotification('‚ú® New elixir added to the Grimoire!');
            }

            localStorage.setItem('medicines', JSON.stringify(medicines));
            renderMedicines();
            updateDashboard();

            // ‚úÖ Add THIS section here:
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const payload = {
                medicineName: formData.name,
                dosage: formData.dosage,
                time: formData.time,
                frequency: formData.frequency,
                duration: formData.duration,
                email: document.getElementById('email').value,
                startDate: new Date().toISOString().split('T')[0],
                timezone: userTimezone
            };

            fetch("http://localhost:3000/addSchedule", {  // <-- make sure port matches backend
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(resp => {
                    console.log('üì° Server schedule response:', resp);
                })
                .catch(err => {
                    console.warn('‚ùå Failed to add schedule to server:', err);
                });

            this.reset();
            updateStreakDisplay();
        });
        /* ---------------------------
   AI-Like Adherence Predictor
   --------------------------- */

        // Utility: parse frequency into hours (approx)
        function frequencyToHours(freq) {
            switch (freq) {
                case "onceDaily": return 24;
                case "twiceDaily": return 12;
                case "every8h": return 8;
                case "everyOtherDay": return 48;
                case "weekly": return 24 * 7;
                default: return 24;
            }
        }

        // Compute risk score (0 low, 100 high) for a medicine
        function computeMedicineRisk(med) {
            const now = new Date();
            const msInDay = 24 * 60 * 60 * 1000;

            // All logs for this medicine
            const logs = doseLogs.filter(l => l.medicineId === med.id);

            // 1) Miss rate (over all logs) ‚Äî missing entries with status 'missed'
            const totalLogged = logs.length;
            const missedCount = logs.filter(l => l.status === 'missed').length;
            const missRate = totalLogged > 0 ? (missedCount / totalLogged) : 0;

            // 2) Recent misses: count misses in last 14 days
            const daysWindow = 14;
            const cutoffRecent = new Date(now.getTime() - daysWindow * msInDay);
            const recentMisses = logs.filter(l => new Date(l.takenAt) >= cutoffRecent && l.status === 'missed').length;

            // 3) Recency of last taken (long gap increases risk)
            const lastTaken = logs.filter(l => l.status === 'taken').sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt))[0];
            let hoursSinceLastTaken = Infinity;
            if (lastTaken) {
                hoursSinceLastTaken = (now - new Date(lastTaken.takenAt)) / (1000 * 60 * 60);
            }

            // 4) Time-of-day miss concentration: if many misses at same scheduled time window
            // Build map of missed minutes (HH:MM)
            const missTimeBuckets = {};
            logs.filter(l => l.status === 'missed').forEach(l => {
                const d = new Date(l.takenAt);
                const key = d.getHours() + ':' + d.getMinutes();
                missTimeBuckets[key] = (missTimeBuckets[key] || 0) + 1;
            });
            const missTimeMax = Object.keys(missTimeBuckets).length ? Math.max(...Object.values(missTimeBuckets)) : 0;

            // 5) Expected number of doses scheduled since creation (rough heuristic)
            // We'll approximate expected = duration (days) * (24 / freqHours)
            let expected = 0;
            if (med.createdAt && med.duration) {
                try {
                    const created = new Date(med.createdAt);
                    const elapsedDays = Math.max(1, Math.floor((now - created) / msInDay));
                    const freqHours = frequencyToHours(med.frequency || "onceDaily");
                    expected = Math.round(elapsedDays * (24 / freqHours));
                } catch (e) {
                    expected = 0;
                }
            }

            // 6) Missed relative to expected
            const missedRelative = expected > 0 ? Math.min(1, missedCount / expected) : missRate;

            // Build weighted risk:
            // - recent misses (last 14d): weight 0.35
            // - miss rate overall: weight 0.25
            // - missedRelative: weight 0.15
            // - hours since last taken (longer gap): weight 0.15 (scaled)
            // - time-of-day concentration: weight 0.10 (more concentrated => actionable)
            const recentScore = Math.min(1, recentMisses / Math.max(1, daysWindow / Math.max(1, frequencyToHours(med.frequency || 'onceDaily') / 24)));
            const hoursScale = Math.min(1, hoursSinceLastTaken / (frequencyToHours(med.frequency || 'onceDaily') * 2 + 1)); // if >2x freq, risk
            const timeConcentration = Math.min(1, missTimeMax / Math.max(1, Math.ceil(totalLogged * 0.3)));

            let risk = (
                recentScore * 0.35 +
                missRate * 0.25 +
                missedRelative * 0.15 +
                hoursScale * 0.15 +
                timeConcentration * 0.10
            );

            // scale 0..100 and clamp
            risk = Math.round(Math.min(1, risk) * 100);

            // Build reasons for transparency
            const reasons = [];
            if (recentMisses > 0) reasons.push(`${recentMisses} miss${recentMisses > 1 ? 'es' : ''} in last ${daysWindow}d`);
            if (missRate > 0.1) reasons.push(`overall miss rate ${(missRate * 100).toFixed(0)}%`);
            if (hoursSinceLastTaken !== Infinity && hoursSinceLastTaken > frequencyToHours(med.frequency || 'onceDaily') * 1.5) reasons.push(`last taken ${Math.round(hoursSinceLastTaken)}h ago`);
            if (timeConcentration > 0.5) reasons.push('misses cluster at same time of day');

            const suggestionParts = [];
            if (risk >= 75) suggestionParts.push('Consider extra reminders and review schedule');
            else if (risk >= 50) suggestionParts.push('Snooze and repeat reminders; check routine');
            else suggestionParts.push('Keep the good routine');

            return {
                medicineId: med.id,
                name: med.name,
                risk,
                reasons: reasons.length ? reasons : ['no significant issues'],
                suggestion: suggestionParts.join('; ')
            };
        }

        // Analyze all medicines and render panel
        function analyzeAdherencePatterns() {
            const panel = document.getElementById('predictionPanel');
            if (!panel) return;

            if (!medicines || medicines.length === 0) {
                panel.innerHTML = `<p style="color:#e6d3a3;">No medicines to analyze.</p>`;
                return;
            }

            const results = medicines.map(med => computeMedicineRisk(med));
            // Sort by risk desc
            results.sort((a, b) => b.risk - a.risk);

            // Build HTML
            const rows = results.map(r => {
                const color =
                    r.risk >= 75 ? '#eb4d4b' :
                        r.risk >= 50 ? '#f0932b' :
                            r.risk >= 25 ? '#f9ca24' : '#4ecdc4';
                return `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px dashed rgba(255,255,255,0.03);">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#ffb347;">${r.name}</div>
                    <div style="color:#e6d3a3; font-size:0.9rem;">${r.reasons.join(' ¬∑ ')}</div>
                </div>
                <div style="width:140px; text-align:right;">
                    <div style="font-weight:bold; color:${color}; font-size:1.2rem;">${r.risk}%</div>
                    <div style="font-size:0.85rem; color:#e6d3a3;">${r.suggestion}</div>
                </div>
            </div>
        `;
            }).join('');

            panel.innerHTML = `
        <div style="border-radius:8px; overflow:hidden; background:linear-gradient(90deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25));">
            ${rows}
        </div>
        <div style="margin-top:10px; color:#e6d3a3; font-size:0.9rem;">
            Proactive suggestions are heuristic-based. For persistent high risk, consider adjusting schedule or enabling extra reminders.
        </div>
    `;

            // Optionally notify if any very high risk
            const high = results.find(r => r.risk >= 85);
            if (high) {
                showNotification(`‚ö†Ô∏è High risk detected for ${high.name} (${high.risk}%). Consider reviewing schedule.`, 7000);
            }
        }

        // Hook analyzer: ensure updateDashboard calls it
        // Add this call in updateDashboard() if not present:
        // analyzeAdherencePatterns();
        // The next lines add a safe guard to call it if updateDashboard exists:
        try {
            // if updateDashboard is defined, wrap call by injecting into pipeline
            const _origUpdate = updateDashboard;
            updateDashboard = function () {
                _origUpdate();
                analyzeAdherencePatterns();
            };
        } catch (e) {
            // fallback if updateDashboard not present at load time
        }

        function calculateStreak() {
            // 1Ô∏è‚É£ Get all unique dates from dose logs
            const dates = {};
            doseLogs.forEach(log => {
                const date = new Date(log.takenAt).toDateString();
                if (!dates[date]) dates[date] = { taken: 0, missed: 0, total: 0 };
                if (log.status === 'taken') dates[date].taken++;
                if (log.status === 'missed') dates[date].missed++;
                dates[date].total++;
            });

            // 2Ô∏è‚É£ Check streak backwards from yesterday
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            while (true) {
                const dayKey = currentDate.toDateString();

                // If no logs for this day, stop streak
                if (!dates[dayKey]) break;

                // If any dose was missed, stop streak
                if (dates[dayKey].missed > 0 || dates[dayKey].taken < dates[dayKey].total) break;

                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            }

            return streak;
        }
        function updateStreakDisplay() {
            const streakDays = calculateStreak();
            const streakElement = document.getElementById('streakCounter');

            if (streakDays === 0) {
                streakElement.textContent = "üî• Current Streak: 0 days üòî (start taking doses consistently!)";
            } else {
                streakElement.textContent = `üî• Current Streak: ${streakDays} day${streakDays > 1 ? 's' : ''} üèÜ`;
            }
        }


        // Sync calendar (placeholder)
        function syncCalendar() {
            showNotification('üåô Connected to celestial calendar! Enhanced predictions activated.');
            setTimeout(() => {
                generateRandomCrierAnnouncement();
            }, 2000);
        }

        // Auto-refresh announcements every 5 minutes
        setInterval(generateRandomCrierAnnouncement, 300000);
        // üîÑ Check for due medicines every 60 seconds
        setInterval(checkDueMedicines, 60000);

    </script>
</body>

</html>